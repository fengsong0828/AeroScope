<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å¤®æ§åˆ¶å° | AeroScope Admin</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* --- åå°ä¸“ç”¨æ ·å¼ --- */
        body { background-color: #f1f5f9; min-height: 100vh; display: flex; flex-direction: column; }
        
        /* å¸ƒå±€æ¡†æ¶ */
        .admin-layout { 
            display: grid; grid-template-columns: 260px 1fr; 
            max-width: 1600px; width: 100%; margin: 0 auto; 
            min-height: calc(100vh - 64px); /* å‡å» Header */
        }

        /* å·¦ä¾§å¯¼èˆª */
        .admin-sidebar { 
            background: #0f172a; color: #e2e8f0; padding: 20px; 
            display: flex; flex-direction: column; 
        }
        .sidebar-group { margin-bottom: 25px; }
        .group-label { 
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; 
            color: #64748b; margin-bottom: 10px; padding-left: 10px; font-weight: 700;
        }
        .nav-item { 
            display: flex; align-items: center; gap: 10px; padding: 12px 15px; 
            cursor: pointer; border-radius: 8px; transition: 0.2s; color: #94a3b8; font-weight: 500;
        }
        .nav-item:hover, .nav-item.active { background: #1e293b; color: white; }
        .nav-item.active { border-left: 3px solid #3b82f6; }

        /* å³ä¾§å†…å®¹ */
        .admin-main { padding: 30px; overflow-y: auto; }
        
        /* ä»ªè¡¨ç›˜å¡ç‰‡ */
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .stat-num { font-size: 2rem; font-weight: 700; color: #0f172a; }
        .stat-desc { color: #64748b; font-size: 0.9rem; }

        /* è¡¨æ ¼åŒºåŸŸ */
        .content-card { background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .card-header { 
            padding: 20px; border-bottom: 1px solid #f1f5f9; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .card-title { font-size: 1.1rem; font-weight: 700; color: #1e293b; }
        
        .data-table { width: 100%; border-collapse: collapse; }
        /* ä¿®æ”¹è¡¨å¤´æ ·å¼ä»¥é€‚åº”ä¸¤è¡Œæ˜¾ç¤ºï¼ˆå­—æ®µå+ç±»å‹ï¼‰ */
        .data-table th { 
            text-align: left; padding: 10px 20px; background: #f8fafc; color: #1e293b; 
            font-size: 0.85rem; font-weight: 700; border-bottom: 1px solid #e2e8f0; 
            white-space: nowrap; vertical-align: top;
        }
        .data-table td { 
            padding: 15px 20px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; 
            color: #334155; vertical-align: middle; max-width: 300px; 
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap; 
        }
        .data-table tr:hover { background: #f8fafc; }

        /* ç±»å‹æ ‡ç­¾æ ·å¼ */
        .type-tag {
            display: block; font-size: 0.7rem; font-weight: normal; margin-top: 4px;
            padding: 1px 6px; border-radius: 4px; width: fit-content;
            font-family: monospace; letter-spacing: -0.5px;
        }

        /* çŠ¶æ€å¾½ç«  */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
        .badge-draft { background: #fef9c3; color: #b45309; }
        .badge-pub { background: #dcfce7; color: #15803d; }
        .badge-blue { background: #dbeafe; color: #1e40af; }

        /* æŒ‰é’® */
        .btn-xs { padding: 4px 8px; font-size: 0.8rem; border-radius: 4px; border: 1px solid #e2e8f0; background: white; cursor: pointer; margin-right: 5px; }
        .btn-xs:hover { border-color: #3b82f6; color: #3b82f6; }
        .btn-primary-sm { background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }

        /* å¼¹çª—è¡¨å• */
        .modal-form { max-height: 70vh; overflow-y: auto; padding-right: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; }
        .form-control:focus { border-color: #3b82f6; outline: none; }
    </style>
</head>
<body>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header style="background:white; border-bottom:1px solid #e2e8f0; height:64px; display:flex; align-items:center; padding:0 20px; justify-content:space-between;">
        <div style="font-weight:800; font-size:1.2rem; color:#0f172a;">AeroScope <span style="color:#3b82f6;">Console</span></div>
        <div style="display:flex; gap:15px; align-items:center; font-size:0.9rem;">
            <span id="admin-email">Checking...</span>
            <a href="index.html" style="color:#64748b; text-decoration:none;">è¿”å›å‰å°</a>
            <button onclick="logout()" style="color:#ef4444; background:none; border:none; cursor:pointer;">é€€å‡º</button>
        </div>
    </header>

    <div class="admin-layout">
        <!-- å·¦ä¾§èœå• -->
        <aside class="admin-sidebar">
            <div class="sidebar-group">
                <div class="group-label">Dashboards</div>
                <div class="nav-item active" onclick="switchTab('dashboard', this)">ğŸ“Š æ¦‚è§ˆ (Overview)</div>
                <div class="nav-item" onclick="switchTab('raw_db_viewer', this)">ğŸ—„ï¸ å…¨åº“é€è§† (Raw DB)</div>
                <a href="admin-ai.html" class="nav-item" style="text-decoration:none;">ğŸ¤– AI é‡‡ç¼–åŠ©æ‰‹</a>
            </div>
            
            <div class="sidebar-group">
                <div class="group-label">Content (å†…å®¹ç®¡ç†)</div>
                <div class="nav-item" onclick="switchTab('news', this)">ğŸ“° èµ„è®¯ (News)</div>
                <div class="nav-item" onclick="switchTab('policies', this)">ğŸ“œ æ”¿ç­– (Policy)</div>
                <div class="nav-item" onclick="switchTab('tech_trends', this)">ğŸš€ æŠ€æœ¯ (Tech)</div>
                <div class="nav-item" onclick="switchTab('deep_reports', this)">ğŸ“‘ ç ”æŠ¥ (Reports)</div>
            </div>

            <div class="sidebar-group">
                <div class="group-label">Database (æ ¸å¿ƒåº“)</div>
                <div class="nav-item" onclick="switchTab('companies', this)">ğŸ¢ å…¬å¸ (Companies)</div>
                <div class="nav-item" onclick="switchTab('products', this)">âœˆï¸ äº§å“ (Products)</div>
                <div class="nav-item" onclick="switchTab('investors', this)">ğŸ¦ æŠ•èµ„æ–¹ (Investors)</div>
                <div class="nav-item" onclick="switchTab('funding_events', this)">ğŸ’° èèµ„äº‹ä»¶ (Funding)</div>
                <div class="nav-item" onclick="switchTab('patents', this)">ğŸ’¡ ä¸“åˆ©åº“ (Patents)</div>
            </div>

            <div class="sidebar-group">
                <div class="group-label">Business (å•†ä¸šåŒ–)</div>
                <div class="nav-item" onclick="switchTab('cooperation_leads', this)">ğŸ¤ å•†åŠ¡çº¿ç´¢ (Leads)</div>
                <div class="nav-item" onclick="switchTab('media_requests', this)">ğŸ¤ åª’ä½“ç”³è¯· (PR)</div>
                <div class="nav-item" onclick="switchTab('profiles', this)">ğŸ‘¥ ç”¨æˆ·ç®¡ç† (Users)</div>
            </div>
        </aside>

        <!-- å³ä¾§ä¸»åŒºåŸŸ -->
        <main class="admin-main" id="main-container">
            <!-- åŠ¨æ€æ¸²æŸ“åŒºåŸŸ -->
            <div style="text-align:center; padding:50px;">åŠ è½½ä¸­...</div>
        </main>
    </div>

    <!-- é€šç”¨ç¼–è¾‘/æ–°å¢å¼¹çª— -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal-box">
            <div class="modal-close" onclick="closeModal()">Ã—</div>
            <div class="modal-title" id="modal-title">ç¼–è¾‘</div>
            <div id="modal-form-body" class="modal-form"></div>
            <div style="margin-top:20px; text-align:right; border-top:1px solid #f1f5f9; padding-top:15px;">
                <button class="btn btn-outline" onclick="closeModal()" style="margin-right:10px;">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveData()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // â˜…â˜…â˜… é…ç½®åŒºåŸŸ â˜…â˜…â˜…
        const supabaseUrl = 'https://ulfktuvatxyakrdrwxfq.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVsZmt0dXZhdHh5YWtyZHJ3eGZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NDYyMjksImV4cCI6MjA4MDIyMjIyOX0.SBvHgp9HK_Lr5vXCgwu4Ae-Q6hH4dhMx3JSRbLiU0fU';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // æ•°æ®åº“æ‰€æœ‰è¡¨ååˆ—è¡¨ï¼ˆç”¨äºä¸‹æ‹‰é€‰æ‹©ï¼‰
        const ALL_DB_TABLES = [
            'news', 'policies', 'tech_trends', 'deep_reports', // Content
            'companies', 'products', 'investors', 'funding_events', 'patents', // DB
            'cooperation_leads', 'media_requests', 'profiles' // Business
        ];

        // å…¨å±€çŠ¶æ€
        let currentTable = 'dashboard';
        let currentEditId = null;
        let tableSchema = {}; 
        
        // â˜…â˜…â˜… æ–°å¢ï¼šæœ¬åœ°æ•°æ®ç¼“å­˜ï¼Œç”¨äºæœç´¢è¿‡æ»¤ â˜…â˜…â˜…
        let rawDataCache = []; 

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAdmin();
            loadDashboard();
        });

        // 1. æƒé™æ£€æŸ¥
        async function checkAdmin() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) return location.href = 'login.html';
            
            const { data: profile } = await _supabase.from('profiles').select('is_admin, username, email').eq('id', session.user.id).single();
            if (!profile || !profile.is_admin) {
                alert('æ— æƒè®¿é—®');
                return location.href = 'index.html';
            }
            document.getElementById('admin-email').innerText = profile.username || profile.email;
        }

        // 2. è·¯ç”±åˆ‡æ¢
        function switchTab(tab, el) {
            currentTable = tab;
            // UI update
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');

            if (tab === 'dashboard') loadDashboard();
            else if (tab === 'raw_db_viewer') loadRawDBViewer(); 
            else loadTableData(tab);
        }

        // 3. åŠ è½½ä»ªè¡¨ç›˜
        async function loadDashboard() {
            const container = document.getElementById('main-container');
            const [leads, users, news, companies] = await Promise.all([
                _supabase.from('cooperation_leads').select('id', { count: 'exact' }),
                _supabase.from('profiles').select('id', { count: 'exact' }),
                _supabase.from('news').select('id', { count: 'exact' }),
                _supabase.from('companies').select('id', { count: 'exact' })
            ]);

            container.innerHTML = `
                <h2 style="margin-bottom:20px;">è¿è¥æ¦‚è§ˆ</h2>
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-desc">æ€»ç”¨æˆ·æ•°</div>
                        <div class="stat-num">${users.count || 0}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-desc">å¾…å¤„ç†çº¿ç´¢</div>
                        <div class="stat-num" style="color:#d97706;">${leads.count || 0}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-desc">æ”¶å½•ä¼ä¸š</div>
                        <div class="stat-num">${companies.count || 0}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-desc">èµ„è®¯æ–‡ç« </div>
                        <div class="stat-num">${news.count || 0}</div>
                    </div>
                </div>
                <div class="content-card" style="padding:40px; text-align:center; color:#64748b;">
                    <h3>æ¬¢è¿å›åˆ° AeroScope ä¸­å¤®æ§åˆ¶å°</h3>
                    <p>è¯·ä»å·¦ä¾§èœå•é€‰æ‹©è¦ç®¡ç†çš„æ¨¡å—ã€‚</p>
                </div>
            `;
        }

        // å…¨åº“é€è§†ä¸»ç•Œé¢
        async function loadRawDBViewer() {
            const container = document.getElementById('main-container');
            const options = ALL_DB_TABLES.map(t => `<option value="${t}">${t}</option>`).join('');

            // â˜…â˜…â˜… åœ¨ä¸‹æ‹‰æ¡†æ—è¾¹å¢åŠ äº†æœç´¢è¾“å…¥æ¡† â˜…â˜…â˜…
            container.innerHTML = `
                <div class="content-card">
                    <div class="card-header" style="background:#f8fafc;">
                        <div style="display:flex; align-items:center; gap:15px;">
                            <div class="card-title">ğŸ—„ï¸ æ•°æ®åº“åŸå§‹è®°å½•é€è§†</div>
                            <select id="raw-db-selector" class="form-control" style="width:200px;" onchange="fetchAndRenderRawTable(this.value)">
                                <option value="" disabled selected>é€‰æ‹©æ•°æ®åº“è¡¨...</option>
                                ${options}
                            </select>
                            <input type="text" id="raw-db-search" class="form-control" style="width:200px;" placeholder="ğŸ” æœç´¢å½“å‰è¡¨å†…å®¹..." onkeyup="filterRawTable()">
                        </div>
                        <div style="font-size:0.85rem; color:#64748b;">
                            æ˜¾ç¤ºæ‰€æœ‰å­—æ®µåŠç±»å‹ (Audit Mode)
                        </div>
                    </div>
                    <div id="raw-table-container" style="overflow-x:auto; min-height:300px; padding:20px;">
                        <p style="text-align:center; color:#94a3b8; margin-top:50px;">è¯·ä»ä¸Šæ–¹ä¸‹æ‹‰æ¡†é€‰æ‹©ä¸€ä¸ªæ•°æ®è¡¨ä»¥æŸ¥çœ‹è¯¦æƒ…ã€‚</p>
                    </div>
                </div>
            `;
        }

        // â˜…â˜…â˜… ç¬¬ä¸€æ­¥ï¼šä»æ•°æ®åº“æ‹‰å–æ•°æ®å¹¶å­˜å…¥ç¼“å­˜ â˜…â˜…â˜…
        async function fetchAndRenderRawTable(tableName) {
            const container = document.getElementById('raw-table-container');
            
            // é‡ç½®æœç´¢æ¡†
            const searchInput = document.getElementById('raw-db-search');
            if(searchInput) searchInput.value = '';

            container.innerHTML = '<div style="text-align:center; color:#64748b;">æ­£åœ¨åˆ†ææ•°æ®åº“ç»“æ„...</div>';

            const { data, error } = await _supabase.from(tableName).select('*').limit(30).order('created_at', {ascending: false});

            if (error) {
                container.innerHTML = `<div style="color:red; text-align:center;">è¯»å–å¤±è´¥: ${error.message}</div>`;
                return;
            }

            if (!data || data.length === 0) {
                container.innerHTML = `<div style="text-align:center; color:#94a3b8;">è¯¥è¡¨ä¸ºç©º (0 records)</div>`;
                rawDataCache = [];
                return;
            }

            // å­˜å…¥å…¨å±€ç¼“å­˜ï¼Œä»¥ä¾¿æœç´¢æ—¶ä½¿ç”¨
            rawDataCache = data;
            
            // è°ƒç”¨è¿‡æ»¤æ¸²æŸ“å‡½æ•°ï¼ˆåˆå§‹çŠ¶æ€æ˜¾ç¤ºæ‰€æœ‰æ•°æ®ï¼‰
            filterRawTable();
        }

        // â˜…â˜…â˜… ç¬¬äºŒæ­¥ï¼šæœ¬åœ°æœç´¢è¿‡æ»¤å¹¶æ¸²æŸ“è¡¨æ ¼ â˜…â˜…â˜…
        function filterRawTable() {
            const container = document.getElementById('raw-table-container');
            const searchInput = document.getElementById('raw-db-search');
            const keyword = searchInput ? searchInput.value.toLowerCase().trim() : '';

            if (!rawDataCache || rawDataCache.length === 0) {
                return;
            }

            // 1. è·å–æ‰€æœ‰å­—æ®µ Key (åŸºäºç¼“å­˜ä¸­çš„ç¬¬ä¸€æ¡æ•°æ®ï¼Œå‡è®¾ç»“æ„ä¸€è‡´)
            const allKeys = Object.keys(rawDataCache[0]);

            // 2. æ™ºèƒ½ç±»å‹æ¨æ–­ (åŸºäºå®Œæ•´ç¼“å­˜æ¨æ–­ï¼Œä¿è¯è¡¨å¤´é¢œè‰²å‡†ç¡®ï¼Œå³ä½¿è¿‡æ»¤ååªå‰©ä¸€è¡Œ)
            const getColumnType = (key) => {
                for (let i = 0; i < rawDataCache.length; i++) {
                    const val = rawDataCache[i][key];
                    if (val !== null && val !== undefined) {
                        if (Array.isArray(val)) return 'array';
                        if (typeof val === 'object') return 'json'; 
                        if (typeof val === 'boolean') return 'bool';
                        if (typeof val === 'number') return 'num';
                        if (typeof val === 'string' && val.length === 36 && val.split('-').length === 5) return 'uuid';
                        if (typeof val === 'string' && /^\d{4}-\d{2}-\d{2}/.test(val)) return 'date';
                        return 'text';
                    }
                }
                return 'null'; 
            };

            // 3. ç”Ÿæˆè¡¨å¤´ (å¸¦ç±»å‹æ ‡ç­¾)
            let thHtml = `<th>#</th>`;
            allKeys.forEach(key => {
                const type = getColumnType(key);
                let color = '#64748b'; // default gray
                let bg = '#e2e8f0';

                // é¢œè‰²åŒºåˆ†é€»è¾‘
                if(type === 'num') { color = '#0369a1'; bg = '#e0f2fe'; } // Blue
                if(type === 'bool') { color = '#15803d'; bg = '#dcfce7'; } // Green
                if(type === 'json' || type === 'array') { color = '#b45309'; bg = '#fef3c7'; } // Orange
                if(type === 'date') { color = '#7e22ce'; bg = '#f3e8ff'; } // Purple
                if(type === 'uuid') { color = '#475569'; bg = '#f1f5f9'; fontStyle='italic'; } // Grey

                thHtml += `
                    <th>
                        <div style="font-size:0.9rem;">${key}</div>
                        <span class="type-tag" style="background:${bg}; color:${color};">${type}</span>
                    </th>`;
            });

            // 4. æ‰§è¡Œæœç´¢è¿‡æ»¤
            const filteredData = rawDataCache.filter(item => {
                if (!keyword) return true;
                // åªè¦è¯¥è¡Œæœ‰ä»»ä½•ä¸€ä¸ªå­—æ®µçš„å€¼åŒ…å«å…³é”®è¯ï¼Œå³ä¿ç•™
                return Object.values(item).some(val => 
                    String(val).toLowerCase().includes(keyword)
                );
            });

            if (filteredData.length === 0) {
                container.innerHTML = `
                    <table class="data-table">
                        <thead><tr>${thHtml}</tr></thead>
                        <tbody>
                            <tr><td colspan="${allKeys.length + 1}" style="text-align:center; padding:20px; color:#94a3b8;">
                                æ²¡æœ‰æ‰¾åˆ°åŒ¹é… "${keyword}" çš„è®°å½•
                            </td></tr>
                        </tbody>
                    </table>`;
                return;
            }

            // 5. ç”Ÿæˆå†…å®¹è¡Œ
            let trHtml = '';
            filteredData.forEach((item, index) => {
                let tds = `<td>${index + 1}</td>`;
                
                allKeys.forEach(key => {
                    let val = item[key];
                    
                    if (val === null || val === undefined) {
                        val = '<span style="color:#cbd5e1;">null</span>';
                    } else if (typeof val === 'object') {
                        val = `<span title='${JSON.stringify(val)}' style="color:#b45309; font-family:monospace; cursor:help;">{...}</span>`;
                    } else if (typeof val === 'boolean') {
                        val = val ? '<span style="color:green">true</span>' : '<span style="color:red">false</span>';
                    } else if (String(val).length > 40) {
                        val = `<span title="${val}">${String(val).substring(0, 40)}...</span>`;
                    }
                    
                    tds += `<td>${val}</td>`;
                });
                trHtml += `<tr>${tds}</tr>`;
            });

            container.innerHTML = `
                <table class="data-table">
                    <thead><tr>${thHtml}</tr></thead>
                    <tbody>${trHtml}</tbody>
                </table>
                <p style="margin-top:10px; font-size:0.8rem; color:#94a3b8;">
                    * æ˜¾ç¤º ${filteredData.length} æ¡è®°å½• (æ€»è½½å…¥ ${rawDataCache.length} æ¡)ã€‚
                </p>
            `;
        }

        // 4. å¸¸è§„è¡¨æ ¼åŠ è½½ (Admin View)
        async function loadTableData(tableName) {
            const container = document.getElementById('main-container');
            container.innerHTML = '<div style="text-align:center; padding:50px;">åŠ è½½æ•°æ®ä¸­...</div>';

            const schema = getTableSchema(tableName);
            tableSchema = schema;

            const { data, error } = await _supabase
                .from(tableName)
                .select('*')
                .order('created_at', { ascending: false })
                .limit(50);

            if (error) return container.innerHTML = `åŠ è½½å¤±è´¥: ${error.message}`;

            let thHtml = '';
            schema.listFields.forEach(f => thHtml += `<th>${f.label}</th>`);
            thHtml += `<th style="width:150px;">æ“ä½œ</th>`;

            let trHtml = '';
            data.forEach(item => {
                let tds = '';
                schema.listFields.forEach(f => {
                    let val = item[f.key];
                    if (f.type === 'boolean') val = val ? `<span class="badge badge-pub">Yes</span>` : `<span class="badge badge-draft">No</span>`;
                    if (f.key === 'status') val = `<span class="badge badge-blue">${val}</span>`;
                    if (f.type === 'date' && val) val = new Date(val).toLocaleDateString();
                    if (val === null || val === undefined) val = '-';
                    if (typeof val === 'string' && val.length > 30 && !val.includes('<span')) val = val.substring(0, 30) + '...';
                    tds += `<td>${val}</td>`;
                });

                const btns = `
                    <button class="btn-xs" onclick='openEditModal(${JSON.stringify(item).replace(/'/g, "&#39;")})'>ç¼–è¾‘</button>
                    <button class="btn-xs" style="color:#ef4444; border-color:#ef4444;" onclick="deleteItem('${tableName}', '${item.id}')">åˆ é™¤</button>
                `;
                trHtml += `<tr>${tds}<td>${btns}</td></tr>`;
            });

            container.innerHTML = `
                <div class="content-card">
                    <div class="card-header">
                        <div class="card-title">${schema.title} ç®¡ç†</div>
                        <button class="btn-primary-sm" onclick="openCreateModal()">+ æ–°å¢è®°å½•</button>
                    </div>
                    <div style="overflow-x:auto;">
                        <table class="data-table">
                            <thead><tr>${thHtml}</tr></thead>
                            <tbody>${trHtml}</tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // 5. å¼¹çª—é€»è¾‘
        function openEditModal(item) {
            currentEditId = item.id;
            document.getElementById('modal-title').innerText = `ç¼–è¾‘ ${tableSchema.title}`;
            renderForm(item);
            document.getElementById('edit-modal').style.display = 'flex';
        }

        function openCreateModal() {
            currentEditId = null;
            document.getElementById('modal-title').innerText = `æ–°å¢ ${tableSchema.title}`;
            renderForm({});
            document.getElementById('edit-modal').style.display = 'flex';
        }

        function renderForm(data) {
            const formBox = document.getElementById('modal-form-body');
            let html = '';

            tableSchema.editFields.forEach(f => {
                let val = data[f.key] !== undefined ? data[f.key] : '';
                
                html += `<div class="form-group"><label class="form-label">${f.label}</label>`;
                
                if (f.type === 'text') {
                    html += `<input type="text" id="f-${f.key}" class="form-control" value="${val}">`;
                } else if (f.type === 'textarea') {
                    html += `<textarea id="f-${f.key}" class="form-control" rows="4">${val}</textarea>`;
                } else if (f.type === 'select') {
                    let opts = f.options.map(o => `<option value="${o}" ${val===o?'selected':''}>${o}</option>`).join('');
                    html += `<select id="f-${f.key}" class="form-control">${opts}</select>`;
                } else if (f.type === 'boolean') {
                    html += `
                        <select id="f-${f.key}" class="form-control">
                            <option value="true" ${val===true?'selected':''}>æ˜¯ (True)</option>
                            <option value="false" ${val!==true?'selected':''}>å¦ (False)</option>
                        </select>`;
                } else if (f.type === 'json') {
                    let jsonStr = val ? JSON.stringify(val, null, 2) : '{}';
                    html += `<textarea id="f-${f.key}" class="form-control" rows="5" style="font-family:monospace;">${jsonStr}</textarea>`;
                } else if (f.type === 'date') {
                    html += `<input type="date" id="f-${f.key}" class="form-control" value="${val}">`;
                }
                
                html += `</div>`;
            });
            formBox.innerHTML = html;
        }

        // 6. ä¿å­˜é€»è¾‘
        async function saveData() {
            const payload = {};
            try {
                tableSchema.editFields.forEach(f => {
                    const el = document.getElementById(`f-${f.key}`);
                    let val = el.value;
                    if (f.type === 'boolean') val = (val === 'true');
                    if (f.type === 'json') val = JSON.parse(val); 
                    if (f.type === 'array') val = val.split(',').map(s=>s.trim());
                    payload[f.key] = val;
                });
            } catch (e) {
                alert('è¡¨å•æ ¼å¼é”™è¯¯: ' + e.message);
                return;
            }
            let error;
            if (currentEditId) {
                const res = await _supabase.from(currentTable).update(payload).eq('id', currentEditId);
                error = res.error;
            } else {
                const res = await _supabase.from(currentTable).insert(payload);
                error = res.error;
            }
            if (error) alert('ä¿å­˜å¤±è´¥: ' + error.message);
            else {
                closeModal();
                loadTableData(currentTable);
            }
        }

        async function deleteItem(table, id) {
            if(!confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) return;
            const { error } = await _supabase.from(table).delete().eq('id', id);
            if(error) alert('åˆ é™¤å¤±è´¥');
            else loadTableData(table);
        }

        function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }
        async function logout() { await _supabase.auth.signOut(); location.href='index.html'; }

        // Schema å®šä¹‰
        function getTableSchema(tableName) {
            const schemas = {
                'news': {
                    title: 'èµ„è®¯å¿«æŠ¥',
                    listFields: [{key:'title',label:'æ ‡é¢˜',type:'text'}, {key:'category',label:'åˆ†ç±»',type:'text'}, {key:'publish_date',label:'æ—¥æœŸ',type:'date'}, {key:'draft',label:'è‰ç¨¿',type:'boolean'}],
                    editFields: [{key:'title',label:'æ ‡é¢˜',type:'text'}, {key:'category',label:'åˆ†ç±»',type:'select',options:['Market','Policy','Capital','Global']}, {key:'summary',label:'æ‘˜è¦',type:'textarea'}, {key:'content',label:'æ­£æ–‡ (Markdown)',type:'textarea'}, {key:'image_url',label:'å°é¢å›¾ URL',type:'text'}, {key:'source',label:'æ¥æº',type:'text'}, {key:'publish_date',label:'å‘å¸ƒæ—¥æœŸ',type:'date'}, {key:'draft',label:'æ˜¯å¦è‰ç¨¿',type:'boolean'}]
                },
                'policies': {
                    title: 'æ”¿ç­–æ³•è§„',
                    listFields: [{key:'title',label:'æ”¿ç­–åç§°',type:'text'}, {key:'department',label:'éƒ¨é—¨',type:'text'}, {key:'level',label:'å±‚çº§',type:'text'}, {key:'draft',label:'çŠ¶æ€',type:'boolean'}],
                    editFields: [{key:'title',label:'æ ‡é¢˜',type:'text'}, {key:'department',label:'å‘æ–‡éƒ¨é—¨',type:'text'}, {key:'level',label:'å±‚çº§',type:'select',options:['å›½å®¶éƒ¨å§”','åœ°æ–¹æ”¿åºœ','å›½é™…ç»„ç»‡']}, {key:'summary',label:'è§£è¯»æ‘˜è¦',type:'textarea'}, {key:'content',label:'æ­£æ–‡/å…¨æ–‡',type:'textarea'}, {key:'related_city',label:'å…³è”åŸå¸‚',type:'text'}, {key:'draft',label:'è‰ç¨¿',type:'boolean'}]
                },
                'tech_trends': {
                    title: 'æŠ€æœ¯å‰æ²¿',
                    listFields: [{key:'title',label:'æ ‡é¢˜',type:'text'}, {key:'type',label:'ç±»å‹',type:'text'}, {key:'org',label:'æœºæ„',type:'text'}, {key:'draft',label:'çŠ¶æ€',type:'boolean'}],
                    editFields: [{key:'title',label:'æ ‡é¢˜',type:'text'}, {key:'type',label:'ç±»å‹',type:'select',options:['Patent','Paper','Product']}, {key:'domain',label:'é¢†åŸŸ',type:'select',options:['åŠ¨åŠ›ç”µæ± ','é£æ§','å¤æ']}, {key:'summary',label:'æ‘˜è¦',type:'textarea'}, {key:'org',label:'ç ”å‘æœºæ„',type:'text'}, {key:'draft',label:'è‰ç¨¿',type:'boolean'}]
                },
                'companies': {
                    title: 'å…¬å¸åº“',
                    listFields: [{key:'name',label:'åç§°',type:'text'}, {key:'industry_chain',label:'äº§ä¸šé“¾',type:'text'}, {key:'total_funding_est_usd',label:'èèµ„(USD)',type:'text'}, {key:'is_listed',label:'ä¸Šå¸‚',type:'boolean'}],
                    editFields: [{key:'name',label:'å…¬å¸å',type:'text'}, {key:'country_code',label:'å›½å®¶ä»£ç (CN/US)',type:'text'}, {key:'industry_chain',label:'äº§ä¸šé“¾',type:'select',options:['upstream','midstream','downstream']}, {key:'primary_category',label:'èµ›é“',type:'select',options:['eVTOL','Drone','Battery']}, {key:'description',label:'ç®€ä»‹',type:'textarea'}, {key:'total_funding_est_usd',label:'ç´¯è®¡èèµ„(æ•°å­—)',type:'text'}, {key:'is_listed',label:'æ˜¯å¦ä¸Šå¸‚',type:'boolean'}, {key:'draft',label:'è‰ç¨¿',type:'boolean'}]
                },
                'products': {
                    title: 'é£è¡Œå™¨äº§å“',
                    listFields: [{key:'name',label:'å‹å·',type:'text'}, {key:'type',label:'ç±»å‹',type:'text'}, {key:'certification_status',label:'çŠ¶æ€',type:'text'}],
                    editFields: [{key:'name',label:'å‹å·åç§°',type:'text'}, {key:'type',label:'ç±»å‹',type:'select',options:['Multicopter','Lift+Cruise','Vectored']}, {key:'company_id',label:'æ‰€å±å…¬å¸ID',type:'text'}, {key:'specs',label:'æ€§èƒ½å‚æ•° (JSON)',type:'json'}, {key:'certification_status',label:'å–è¯çŠ¶æ€',type:'select',options:['Concept','Prototype','Testing','Certified']}, {key:'draft',label:'è‰ç¨¿',type:'boolean'}]
                },
                'cooperation_leads': {
                    title: 'å•†åŠ¡çº¿ç´¢ (B2B)',
                    listFields: [{key:'contact_name',label:'è”ç³»äºº',type:'text'}, {key:'company_name',label:'å…¬å¸',type:'text'}, {key:'service_type',label:'æ„å‘',type:'text'}, {key:'status',label:'çŠ¶æ€',type:'text'}],
                    editFields: [{key:'status',label:'å¤„ç†çŠ¶æ€',type:'select',options:['pending','contacted','closed']}, {key:'contact_name',label:'å§“å',type:'text'}, {key:'message',label:'éœ€æ±‚è¯¦æƒ…',type:'textarea'}]
                },
                'media_requests': {
                    title: 'åª’ä½“ç”³è¯·',
                    listFields: [{key:'organization',label:'æœºæ„',type:'text'}, {key:'request_type',label:'ç±»å‹',type:'text'}, {key:'status',label:'çŠ¶æ€',type:'text'}],
                    editFields: [{key:'status',label:'å®¡æ ¸çŠ¶æ€',type:'select',options:['pending','approved','rejected']}, {key:'material_link',label:'èµ„æ–™é“¾æ¥',type:'text'}]
                },
                'profiles': {
                    title: 'ç”¨æˆ·ç®¡ç†',
                    listFields: [{key:'username',label:'ç”¨æˆ·å',type:'text'}, {key:'email',label:'é‚®ç®±',type:'text'}, {key:'is_expert',label:'ä¸“å®¶',type:'boolean'}, {key:'tier',label:'ç­‰çº§',type:'text'}],
                    editFields: [{key:'username',label:'ç”¨æˆ·å',type:'text'}, {key:'is_expert',label:'è®¤è¯ä¸“å®¶',type:'boolean'}, {key:'industry_role',label:'ä¸“å®¶å¤´è¡”',type:'text'}, {key:'tier',label:'ä¼šå‘˜ç­‰çº§',type:'select',options:['free','pro','enterprise']}, {key:'is_admin',label:'ç®¡ç†å‘˜æƒé™ (æ…ç”¨)',type:'boolean'}]
                }
            };
            return schemas[tableName] || schemas['news'];
        }
    </script>
</body>
</html>