<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å¤®æ§åˆ¶å° | AeroScope Admin</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* --- æ ·å¼ (ä¿æŒåŸæ ·) --- */
        body { background-color: #f1f5f9; min-height: 100vh; display: flex; flex-direction: column; margin: 0; }
        
        /* å¤´éƒ¨æ ·å¼ */
        header {
            background: white; border-bottom: 1px solid #e2e8f0; height: 64px; width: 100%;
            display: flex; justify-content: center; z-index: 50;
        }
        .header-inner {
            width: 100%; max-width: 1600px; display: flex; align-items: center;
            justify-content: space-between; padding: 0 20px; box-sizing: border-box;
        }
        .header-logo { font-weight: 800; font-size: 1.2rem; color: #0f172a; }
        .header-user-area { display: flex; gap: 12px; align-items: center; font-size: 0.9rem; }
        .header-btn {
            text-decoration: none; padding: 8px 16px; border-radius: 6px;
            font-size: 0.85rem; font-weight: 600; transition: all 0.2s; cursor: pointer;
            display: inline-flex; align-items: center; gap: 6px; border: 1px solid transparent;
        }
        .btn-ghost { color: #64748b; background-color: #f1f5f9; }
        .btn-ghost:hover { color: #3b82f6; background-color: #e2e8f0; }
        .btn-danger-light { color: #ef4444; background-color: #fef2f2; border-color: #fee2e2; }
        .btn-danger-light:hover { background-color: #fee2e2; border-color: #fca5a5; }

        /* å¸ƒå±€ */
        .admin-layout { 
            display: grid; grid-template-columns: 260px 1fr; 
            max-width: 1600px; width: 100%; margin: 0 auto; 
            min-height: calc(100vh - 64px); 
        }
        .admin-sidebar { background: #0f172a; color: #e2e8f0; padding: 20px; display: flex; flex-direction: column; }
        .sidebar-group { margin-bottom: 25px; }
        .group-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #64748b; margin-bottom: 10px; padding-left: 10px; font-weight: 700; }
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 12px 15px; cursor: pointer; border-radius: 8px; transition: 0.2s; color: #94a3b8; font-weight: 500; }
        .nav-item:hover, .nav-item.active { background: #1e293b; color: white; }
        .nav-item.active { border-left: 3px solid #3b82f6; }
        .admin-main { padding: 30px; overflow-y: auto; }
        
        /* ä»ªè¡¨ç›˜ç»Ÿè®¡å¡ç‰‡ */
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .stat-num { font-size: 2rem; font-weight: 700; color: #0f172a; }
        .stat-desc { color: #64748b; font-size: 0.9rem; }
        
        /* å†…å®¹åˆ—è¡¨å¡ç‰‡ */
        .content-card { background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .card-header { padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .card-title { font-size: 1.1rem; font-weight: 700; color: #1e293b; }
        
        /* è¡¨æ ¼æ ·å¼ */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { text-align: left; padding: 12px 20px; background: #f8fafc; color: #475569; font-size: 0.85rem; font-weight: 700; border-bottom: 1px solid #e2e8f0; white-space: nowrap; }
        .data-table td { padding: 15px 20px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; color: #334155; vertical-align: middle; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .data-table tr:hover { background: #f8fafc; }
        
        /* å¾½ç« ä¸æŒ‰é’® */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; display:inline-block; }
        .badge-draft { background: #fef9c3; color: #b45309; }
        .badge-pub { background: #dcfce7; color: #15803d; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        
        .btn-xs { padding: 4px 8px; font-size: 0.8rem; border-radius: 4px; border: 1px solid #e2e8f0; background: white; cursor: pointer; margin-right: 5px; color:#475569; }
        .btn-xs:hover { border-color: #3b82f6; color: #3b82f6; }
        .btn-primary-sm { background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight:600; }
        .btn-primary-sm:hover { background: #2563eb; }

        /* å¼¹çª—è¡¨å• */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 800px; max-height: 85vh; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
        .modal-body { padding: 30px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 20px; border-top: 1px solid #e2e8f0; text-align: right; background: #f8fafc; }
        
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: #334155; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95rem; box-sizing: border-box; }
        .form-control:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .form-hint { font-size: 0.8rem; color: #64748b; margin-top: 5px; }

        /* å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ç®€åŒ–ç‰ˆ */
        .editor-wrapper { border: 1px solid #cbd5e1; border-radius: 6px; overflow: hidden; }
        .rich-content-area { border: none; width: 100%; padding: 15px; outline: none; font-size: 1rem; line-height: 1.6; resize: vertical; min-height: 200px; font-family: inherit; }
        
        /* å“åº”å¼ */
        @media (max-width: 1024px) {
            .admin-layout { grid-template-columns: 80px 1fr; }
            .nav-item span { display: none; }
            .group-label { display: none; }
            .admin-sidebar { align-items: center; padding: 20px 5px; }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-inner">
            <div class="header-logo">
                AeroScope <span style="color:#3b82f6;">Console</span>
            </div>
            <div class="header-user-area">
                <span id="admin-email" style="color:#64748b; font-weight:500;">Checking...</span>
                <a href="index.html" class="header-btn btn-ghost">ğŸ  è¿”å›å‰å°</a>
                <button onclick="logout()" class="header-btn btn-danger-light">ğŸšª é€€å‡º</button>
            </div>
        </div>
    </header>

    <div class="admin-layout">
        <!-- å·¦ä¾§èœå• (å®Œå…¨ä¿æŒåŸæ ·) -->
        <aside class="admin-sidebar">
            <div class="sidebar-group">
                <div class="group-label">Dashboards</div>
                <div class="nav-item active" onclick="switchTab('dashboard', this)"><span>ğŸ“Š æ¦‚è§ˆ (Overview)</span></div>
                <div class="nav-item" onclick="switchTab('raw_db_viewer', this)"><span>ğŸ—„ï¸ å…¨åº“é€è§† (Raw DB)</span></div>
                <a href="admin-ai.html" class="nav-item" style="text-decoration:none;"><span>ğŸ¤– AI é‡‡ç¼–åŠ©æ‰‹</span></a>
            </div>
            
            <div class="sidebar-group">
                <div class="group-label">Content (å†…å®¹ç®¡ç†)</div>
                <div class="nav-item" onclick="switchTab('news', this)"><span>ğŸ“° èµ„è®¯ (News)</span></div>
                <div class="nav-item" onclick="switchTab('policies', this)"><span>ğŸ“œ æ”¿ç­– (Policy)</span></div>
                <div class="nav-item" onclick="switchTab('tech_trends', this)"><span>ğŸš€ æŠ€æœ¯ (Tech)</span></div>
                <div class="nav-item" onclick="switchTab('deep_reports', this)"><span>ğŸ“‘ ç ”æŠ¥ (Reports)</span></div>
            </div>

            <div class="sidebar-group">
                <div class="group-label">Database (æ ¸å¿ƒåº“)</div>
                <div class="nav-item" onclick="switchTab('companies', this)"><span>ğŸ¢ å…¬å¸ (Companies)</span></div>
                <div class="nav-item" onclick="switchTab('products', this)"><span>âœˆï¸ äº§å“ (Products)</span></div>
                <div class="nav-item" onclick="switchTab('investors', this)"><span>ğŸ¦ æŠ•èµ„æ–¹ (Investors)</span></div>
                <div class="nav-item" onclick="switchTab('funding_events', this)"><span>ğŸ’° èèµ„äº‹ä»¶ (Funding)</span></div>
                <div class="nav-item" onclick="switchTab('patents', this)"><span>ğŸ’¡ ä¸“åˆ©åº“ (Patents)</span></div>
            </div>

            <div class="sidebar-group">
                <div class="group-label">Business (å•†ä¸šåŒ–)</div>
                <div class="nav-item" onclick="switchTab('cooperation_leads', this)"><span>ğŸ¤ å•†åŠ¡çº¿ç´¢ (Leads)</span></div>
                <div class="nav-item" onclick="switchTab('media_requests', this)"><span>ğŸ¤ åª’ä½“ç”³è¯· (PR)</span></div>
                <div class="nav-item" onclick="switchTab('profiles', this)"><span>ğŸ‘¥ ç”¨æˆ·ç®¡ç† (Users)</span></div>
            </div>
        </aside>

        <!-- å³ä¾§ä¸»åŒºåŸŸ -->
        <main class="admin-main" id="main-container">
            <div style="text-align:center; padding:50px;">åŠ è½½ä¸­...</div>
        </main>
    </div>

    <!-- é€šç”¨ç¼–è¾‘/æ–°å¢å¼¹çª— -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal-box">
            <div class="modal-header">
                <div class="card-title" id="modal-title">ç¼–è¾‘</div>
                <button onclick="closeModal()" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">Ã—</button>
            </div>
            <div id="modal-form-body" class="modal-body">
                <!-- åŠ¨æ€è¡¨å•å°†æ¸²æŸ“åœ¨è¿™é‡Œ -->
            </div>
            <div class="modal-footer">
                <button class="btn-xs" style="padding:10px 20px; margin-right:10px;" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn-primary-sm" onclick="saveData()">ä¿å­˜æ›´æ”¹</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://ulfktuvatxyakrdrwxfq.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVsZmt0dXZhdHh5YWtyZHJ3eGZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NDYyMjksImV4cCI6MjA4MDIyMjIyOX0.SBvHgp9HK_Lr5vXCgwu4Ae-Q6hH4dhMx3JSRbLiU0fU';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        const ALL_DB_TABLES = ['news', 'policies', 'tech_trends', 'deep_reports', 'companies', 'products', 'investors', 'funding_events', 'patents', 'cooperation_leads', 'media_requests', 'profiles'];
        let currentTable = 'dashboard';
        let currentEditId = null;
        let tableSchema = {}; 
        let rawDataCache = [];

        document.addEventListener('DOMContentLoaded', async () => {
            await checkAdmin();
            loadDashboard();
        });

        // 1. æƒé™æ£€æŸ¥
        async function checkAdmin() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) return location.href = 'login.html';
            
            const { data: profile } = await _supabase.from('profiles').select('is_admin, username, email').eq('id', session.user.id).single();
            if (!profile || !profile.is_admin) { 
                alert('æ— æƒè®¿é—®'); 
                return location.href = 'index.html'; 
            }
            document.getElementById('admin-email').innerText = profile.username || profile.email;
        }

        // 2. åˆ‡æ¢ Tab
        function switchTab(tab, el) {
            currentTable = tab;
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');
            
            if (tab === 'dashboard') loadDashboard();
            else if (tab === 'raw_db_viewer') loadRawDBViewer(); // å‡è®¾ä½ æœ‰è¿™ä¸ªå‡½æ•°ï¼Œæ²¡æœ‰çš„è¯å¯å¿½ç•¥
            else loadTableData(tab);
        }

        // 3. ä»ªè¡¨ç›˜
        async function loadDashboard() {
            const container = document.getElementById('main-container');
            const [leads, users, companies, patents] = await Promise.all([
                _supabase.from('cooperation_leads').select('id', { count: 'exact', head: true }),
                _supabase.from('profiles').select('id', { count: 'exact', head: true }),
                _supabase.from('companies').select('id', { count: 'exact', head: true }),
                _supabase.from('patents').select('id', { count: 'exact', head: true })
            ]);
            
            container.innerHTML = `
                <h2 style="margin-bottom:20px;">æ•°æ®æ¦‚è§ˆ</h2>
                <div class="stats-row">
                    <div class="stat-card"><div class="stat-desc">æ”¶å½•ä¼ä¸š</div><div class="stat-num">${companies.count || 0}</div></div>
                    <div class="stat-card"><div class="stat-desc">æŠ€æœ¯ä¸“åˆ©</div><div class="stat-num">${patents.count || 0}</div></div>
                    <div class="stat-card"><div class="stat-desc">æ³¨å†Œç”¨æˆ·</div><div class="stat-num">${users.count || 0}</div></div>
                    <div class="stat-card"><div class="stat-desc" style="color:#d97706;">å¾…å¤„ç†çº¿ç´¢</div><div class="stat-num" style="color:#d97706;">${leads.count || 0}</div></div>
                </div>
                <div class="content-card" style="padding:40px; text-align:center; color:#64748b;">
                    <h3>æ¬¢è¿ä½¿ç”¨ AeroScope ä¸­å¤®æ§åˆ¶å°</h3>
                    <p>è¯·ä»å·¦ä¾§èœå•é€‰æ‹©å¯¹åº”çš„æ•°æ®è¡¨è¿›è¡Œç®¡ç†ã€‚</p>
                    <p style="font-size:0.85rem; margin-top:10px;">ğŸ’¡ æç¤ºï¼šåœ¨æ·»åŠ ä¸“åˆ©æˆ–èèµ„ä¿¡æ¯æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å…³è”å·²å­˜åœ¨çš„å…¬å¸ï¼Œæˆ–è‡ªåŠ¨åˆ›å»ºæ–°å…¬å¸ã€‚</p>
                </div>`;
        }

        // 4. åŠ è½½è¡¨æ ¼æ•°æ®
        async function loadTableData(tableName) {
            const container = document.getElementById('main-container');
            container.innerHTML = '<div style="text-align:center; padding:50px;">åŠ è½½æ•°æ®ä¸­...</div>';
            
            const schema = getTableSchema(tableName);
            tableSchema = schema;
            
            const { data, error } = await _supabase.from(tableName).select('*').order('created_at', { ascending: false }).limit(50);
            
            if (error) return container.innerHTML = `<div style="color:red;">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            
            let thHtml = '';
            schema.listFields.forEach(f => thHtml += `<th>${f.label}</th>`);
            thHtml += `<th style="width:180px;">æ“ä½œ</th>`;

            let trHtml = '';
            data.forEach(item => {
                let tds = '';
                schema.listFields.forEach(f => {
                    let val = item[f.key];
                    // ç‰¹æ®Šå­—æ®µæ¸²æŸ“
                    if (f.type === 'boolean') {
                        if (f.key === 'draft') val = val ? `<span class="badge badge-draft">è‰ç¨¿</span>` : `<span class="badge badge-pub">å·²å‘å¸ƒ</span>`;
                        else val = val ? 'æ˜¯' : 'å¦';
                    }
                    if (f.type === 'date' && val) val = new Date(val).toLocaleDateString();
                    if (f.type === 'array' && Array.isArray(val)) val = val.join(', ');
                    if (f.type === 'number' && val) val = Number(val).toLocaleString(); // æ•°å­—æ ¼å¼åŒ–
                    if (val === null || val === undefined) val = '-';
                    if (typeof val === 'string' && val.length > 30) val = val.substring(0, 30) + '...';
                    
                    tds += `<td>${val}</td>`;
                });

                const itemStr = JSON.stringify(item).replace(/'/g, "&#39;");
                const btns = `
                    <button class="btn-xs" onclick='openEditModal(${itemStr})'>ç¼–è¾‘</button>
                    <button class="btn-xs" style="color:#ef4444; border-color:#ef4444;" onclick="deleteItem('${tableName}', '${item.id}')">åˆ é™¤</button>
                `;
                trHtml += `<tr>${tds}<td>${btns}</td></tr>`;
            });

            container.innerHTML = `
                <div class="content-card">
                    <div class="card-header">
                        <div class="card-title">${schema.title} ç®¡ç†</div>
                        <button class="btn-primary-sm" onclick="openCreateModal()">+ æ–°å¢è®°å½•</button>
                    </div>
                    <div style="overflow-x:auto;">
                        <table class="data-table">
                            <thead><tr>${thHtml}</tr></thead>
                            <tbody>${trHtml || '<tr><td colspan="10" style="text-align:center; padding:20px;">æš‚æ— æ•°æ®</td></tr>'}</tbody>
                        </table>
                    </div>
                </div>`;
        }

        // 5. æ‰“å¼€è¡¨å• (ç¼–è¾‘/æ–°å¢)
        function openEditModal(item) {
            currentEditId = item.id;
            document.getElementById('modal-title').innerText = `ç¼–è¾‘ ${tableSchema.title}`;
            renderForm(item);
            document.getElementById('edit-modal').style.display = 'flex';
        }

        function openCreateModal() {
            currentEditId = null;
            document.getElementById('modal-title').innerText = `æ–°å¢ ${tableSchema.title}`;
            renderForm({});
            document.getElementById('edit-modal').style.display = 'flex';
        }

        // 6. æ¸²æŸ“è¡¨å•å­—æ®µ (ä¼˜åŒ–ç‰ˆ)
        function renderForm(data) {
            const formBox = document.getElementById('modal-form-body');
            let html = '';
            
            tableSchema.editFields.forEach(f => {
                let val = data[f.key] !== undefined ? data[f.key] : '';
                
                // --- æç¤ºä¿¡æ¯ (Auto-Link) ---
                let hint = '';
                if (f.key === 'applicant' && currentTable === 'patents') hint = '<div class="form-hint">âœ¨ è¾“å…¥å…¬å¸åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å…³è”æˆ–åˆ›å»ºæ–°å…¬å¸</div>';
                if (f.key === 'company_name' && currentTable === 'funding_events') hint = '<div class="form-hint">âœ¨ è¾“å…¥å…¬å¸åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å…³è”æˆ–åˆ›å»ºæ–°å…¬å¸</div>';

                // --- å­—æ®µæ¸²æŸ“ ---
                html += `<div class="form-group"><label class="form-label">${f.label}</label>`;
                
                if (f.type === 'array') {
                    // æ•°ç»„è½¬å­—ç¬¦ä¸²æ˜¾ç¤º
                    const displayVal = Array.isArray(val) ? val.join(', ') : (val || '');
                    html += `<input type="text" id="f-${f.key}" class="form-control" value="${displayVal}" placeholder="å¤šé¡¹è¯·ç”¨é€—å·åˆ†éš”">`;
                }
                else if (f.type === 'json' || f.key === 'specs') {
                    // JSON æ ¼å¼åŒ–
                    const jsonStr = val ? JSON.stringify(val, null, 2) : '{}';
                    html += `<textarea id="f-${f.key}" class="form-control" rows="6" style="font-family:monospace; font-size:0.85rem;">${jsonStr}</textarea>`;
                }
                else if (f.key === 'content' || (f.type === 'textarea' && f.label.includes('æ­£æ–‡'))) {
                    html += `<div class="editor-wrapper"><textarea id="f-${f.key}" class="rich-content-area">${val}</textarea></div>`;
                } 
                else if (f.type === 'boolean') {
                    html += `
                        <select id="f-${f.key}" class="form-control">
                            <option value="true" ${val===true?'selected':''}>æ˜¯ (True)</option>
                            <option value="false" ${val!==true?'selected':''}>å¦ (False)</option>
                        </select>`;
                } 
                else if (f.type === 'select') {
                    let opts = f.options.map(o => `<option value="${o}" ${val===o?'selected':''}>${o}</option>`).join('');
                    html += `<select id="f-${f.key}" class="form-control">${opts}</select>`;
                }
                else if (f.type === 'textarea') {
                    html += `<textarea id="f-${f.key}" class="form-control" rows="4">${val}</textarea>`;
                }
                else if (f.type === 'date') {
                    html += `<input type="date" id="f-${f.key}" class="form-control" value="${val}">`;
                }
                else if (f.type === 'number') {
                    html += `<input type="number" id="f-${f.key}" class="form-control" value="${val}" step="0.01">`;
                }
                else {
                    html += `<input type="text" id="f-${f.key}" class="form-control" value="${val}">`;
                }
                
                html += `${hint}</div>`;
            });
            formBox.innerHTML = html;
        }

        // 7. ä¿å­˜æ•°æ® (å¼ºåŒ–ç‰ˆ)
        async function saveData() {
            const payload = {};
            try {
                tableSchema.editFields.forEach(f => {
                    const el = document.getElementById(`f-${f.key}`);
                    if(!el) return; // è·³è¿‡ä¸å­˜åœ¨çš„å­—æ®µ
                    
                    let val = el.value;

                    // ç±»å‹è½¬æ¢
                    if (f.type === 'boolean') val = (val === 'true');
                    
                    if (f.type === 'array') {
                        // å­—ç¬¦ä¸² -> æ•°ç»„
                        val = val ? val.split(/,|ï¼Œ/).map(s => s.trim()).filter(s => s) : [];
                    }
                    
                    if (f.type === 'json') {
                        try {
                            val = JSON.parse(val);
                        } catch (e) {
                            throw new Error(`å­—æ®µ [${f.label}] JSON æ ¼å¼é”™è¯¯`);
                        }
                    }
                    
                    if (f.type === 'number') val = val ? Number(val) : null;

                    payload[f.key] = val;
                });
            } catch (e) { 
                alert(e.message); 
                return; 
            }

            let error;
            if (currentEditId) {
                const res = await _supabase.from(currentTable).update(payload).eq('id', currentEditId);
                error = res.error;
            } else {
                const res = await _supabase.from(currentTable).insert(payload);
                error = res.error;
            }

            if (error) alert('ä¿å­˜å¤±è´¥: ' + error.message);
            else { closeModal(); loadTableData(currentTable); }
        }

        // 8. åˆ é™¤æ•°æ® (å¸¦å¤–é”®æ£€æŸ¥)
        async function deleteItem(table, id) {
            if(!confirm('âš ï¸ ç¡®å®šè¦å½»åº•åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;

            const { error } = await _supabase.from(table).delete().eq('id', id);

            if (error) {
                if (error.code === '23503') { // Postgres å¤–é”®çº¦æŸé”™è¯¯
                    alert('âŒ åˆ é™¤å¤±è´¥ï¼šè¯¥è®°å½•è¢«å…¶ä»–æ•°æ®å¼•ç”¨ï¼ˆå¦‚äº§å“ã€èèµ„ã€ä¸“åˆ©ï¼‰ã€‚\nè¯·å…ˆåˆ é™¤å…³è”æ•°æ®ã€‚');
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + error.message);
                }
            } else {
                loadTableData(table);
                if(table === 'companies') loadDashboard();
            }
        }

        function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }
        async function logout() { await _supabase.auth.signOut(); location.href='index.html'; }

        // =========================================
        // â˜…â˜…â˜… æ ¸å¿ƒé…ç½®ï¼šå„è¡¨ Schema å®šä¹‰ â˜…â˜…â˜…
        // =========================================
        function getTableSchema(tableName) {
            const schemas = {
                // 1. æŠ•èµ„æ–¹ (ç‹¬ç«‹é…ç½®)
                'investors': {
                    title: 'æŠ•èµ„æ–¹ (Investors)',
                    listFields: [{key:'name',label:'æœºæ„åç§°',type:'text'}, {key:'type',label:'ç±»å‹',type:'text'}, {key:'country',label:'åœ°åŒº',type:'text'}, {key:'total_amount',label:'æ€»æŠ•é‡‘é¢(USD)',type:'number'}],
                    editFields: [
                        {key:'name',label:'æœºæ„åç§°',type:'text'},
                        {key:'type',label:'ç±»å‹',type:'select',options:['VC','PE','CVC','Angel','Gov','Other']},
                        {key:'country',label:'å›½å®¶/åœ°åŒº',type:'text'},
                        {key:'website',label:'å®˜ç½‘ URL',type:'text'},
                        {key:'description',label:'ç®€ä»‹',type:'textarea'},
                        {key:'focus_areas',label:'å…³æ³¨é¢†åŸŸ (æ•°ç»„, é€—å·åˆ†éš”)',type:'array'},
                        {key:'investment_stages',label:'æŠ•èµ„è½®æ¬¡åå¥½ (æ•°ç»„, é€—å·åˆ†éš”)',type:'array'},
                        {key:'total_amount',label:'ç®¡ç†/æŠ•èµ„æ€»é¢ (Est. USD)',type:'number'},
                        {key:'draft',label:'è‰ç¨¿çŠ¶æ€',type:'boolean'}
                    ]
                },
                
                // 2. èèµ„äº‹ä»¶ (ç‹¬ç«‹é…ç½®)
                'funding_events': {
                    title: 'èèµ„äº‹ä»¶ (Funding)',
                    listFields: [{key:'funding_date',label:'æ—¥æœŸ',type:'date'}, {key:'company_name',label:'å…¬å¸',type:'text'}, {key:'funding_round',label:'è½®æ¬¡',type:'text'}, {key:'funding_amount',label:'é‡‘é¢(M)',type:'number'}],
                    editFields: [
                        {key:'company_name',label:'è·æŠ•å…¬å¸å (è¾“å…¥åè‡ªåŠ¨å…³è”/åˆ›å»º)',type:'text'},
                        {key:'funding_date',label:'èèµ„æ—¥æœŸ',type:'date'},
                        {key:'announcement_date',label:'å…¬å‘Šæ—¥æœŸ',type:'date'},
                        {key:'funding_round',label:'è½®æ¬¡',type:'select',options:['Seed','Angel','Pre-A','A','A+','B','C','D','IPO','Strategic','M&A']},
                        {key:'funding_amount',label:'é‡‘é¢ (ç™¾ä¸‡)',type:'number'},
                        {key:'funding_currency',label:'è´§å¸',type:'select',options:['USD','CNY','EUR','GBP']},
                        {key:'valuation',label:'æŠ•åä¼°å€¼ (ç™¾ä¸‡)',type:'number'},
                        {key:'lead_investor',label:'é¢†æŠ•æ–¹',type:'text'},
                        {key:'participating_investors',label:'è·ŸæŠ•æ–¹ (é€—å·åˆ†éš”)',type:'text'},
                        {key:'source_url',label:'æ–°é—»æ¥æº URL',type:'text'},
                        {key:'draft',label:'è‰ç¨¿çŠ¶æ€',type:'boolean'}
                    ]
                },

                // 3. ä¸“åˆ©åº“ (ç‹¬ç«‹é…ç½®)
                'patents': {
                    title: 'ä¸“åˆ©æŠ€æœ¯ (Patents)',
                    listFields: [{key:'title',label:'ä¸“åˆ©æ ‡é¢˜',type:'text'}, {key:'applicant',label:'ç”³è¯·äºº',type:'text'}, {key:'patent_type',label:'ç±»å‹',type:'text'}, {key:'legal_status',label:'çŠ¶æ€',type:'text'}],
                    editFields: [
                        {key:'title',label:'ä¸“åˆ©æ ‡é¢˜',type:'text'},
                        {key:'patent_number',label:'ä¸“åˆ©å·/ç”³è¯·å·',type:'text'},
                        {key:'applicant',label:'ç”³è¯·äºº (è¾“å…¥å…¬å¸åè‡ªåŠ¨å…³è”)',type:'text'},
                        {key:'patent_type',label:'ç±»å‹',type:'select',options:['Invention','Utility Model','Design']},
                        {key:'application_date',label:'ç”³è¯·æ—¥',type:'date'},
                        {key:'publication_date',label:'å…¬å¼€æ—¥',type:'date'},
                        {key:'legal_status',label:'æ³•å¾‹çŠ¶æ€',type:'select',options:['æœ‰æ•ˆ','å®¡ä¸­','æ— æ•ˆ','é©³å›','è¿‡æœŸ']},
                        {key:'abstract',label:'æ‘˜è¦',type:'textarea'},
                        {key:'technical_categories',label:'æŠ€æœ¯æ ‡ç­¾ (æ•°ç»„, é€—å·åˆ†éš”)',type:'array'},
                        {key:'industry_chain_position',label:'äº§ä¸šé“¾ä½ç½®',type:'select',options:['upstream','midstream','downstream']},
                        {key:'data_source',label:'æ•°æ®æ¥æº',type:'text'},
                        {key:'draft',label:'è‰ç¨¿çŠ¶æ€',type:'boolean'}
                    ]
                },

                // 4. å…¬å¸åº“ (ä¿ç•™ä¼˜åŒ–)
                'companies': {
                    title: 'å…¬å¸åº“ (Companies)',
                    listFields: [{key:'name',label:'åç§°',type:'text'}, {key:'industry_chain',label:'äº§ä¸šé“¾',type:'text'}, {key:'primary_category',label:'èµ›é“',type:'text'}, {key:'is_listed',label:'ä¸Šå¸‚',type:'boolean'}],
                    editFields: [
                        {key:'name',label:'å…¬å¸å',type:'text'}, 
                        {key:'name_en',label:'è‹±æ–‡å',type:'text'},
                        {key:'country_code',label:'å›½å®¶ä»£ç  (CN/US)',type:'text'}, 
                        {key:'industry_chain',label:'äº§ä¸šé“¾',type:'select',options:['upstream','midstream','downstream']}, 
                        {key:'primary_category',label:'èµ›é“',type:'select',options:['eVTOL','Drone','FlyingCar','Battery','Avionics','Service']}, 
                        {key:'description',label:'ç®€ä»‹',type:'textarea'}, 
                        {key:'tags',label:'æ ‡ç­¾ (æ•°ç»„, é€—å·åˆ†éš”)',type:'array'},
                        {key:'total_funding_est_usd',label:'ç´¯è®¡èèµ„ (M USD)',type:'number'}, 
                        {key:'is_listed',label:'æ˜¯å¦ä¸Šå¸‚',type:'boolean'}, 
                        {key:'ticker_symbol',label:'è‚¡ç¥¨ä»£ç ',type:'text'},
                        {key:'logo_url',label:'Logo URL',type:'text'},
                        {key:'website_url',label:'å®˜ç½‘',type:'text'},
                        {key:'draft',label:'è‰ç¨¿',type:'boolean'}
                    ]
                },

                // 5. äº§å“åº“
                'products': {
                    title: 'äº§å“ (Products)',
                    listFields: [{key:'name',label:'å‹å·',type:'text'}, {key:'type',label:'ç±»å‹',type:'text'}, {key:'certification_status',label:'çŠ¶æ€',type:'text'}],
                    editFields: [
                        {key:'name',label:'å‹å·åç§°',type:'text'}, 
                        {key:'type',label:'ç±»å‹',type:'select',options:['Multicopter','Lift+Cruise','Vectored Thrust','FlyingCar']}, 
                        {key:'company_id',label:'æ‰€å±å…¬å¸ID (æ‰‹åŠ¨å…³è”)',type:'number'}, 
                        {key:'manufacturer_name',label:'å‚å•†å (è‡ªåŠ¨å…³è”è¾…åŠ©)',type:'text'},
                        {key:'specs',label:'æ€§èƒ½å‚æ•° (JSON)',type:'json'}, 
                        {key:'image_url',label:'å›¾ç‰‡ URL',type:'text'},
                        {key:'certification_status',label:'å–è¯çŠ¶æ€',type:'select',options:['Concept','Prototype','Testing','Certified']}, 
                        {key:'draft',label:'è‰ç¨¿',type:'boolean'}
                    ]
                },

                // 6. èµ„è®¯ (News)
                'news': {
                    title: 'èµ„è®¯å¿«æŠ¥',
                    listFields: [{key:'title',label:'æ ‡é¢˜',type:'text'}, {key:'category',label:'åˆ†ç±»',type:'text'}, {key:'publish_date',label:'æ—¥æœŸ',type:'date'}],
                    editFields: [
                        {key:'title',label:'æ ‡é¢˜',type:'text'},
                        {key:'category',label:'åˆ†ç±»',type:'select',options:['Market','Policy','Capital','Global']},
                        {key:'summary',label:'æ‘˜è¦',type:'textarea'},
                        {key:'content',label:'æ­£æ–‡ (Markdown)',type:'textarea'},
                        {key:'image_url',label:'å°é¢å›¾ URL',type:'text'},
                        {key:'source',label:'æ¥æº',type:'text'},
                        {key:'publish_date',label:'å‘å¸ƒæ—¥æœŸ',type:'date'},
                        {key:'tags',label:'æ ‡ç­¾ (æ•°ç»„, é€—å·åˆ†éš”)',type:'array'},
                        {key:'draft',label:'æ˜¯å¦è‰ç¨¿',type:'boolean'}
                    ]
                },

                // 7. æ”¿ç­–
                'policies': {
                    title: 'æ”¿ç­–æ³•è§„',
                    listFields: [{key:'title',label:'æ ‡é¢˜',type:'text'}, {key:'department',label:'éƒ¨é—¨',type:'text'}, {key:'level',label:'å±‚çº§',type:'text'}],
                    editFields: [
                        {key:'title',label:'æ ‡é¢˜',type:'text'},
                        {key:'department',label:'å‘æ–‡éƒ¨é—¨',type:'text'},
                        {key:'level',label:'å±‚çº§',type:'select',options:['å›½å®¶éƒ¨å§”','åœ°æ–¹æ”¿åºœ','å›½é™…ç»„ç»‡','å›½å¤–/å›½é™…']},
                        {key:'summary',label:'è§£è¯»æ‘˜è¦',type:'textarea'},
                        {key:'content',label:'æ­£æ–‡/å…¨æ–‡',type:'textarea'},
                        {key:'file_url',label:'é™„ä»¶é“¾æ¥',type:'text'}, 
                        {key:'related_city',label:'å…³è”åŸå¸‚',type:'text'},
                        {key:'publish_date',label:'å‘å¸ƒæ—¥æœŸ',type:'date'},
                        {key:'draft',label:'è‰ç¨¿',type:'boolean'}
                    ]
                },
                
                // 8. ç ”æŠ¥
                'deep_reports': {
                    title: 'æ·±åº¦ç ”æŠ¥',
                    listFields: [{key:'title',label:'æ ‡é¢˜',type:'text'}, {key:'author',label:'ä½œè€…',type:'text'}, {key:'publish_date',label:'æ—¥æœŸ',type:'date'}],
                    editFields: [{key:'title',label:'æ ‡é¢˜',type:'text'}, {key:'author',label:'ä½œè€…',type:'text'}, {key:'summary',label:'æ‘˜è¦',type:'textarea'}, {key:'content',label:'æ­£æ–‡',type:'textarea'}, {key:'is_pro_only',label:'Proä¸“äº«',type:'boolean'}, {key:'draft',label:'è‰ç¨¿',type:'boolean'}]
                },

                // 9. æŠ€æœ¯å‰æ²¿
                'tech_trends': {
                    title: 'æŠ€æœ¯å‰æ²¿',
                    listFields: [{key:'title',label:'æ ‡é¢˜',type:'text'}, {key:'type',label:'ç±»å‹',type:'text'}, {key:'org',label:'æœºæ„',type:'text'}],
                    editFields: [{key:'title',label:'æ ‡é¢˜',type:'text'}, {key:'type',label:'ç±»å‹',type:'select',options:['Patent','Paper','Product']}, {key:'org',label:'æœºæ„',type:'text'}, {key:'summary',label:'æ‘˜è¦',type:'textarea'}, {key:'content',label:'å†…å®¹',type:'textarea'}, {key:'draft',label:'è‰ç¨¿',type:'boolean'}]
                },

                // 10. å•†åŠ¡çº¿ç´¢
                'cooperation_leads': {
                    title: 'å•†åŠ¡çº¿ç´¢',
                    listFields: [{key:'contact_name',label:'è”ç³»äºº',type:'text'}, {key:'company_name',label:'å…¬å¸',type:'text'}, {key:'status',label:'çŠ¶æ€',type:'text'}],
                    editFields: [{key:'status',label:'çŠ¶æ€',type:'select',options:['pending','contacted','closed']}, {key:'contact_name',label:'å§“å',type:'text'}, {key:'message',label:'ç•™è¨€',type:'textarea'}]
                },

                // 11. ç”¨æˆ·
                'profiles': {
                    title: 'ç”¨æˆ·ç®¡ç†',
                    listFields: [{key:'username',label:'ç”¨æˆ·å',type:'text'}, {key:'email',label:'é‚®ç®±',type:'text'}, {key:'tier',label:'ç­‰çº§',type:'text'}],
                    editFields: [{key:'username',label:'ç”¨æˆ·å',type:'text'}, {key:'is_expert',label:'ä¸“å®¶',type:'boolean'}, {key:'tier',label:'ç­‰çº§',type:'select',options:['free','pro','enterprise']}]
                }
            };
            
            // é»˜è®¤è¿”å› news ç»“æ„é˜²æ­¢æŠ¥é”™
            return schemas[tableName] || schemas['news'];
        }
    </script>
</body>
</html>