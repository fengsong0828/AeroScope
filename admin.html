<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å¤®æ§åˆ¶å° | AeroScope Admin</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* --- æ ·å¼ --- */
        body { background-color: #f1f5f9; min-height: 100vh; display: flex; flex-direction: column; margin: 0; }
        
        /* å¤´éƒ¨æ ·å¼ä¼˜åŒ– (ä¸ AI é¡µé¢ç»Ÿä¸€) */
        header {
            background: white; border-bottom: 1px solid #e2e8f0; height: 64px; width: 100%;
            display: flex; justify-content: center;
        }
        .header-inner {
            width: 100%; max-width: 1600px; display: flex; align-items: center;
            justify-content: space-between; padding: 0 20px; box-sizing: border-box;
        }
        .header-logo { font-weight: 800; font-size: 1.2rem; color: #0f172a; }
        .header-user-area { display: flex; gap: 12px; align-items: center; font-size: 0.9rem; }
        .header-btn {
            text-decoration: none; padding: 8px 16px; border-radius: 6px;
            font-size: 0.85rem; font-weight: 600; transition: all 0.2s; cursor: pointer;
            display: inline-flex; align-items: center; gap: 6px; border: 1px solid transparent;
        }
        .btn-ghost { color: #64748b; background-color: #f1f5f9; }
        .btn-ghost:hover { color: #3b82f6; background-color: #e2e8f0; }
        .btn-danger-light { color: #ef4444; background-color: #fef2f2; border-color: #fee2e2; }
        .btn-danger-light:hover { background-color: #fee2e2; border-color: #fca5a5; }

        /* å¸ƒå±€ */
        .admin-layout { 
            display: grid; grid-template-columns: 260px 1fr; 
            max-width: 1600px; width: 100%; margin: 0 auto; 
            min-height: calc(100vh - 64px); 
        }
        .admin-sidebar { background: #0f172a; color: #e2e8f0; padding: 20px; display: flex; flex-direction: column; }
        .sidebar-group { margin-bottom: 25px; }
        .group-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #64748b; margin-bottom: 10px; padding-left: 10px; font-weight: 700; }
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 12px 15px; cursor: pointer; border-radius: 8px; transition: 0.2s; color: #94a3b8; font-weight: 500; }
        .nav-item:hover, .nav-item.active { background: #1e293b; color: white; }
        .nav-item.active { border-left: 3px solid #3b82f6; }
        .admin-main { padding: 30px; overflow-y: auto; }
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .stat-num { font-size: 2rem; font-weight: 700; color: #0f172a; }
        .stat-desc { color: #64748b; font-size: 0.9rem; }
        .content-card { background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .card-header { padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 1.1rem; font-weight: 700; color: #1e293b; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { text-align: left; padding: 10px 20px; background: #f8fafc; color: #1e293b; font-size: 0.85rem; font-weight: 700; border-bottom: 1px solid #e2e8f0; white-space: nowrap; vertical-align: top; }
        .data-table td { padding: 15px 20px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; color: #334155; vertical-align: middle; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .data-table tr:hover { background: #f8fafc; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
        .badge-draft { background: #fef9c3; color: #b45309; }
        .badge-pub { background: #dcfce7; color: #15803d; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .type-tag { display: block; font-size: 0.7rem; font-weight: normal; margin-top: 4px; padding: 1px 6px; border-radius: 4px; width: fit-content; font-family: monospace; letter-spacing: -0.5px; }
        .btn-xs { padding: 4px 8px; font-size: 0.8rem; border-radius: 4px; border: 1px solid #e2e8f0; background: white; cursor: pointer; margin-right: 5px; }
        .btn-xs:hover { border-color: #3b82f6; color: #3b82f6; }
        .btn-primary-sm { background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
        .modal-form { max-height: 70vh; overflow-y: auto; padding-right: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; }
        .form-control:focus { border-color: #3b82f6; outline: none; }
        
        /* å¤ç”¨ç¼–è¾‘å™¨æ ·å¼ */
        .editor-wrapper { border: 1px solid #cbd5e1; border-radius: 8px; overflow: hidden; background: white; transition: 0.2s; }
        .editor-toolbar { background: #f8fafc; border-bottom: 1px solid #e2e8f0; padding: 8px 12px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .tool-btn { background: white; border: 1px solid #cbd5e1; border-radius: 4px; padding: 4px 10px; font-size: 0.8rem; color: #475569; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 5px; }
        .tool-btn:hover { border-color: #3b82f6; color: #3b82f6; background: #eff6ff; }
        .tool-separator { width: 1px; height: 16px; background: #cbd5e1; margin: 0 5px; }
        .rich-content-area { border: none; border-radius: 0; padding: 20px; outline: none; box-shadow: none; font-size: 16px; line-height: 1.8; width: 100%; resize: vertical; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; text-align: justify; white-space: pre-wrap; }
        .custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: none; justify-content: center; align-items: center; }
        .custom-modal-box { background: white; width: 500px; padding: 25px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: fadeIn 0.2s; }
        .modal-h { font-size: 1.1rem; font-weight: 700; color: #1e293b; margin-bottom: 20px; }
        .modal-btns { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    </style>
</head>
<body>

    <header>
        <div class="header-inner">
            <div class="header-logo">
                AeroScope <span style="color:#3b82f6;">Console</span>
            </div>
            <div class="header-user-area">
                <span id="admin-email" style="color:#64748b; font-weight:500;">Checking...</span>
                <a href="index.html" class="header-btn btn-ghost">
                    ğŸ  è¿”å›å‰å°
                </a>
                <button onclick="logout()" class="header-btn btn-danger-light">
                    ğŸšª é€€å‡º
                </button>
            </div>
        </div>
    </header>

    <div class="admin-layout">
        <!-- å·¦ä¾§èœå• -->
        <aside class="admin-sidebar">
            <div class="sidebar-group">
                <div class="group-label">Dashboards</div>
                <div class="nav-item active" onclick="switchTab('dashboard', this)">ğŸ“Š æ¦‚è§ˆ (Overview)</div>
                <div class="nav-item" onclick="switchTab('raw_db_viewer', this)">ğŸ—„ï¸ å…¨åº“é€è§† (Raw DB)</div>
                <a href="admin-ai.html" class="nav-item" style="text-decoration:none;">ğŸ¤– AI é‡‡ç¼–åŠ©æ‰‹</a>
            </div>
            
            <div class="sidebar-group">
                <div class="group-label">Content (å†…å®¹ç®¡ç†)</div>
                <div class="nav-item" onclick="switchTab('news', this)">ğŸ“° èµ„è®¯ (News)</div>
                <div class="nav-item" onclick="switchTab('policies', this)">ğŸ“œ æ”¿ç­– (Policy)</div>
                <div class="nav-item" onclick="switchTab('tech_trends', this)">ğŸš€ æŠ€æœ¯ (Tech)</div>
                <div class="nav-item" onclick="switchTab('deep_reports', this)">ğŸ“‘ ç ”æŠ¥ (Reports)</div>
            </div>

            <div class="sidebar-group">
                <div class="group-label">Database (æ ¸å¿ƒåº“)</div>
                <div class="nav-item" onclick="switchTab('companies', this)">ğŸ¢ å…¬å¸ (Companies)</div>
                <div class="nav-item" onclick="switchTab('products', this)">âœˆï¸ äº§å“ (Products)</div>
                <div class="nav-item" onclick="switchTab('investors', this)">ğŸ¦ æŠ•èµ„æ–¹ (Investors)</div>
                <div class="nav-item" onclick="switchTab('funding_events', this)">ğŸ’° èèµ„äº‹ä»¶ (Funding)</div>
                <div class="nav-item" onclick="switchTab('patents', this)">ğŸ’¡ ä¸“åˆ©åº“ (Patents)</div>
            </div>

            <div class="sidebar-group">
                <div class="group-label">Business (å•†ä¸šåŒ–)</div>
                <div class="nav-item" onclick="switchTab('cooperation_leads', this)">ğŸ¤ å•†åŠ¡çº¿ç´¢ (Leads)</div>
                <div class="nav-item" onclick="switchTab('media_requests', this)">ğŸ¤ åª’ä½“ç”³è¯· (PR)</div>
                <div class="nav-item" onclick="switchTab('profiles', this)">ğŸ‘¥ ç”¨æˆ·ç®¡ç† (Users)</div>
            </div>
        </aside>

        <!-- å³ä¾§ä¸»åŒºåŸŸ -->
        <main class="admin-main" id="main-container">
            <div style="text-align:center; padding:50px;">åŠ è½½ä¸­...</div>
        </main>
    </div>

    <!-- é€šç”¨ç¼–è¾‘/æ–°å¢å¼¹çª— -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal-box" style="max-width: 800px;">
            <div class="modal-close" onclick="closeModal()">Ã—</div>
            <div class="modal-title" id="modal-title">ç¼–è¾‘</div>
            <div id="modal-form-body" class="modal-form"></div>
            <div style="margin-top:20px; text-align:right; border-top:1px solid #f1f5f9; padding-top:15px;">
                <button class="btn btn-outline" onclick="closeModal()" style="margin-right:10px;">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveData()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡å¼¹çª— -->
    <div class="custom-modal-overlay" id="img-modal">
        <div class="custom-modal-box">
            <div class="modal-h">æ’å…¥å›¾ç‰‡</div>
            <div class="form-group">
                <label class="form-label">å›¾ç‰‡é“¾æ¥ (URL)</label>
                <input type="text" id="modal-img-url" class="form-control" placeholder="https://...">
            </div>
            <div class="form-group">
                <label class="form-label">å›¾ç‰‡è¯´æ˜ (Caption)</label>
                <input type="text" id="modal-img-alt" class="form-control" placeholder="å›¾ç‰‡æè¿°...">
            </div>
            <div class="modal-btns">
                <button class="btn-xs" style="padding:8px 15px;" onclick="closeImageModal()">å–æ¶ˆ</button>
                <button class="btn-primary-sm" onclick="confirmInsertImage()">æ’å…¥</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://ulfktuvatxyakrdrwxfq.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVsZmt0dXZhdHh5YWtyZHJ3eGZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NDYyMjksImV4cCI6MjA4MDIyMjIyOX0.SBvHgp9HK_Lr5vXCgwu4Ae-Q6hH4dhMx3JSRbLiU0fU';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        const ALL_DB_TABLES = ['news', 'policies', 'tech_trends', 'deep_reports', 'companies', 'products', 'investors', 'funding_events', 'patents', 'cooperation_leads', 'media_requests', 'profiles'];
        let currentTable = 'dashboard';
        let currentEditId = null;
        let tableSchema = {}; 
        let rawDataCache = []; 

        document.addEventListener('DOMContentLoaded', async () => {
            await checkAdmin();
            loadDashboard();
        });

        async function checkAdmin() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) return location.href = 'login.html';
            const { data: profile } = await _supabase.from('profiles').select('is_admin, username, email').eq('id', session.user.id).single();
            if (!profile || !profile.is_admin) { alert('æ— æƒè®¿é—®'); return location.href = 'index.html'; }
            document.getElementById('admin-email').innerText = profile.username || profile.email;
        }

        function switchTab(tab, el) {
            currentTable = tab;
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');
            if (tab === 'dashboard') loadDashboard();
            else if (tab === 'raw_db_viewer') loadRawDBViewer(); 
            else loadTableData(tab);
        }

        async function loadDashboard() {
            const container = document.getElementById('main-container');
            const [leads, users, news, companies] = await Promise.all([
                _supabase.from('cooperation_leads').select('id', { count: 'exact' }),
                _supabase.from('profiles').select('id', { count: 'exact' }),
                _supabase.from('news').select('id', { count: 'exact' }),
                _supabase.from('companies').select('id', { count: 'exact' })
            ]);
            container.innerHTML = `
                <h2 style="margin-bottom:20px;">è¿è¥æ¦‚è§ˆ</h2>
                <div class="stats-row">
                    <div class="stat-card"><div class="stat-desc">æ€»ç”¨æˆ·æ•°</div><div class="stat-num">${users.count || 0}</div></div>
                    <div class="stat-card"><div class="stat-desc">å¾…å¤„ç†çº¿ç´¢</div><div class="stat-num" style="color:#d97706;">${leads.count || 0}</div></div>
                    <div class="stat-card"><div class="stat-desc">æ”¶å½•ä¼ä¸š</div><div class="stat-num">${companies.count || 0}</div></div>
                    <div class="stat-card"><div class="stat-desc">èµ„è®¯æ–‡ç« </div><div class="stat-num">${news.count || 0}</div></div>
                </div>
                <div class="content-card" style="padding:40px; text-align:center; color:#64748b;"><h3>æ¬¢è¿å›åˆ° AeroScope ä¸­å¤®æ§åˆ¶å°</h3><p>è¯·ä»å·¦ä¾§èœå•é€‰æ‹©è¦ç®¡ç†çš„æ¨¡å—ã€‚</p></div>`;
        }

        async function loadRawDBViewer() {
            const container = document.getElementById('main-container');
            const options = ALL_DB_TABLES.map(t => `<option value="${t}">${t}</option>`).join('');
            container.innerHTML = `
                <div class="content-card">
                    <div class="card-header" style="background:#f8fafc;">
                        <div style="display:flex; align-items:center; gap:15px;">
                            <div class="card-title">ğŸ—„ï¸ æ•°æ®åº“åŸå§‹è®°å½•é€è§†</div>
                            <select id="raw-db-selector" class="form-control" style="width:200px;" onchange="fetchAndRenderRawTable(this.value)"><option value="" disabled selected>é€‰æ‹©æ•°æ®åº“è¡¨...</option>${options}</select>
                            <input type="text" id="raw-db-search" class="form-control" style="width:200px;" placeholder="ğŸ” æœç´¢å½“å‰è¡¨å†…å®¹..." onkeyup="filterRawTable()">
                        </div>
                        <div style="font-size:0.85rem; color:#64748b;">æ˜¾ç¤ºæ‰€æœ‰å­—æ®µåŠç±»å‹ (Audit Mode)</div>
                    </div>
                    <div id="raw-table-container" style="overflow-x:auto; min-height:300px; padding:20px;"><p style="text-align:center; color:#94a3b8; margin-top:50px;">è¯·ä»ä¸Šæ–¹ä¸‹æ‹‰æ¡†é€‰æ‹©ä¸€ä¸ªæ•°æ®è¡¨ä»¥æŸ¥çœ‹è¯¦æƒ…ã€‚</p></div>
                </div>`;
        }

        async function fetchAndRenderRawTable(tableName) {
            const container = document.getElementById('raw-table-container');
            container.innerHTML = '<div style="text-align:center; color:#64748b;">æ­£åœ¨åˆ†ææ•°æ®åº“ç»“æ„...</div>';
            const { data, error } = await _supabase.from(tableName).select('*').limit(30).order('created_at', {ascending: false});
            if (error) { container.innerHTML = `<div style="color:red; text-align:center;">è¯»å–å¤±è´¥: ${error.message}</div>`; return; }
            if (!data || data.length === 0) { container.innerHTML = `<div style="text-align:center; color:#94a3b8;">è¯¥è¡¨ä¸ºç©º (0 records)</div>`; rawDataCache = []; return; }
            rawDataCache = data;
            filterRawTable();
        }

        function filterRawTable() {
            const container = document.getElementById('raw-table-container');
            const keyword = document.getElementById('raw-db-search')?.value.toLowerCase().trim() || '';
            if (!rawDataCache || rawDataCache.length === 0) return;
            const allKeys = Object.keys(rawDataCache[0]);
            const getColumnType = (key) => {
                for (let i = 0; i < rawDataCache.length; i++) {
                    const val = rawDataCache[i][key];
                    if (val !== null && val !== undefined) {
                        if (Array.isArray(val)) return 'array';
                        if (typeof val === 'object') return 'json';
                        if (typeof val === 'boolean') return 'bool';
                        if (typeof val === 'number') return 'num';
                        if (typeof val === 'string' && val.length === 36 && val.split('-').length === 5) return 'uuid';
                        if (typeof val === 'string' && /^\d{4}-\d{2}-\d{2}/.test(val)) return 'date';
                        return 'text';
                    }
                }
                return 'null';
            };
            let thHtml = `<th>#</th>`;
            allKeys.forEach(key => {
                const type = getColumnType(key);
                let color = '#64748b'; let bg = '#e2e8f0';
                if(type === 'num') { color = '#0369a1'; bg = '#e0f2fe'; }
                if(type === 'bool') { color = '#15803d'; bg = '#dcfce7'; }
                if(type === 'json' || type === 'array') { color = '#b45309'; bg = '#fef3c7'; }
                if(type === 'date') { color = '#7e22ce'; bg = '#f3e8ff'; }
                thHtml += `<th><div style="font-size:0.9rem;">${key}</div><span class="type-tag" style="background:${bg}; color:${color};">${type}</span></th>`;
            });
            const filteredData = rawDataCache.filter(item => !keyword || Object.values(item).some(val => String(val).toLowerCase().includes(keyword)));
            let trHtml = '';
            filteredData.forEach((item, index) => {
                let tds = `<td>${index + 1}</td>`;
                allKeys.forEach(key => {
                    let val = item[key];
                    if (val === null || val === undefined) val = '<span style="color:#cbd5e1;">null</span>';
                    else if (typeof val === 'object') val = `<span title='${JSON.stringify(val)}' style="color:#b45309; font-family:monospace; cursor:help;">{...}</span>`;
                    else if (typeof val === 'boolean') val = val ? '<span style="color:green">true</span>' : '<span style="color:red">false</span>';
                    else if (String(val).length > 40) val = `<span title="${val}">${String(val).substring(0, 40)}...</span>`;
                    tds += `<td>${val}</td>`;
                });
                trHtml += `<tr>${tds}</tr>`;
            });
            container.innerHTML = `<table class="data-table"><thead><tr>${thHtml}</tr></thead><tbody>${trHtml}</tbody></table>`;
        }

        async function loadTableData(tableName) {
            const container = document.getElementById('main-container');
            container.innerHTML = '<div style="text-align:center; padding:50px;">åŠ è½½æ•°æ®ä¸­...</div>';
            const schema = getTableSchema(tableName);
            tableSchema = schema;
            const { data, error } = await _supabase.from(tableName).select('*').order('created_at', { ascending: false }).limit(50);
            if (error) return container.innerHTML = `åŠ è½½å¤±è´¥: ${error.message}`;
            
            let thHtml = '';
            schema.listFields.forEach(f => thHtml += `<th>${f.label}</th>`);
            thHtml += `<th style="width:220px;">æ“ä½œ</th>`;

            let trHtml = '';
            data.forEach(item => {
                let tds = '';
                schema.listFields.forEach(f => {
                    let val = item[f.key];
                    if (f.type === 'boolean') val = val ? `<span class="badge badge-pub">æœªå‘å¸ƒ</span>` : `<span class="badge badge-draft">å·²å‘å¸ƒ</span>`;
                    if (f.key === 'status') val = `<span class="badge badge-blue">${val}</span>`;
                    if (f.type === 'date' && val) val = new Date(val).toLocaleDateString();
                    if (val === null || val === undefined) val = '-';
                    if (typeof val === 'string' && val.length > 30 && !val.includes('<span')) val = val.substring(0, 30) + '...';
                    tds += `<td>${val}</td>`;
                });

                let publishBtn = '';
                if (item.draft === true) {
                    publishBtn = `<button class="btn-xs" style="color:#10b981; border-color:#10b981;" onclick="togglePublish('${tableName}', '${item.id}', true)">å‘å¸ƒ</button>`;
                } else if (item.draft === false) {
                    publishBtn = `<button class="btn-xs" style="color:#f59e0b; border-color:#f59e0b;" onclick="togglePublish('${tableName}', '${item.id}', false)">æ’¤é”€</button>`;
                }

                const itemStr = JSON.stringify(item).replace(/'/g, "&#39;");
                const btns = `
                    <button class="btn-xs" onclick='openEditModal(${itemStr})'>ç¼–è¾‘</button>
                    ${publishBtn}
                    <button class="btn-xs" style="color:#ef4444; border-color:#ef4444;" onclick="deleteItem('${tableName}', '${item.id}')">åˆ é™¤</button>
                `;
                trHtml += `<tr>${tds}<td>${btns}</td></tr>`;
            });
            container.innerHTML = `<div class="content-card"><div class="card-header"><div class="card-title">${schema.title} ç®¡ç†</div><button class="btn-primary-sm" onclick="openCreateModal()">+ æ–°å¢è®°å½•</button></div><div style="overflow-x:auto;"><table class="data-table"><thead><tr>${thHtml}</tr></thead><tbody>${trHtml}</tbody></table></div></div>`;
        }

        async function togglePublish(table, id, isDraft) {
            const newDraftStatus = !isDraft;
            const { error } = await _supabase.from(table).update({ draft: newDraftStatus }).eq('id', id);
            if (error) alert('æ“ä½œå¤±è´¥: ' + error.message);
            else loadTableData(table);
        }

        function openEditModal(item) {
            currentEditId = item.id;
            document.getElementById('modal-title').innerText = `ç¼–è¾‘ ${tableSchema.title}`;
            renderForm(item);
            document.getElementById('edit-modal').style.display = 'flex';
        }

        function openCreateModal() {
            currentEditId = null;
            document.getElementById('modal-title').innerText = `æ–°å¢ ${tableSchema.title}`;
            renderForm({});
            document.getElementById('edit-modal').style.display = 'flex';
        }

        // åŠ¨æ€æ¸²æŸ“è¡¨å•ï¼Œé›†æˆå¯Œæ–‡æœ¬
        function renderForm(data) {
            const formBox = document.getElementById('modal-form-body');
            let html = '';
            tableSchema.editFields.forEach(f => {
                let val = data[f.key] !== undefined ? data[f.key] : '';
                html += `<div class="form-group"><label class="form-label">${f.label}</label>`;
                
                if (f.key === 'content' || (f.type === 'textarea' && f.label.includes('æ­£æ–‡'))) {
                    html += `
                        <div class="editor-wrapper">
                            <div class="editor-toolbar">
                                <button class="tool-btn" onclick="autoFormatPolicy('f-${f.key}')" title="è‡ªåŠ¨æ’ç‰ˆ">ğŸ§¹ æ’ç‰ˆ</button>
                                <div class="tool-separator"></div>
                                <button class="tool-btn" onclick="modifyIndent(true, 'f-${f.key}')" title="ç¼©è¿›">â‡¥</button>
                                <button class="tool-btn" onclick="modifyIndent(false, 'f-${f.key}')" title="å–æ¶ˆç¼©è¿›">â‡¤</button>
                                <div class="tool-separator"></div>
                                <button class="tool-btn" onclick="applyAlignment('left', 'f-${f.key}')">â¬…</button>
                                <button class="tool-btn" onclick="applyAlignment('center', 'f-${f.key}')">â¬†</button>
                                <button class="tool-btn" onclick="applyAlignment('right', 'f-${f.key}')">â¡</button>
                                <div class="tool-separator"></div>
                                <button class="tool-btn" onclick="openImageModal('f-${f.key}')">ğŸ–¼ï¸</button>
                            </div>
                            <textarea id="f-${f.key}" class="rich-content-area" rows="15">${val}</textarea>
                        </div>`;
                } else if (f.type === 'text') {
                    html += `<input type="text" id="f-${f.key}" class="form-control" value="${val}">`;
                } else if (f.type === 'textarea') {
                    html += `<textarea id="f-${f.key}" class="form-control" rows="4">${val}</textarea>`;
                } else if (f.type === 'select') {
                    let opts = f.options.map(o => `<option value="${o}" ${val===o?'selected':''}>${o}</option>`).join('');
                    html += `<select id="f-${f.key}" class="form-control">${opts}</select>`;
                } else if (f.type === 'boolean') {
                    html += `<select id="f-${f.key}" class="form-control"><option value="true" ${val===true?'selected':''}>æ˜¯ (True)</option><option value="false" ${val!==true?'selected':''}>å¦ (False)</option></select>`;
                } else if (f.type === 'json') {
                    let jsonStr = val ? JSON.stringify(val, null, 2) : '{}';
                    html += `<textarea id="f-${f.key}" class="form-control" rows="5" style="font-family:monospace;">${jsonStr}</textarea>`;
                } else if (f.type === 'date') {
                    html += `<input type="date" id="f-${f.key}" class="form-control" value="${val}">`;
                }
                html += `</div>`;
            });
            formBox.innerHTML = html;
        }

        // ç¼–è¾‘å™¨è¾…åŠ©åŠŸèƒ½
        let activeEditorId = ''; 

        function openImageModal(targetId) {
            if(targetId) activeEditorId = targetId;
            document.getElementById('img-modal').style.display = 'flex';
            document.getElementById('modal-img-url').focus();
        }
        function closeImageModal() {
            document.getElementById('img-modal').style.display = 'none';
        }
        function confirmInsertImage() {
            const url = document.getElementById('modal-img-url').value.trim();
            const alt = document.getElementById('modal-img-alt').value.trim();
            if(!url) return alert('è¯·è¾“å…¥å›¾ç‰‡é“¾æ¥');
            const md = `\n![${alt}](${url})\n`;
            insertTextAtCursor(md, activeEditorId);
            closeImageModal();
            document.getElementById('modal-img-url').value = '';
            document.getElementById('modal-img-alt').value = '';
        }

        function insertTextAtCursor(text, elementId, replaceSelection = false) {
            const textarea = document.getElementById(elementId);
            if(!textarea) return;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const oldText = textarea.value;
            if (replaceSelection) textarea.value = oldText.substring(0, start) + text + oldText.substring(end);
            else textarea.value = oldText.substring(0, start) + text + oldText.substring(start);
            textarea.focus();
        }

        function modifyIndent(isIndent, elementId) {
            const textarea = document.getElementById(elementId);
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            let startLine = text.lastIndexOf('\n', start - 1) + 1;
            let endLine = text.indexOf('\n', end);
            if (endLine === -1) endLine = text.length;
            const selectedLines = text.substring(startLine, endLine);
            const indentChar = 'ã€€ã€€'; 
            let modifiedLines = selectedLines.split('\n').map(line => {
                if (isIndent) return line.startsWith(indentChar) ? line : indentChar + line;
                else return line.replace(new RegExp('^' + indentChar), '');
            }).join('\n');
            textarea.setRangeText(modifiedLines, startLine, endLine, 'select');
        }

        function applyAlignment(align, elementId) {
            const textarea = document.getElementById(elementId);
            const selection = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd);
            if(!selection) return alert('è¯·å…ˆé€‰æ‹©è¦å¯¹é½çš„æ®µè½æ–‡å­—');
            let wrapper = `<p style="text-align: ${align};">${selection}</p>`;
            insertTextAtCursor(wrapper, elementId, true);
        }

        function autoFormatPolicy(elementId) {
            const textarea = document.getElementById(elementId);
            let text = textarea.value;
            if (!text || text.trim().length === 0) return;
            text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').replace(/\n\s*\n/g, '\n\n'); 
            text = text.replace(/^([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+ã€)/gm, '### $1');
            text = text.replace(/^(\ï¼ˆ[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+\ï¼‰)/gm, '**$1**');
            text = text.replace(/^(\d+\.)/gm, '**$1**');
            text = text.replace(/(ç¬¬[0-9ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+æ¡)/g, '**$1**');
            text = text.split('\n').map(line => {
                let cleanLine = line.trim();
                if (cleanLine.length === 0) return '';
                if (cleanLine.startsWith('#') || cleanLine.startsWith('![') || cleanLine.startsWith('<p')) return cleanLine;
                return 'ã€€ã€€' + cleanLine.replace(/^ã€€+/, ''); 
            }).join('\n');
            textarea.value = text;
            alert("å·²å®Œæˆè‡ªåŠ¨æ’ç‰ˆï¼");
        }

        async function saveData() {
            const payload = {};
            try {
                tableSchema.editFields.forEach(f => {
                    const el = document.getElementById(`f-${f.key}`);
                    let val = el.value;
                    if (f.type === 'boolean') val = (val === 'true');
                    if (f.type === 'json') val = JSON.parse(val); 
                    if (f.type === 'array') val = val.split(',').map(s=>s.trim());
                    payload[f.key] = val;
                });
            } catch (e) { alert('è¡¨å•æ ¼å¼é”™è¯¯: ' + e.message); return; }
            let error;
            if (currentEditId) {
                const res = await _supabase.from(currentTable).update(payload).eq('id', currentEditId);
                error = res.error;
            } else {
                const res = await _supabase.from(currentTable).insert(payload);
                error = res.error;
            }
            if (error) alert('ä¿å­˜å¤±è´¥: ' + error.message);
            else { closeModal(); loadTableData(currentTable); }
        }

        async function deleteItem(table, id) {
            if(!confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
            const { error } = await _supabase.from(table).delete().eq('id', id);
            if(error) alert('åˆ é™¤å¤±è´¥'); else loadTableData(table);
        }

        function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }
        async function logout() { await _supabase.auth.signOut(); location.href='index.html'; }

        function getTableSchema(tableName) {
            const schemas = {
                'news': {
                    title: 'èµ„è®¯å¿«æŠ¥',
                    listFields: [{key:'title',label:'æ ‡é¢˜',type:'text'}, {key:'category',label:'åˆ†ç±»',type:'text'}, {key:'publish_date',label:'æ—¥æœŸ',type:'date'}, {key:'draft',label:'çŠ¶æ€',type:'boolean'}],
                    editFields: [
                        {key:'title',label:'æ ‡é¢˜',type:'text'},
                        {key:'category',label:'åˆ†ç±»',type:'select',options:['Market','Policy','Capital','Global']},
                        {key:'summary',label:'æ‘˜è¦',type:'textarea'},
                        {key:'content',label:'æ­£æ–‡ (Markdown)',type:'textarea'},
                        {key:'image_url',label:'å°é¢å›¾ URL',type:'text'},
                        {key:'source',label:'æ¥æº',type:'text'},
                        {key:'source_url',label:'åŸæ–‡é“¾æ¥',type:'text'}, 
                        {key:'publish_date',label:'å‘å¸ƒæ—¥æœŸ',type:'date'},
                        {key:'draft',label:'æ˜¯å¦è‰ç¨¿',type:'boolean'}
                    ]
                },
                'policies': {
                    title: 'æ”¿ç­–æ³•è§„',
                    listFields: [{key:'title',label:'æ”¿ç­–åç§°',type:'text'}, {key:'department',label:'éƒ¨é—¨',type:'text'}, {key:'level',label:'å±‚çº§',type:'text'}, {key:'draft',label:'çŠ¶æ€',type:'boolean'}],
                    editFields: [
                        {key:'title',label:'æ ‡é¢˜',type:'text'},
                        {key:'department',label:'å‘æ–‡éƒ¨é—¨',type:'text'},
                        {key:'level',label:'å±‚çº§',type:'select',options:['å›½å®¶éƒ¨å§”','åœ°æ–¹æ”¿åºœ','å›½é™…ç»„ç»‡','å›½å¤–/å›½é™…']},
                        {key:'summary',label:'è§£è¯»æ‘˜è¦',type:'textarea'},
                        {key:'content',label:'æ­£æ–‡/å…¨æ–‡',type:'textarea'},
                        {key:'file_url',label:'é™„ä»¶é“¾æ¥',type:'text'}, 
                        {key:'related_city',label:'å…³è”åŸå¸‚',type:'text'},
                        {key:'draft',label:'è‰ç¨¿',type:'boolean'}
                    ]
                },
                'tech_trends': {
                    title: 'æŠ€æœ¯å‰æ²¿',
                    listFields: [{key:'title',label:'æ ‡é¢˜',type:'text'}, {key:'type',label:'ç±»å‹',type:'text'}, {key:'org',label:'æœºæ„',type:'text'}, {key:'draft',label:'çŠ¶æ€',type:'boolean'}],
                    editFields: [{key:'title',label:'æ ‡é¢˜',type:'text'}, {key:'type',label:'ç±»å‹',type:'select',options:['Patent','Paper','Product']}, {key:'domain',label:'é¢†åŸŸ',type:'select',options:['åŠ¨åŠ›ç”µæ± ','é£æ§','å¤æ']}, {key:'summary',label:'æ‘˜è¦',type:'textarea'}, {key:'org',label:'ç ”å‘æœºæ„',type:'text'}, {key:'draft',label:'è‰ç¨¿',type:'boolean'}]
                },
                'companies': {
                    title: 'å…¬å¸åº“',
                    listFields: [{key:'name',label:'åç§°',type:'text'}, {key:'industry_chain',label:'äº§ä¸šé“¾',type:'text'}, {key:'total_funding_est_usd',label:'èèµ„(USD)',type:'text'}, {key:'is_listed',label:'ä¸Šå¸‚',type:'boolean'}],
                    editFields: [{key:'name',label:'å…¬å¸å',type:'text'}, {key:'country_code',label:'å›½å®¶ä»£ç (CN/US)',type:'text'}, {key:'industry_chain',label:'äº§ä¸šé“¾',type:'select',options:['upstream','midstream','downstream']}, {key:'primary_category',label:'èµ›é“',type:'select',options:['eVTOL','Drone','Battery']}, {key:'description',label:'ç®€ä»‹',type:'textarea'}, {key:'total_funding_est_usd',label:'ç´¯è®¡èèµ„(æ•°å­—)',type:'text'}, {key:'is_listed',label:'æ˜¯å¦ä¸Šå¸‚',type:'boolean'}, {key:'draft',label:'è‰ç¨¿',type:'boolean'}]
                },
                'products': {
                    title: 'é£è¡Œå™¨äº§å“',
                    listFields: [{key:'name',label:'å‹å·',type:'text'}, {key:'type',label:'ç±»å‹',type:'text'}, {key:'certification_status',label:'çŠ¶æ€',type:'text'}],
                    editFields: [{key:'name',label:'å‹å·åç§°',type:'text'}, {key:'type',label:'ç±»å‹',type:'select',options:['Multicopter','Lift+Cruise','Vectored']}, {key:'company_id',label:'æ‰€å±å…¬å¸ID',type:'text'}, {key:'specs',label:'æ€§èƒ½å‚æ•° (JSON)',type:'json'}, {key:'certification_status',label:'å–è¯çŠ¶æ€',type:'select',options:['Concept','Prototype','Testing','Certified']}, {key:'draft',label:'è‰ç¨¿',type:'boolean'}]
                },
                'cooperation_leads': {
                    title: 'å•†åŠ¡çº¿ç´¢ (B2B)',
                    listFields: [{key:'contact_name',label:'è”ç³»äºº',type:'text'}, {key:'company_name',label:'å…¬å¸',type:'text'}, {key:'service_type',label:'æ„å‘',type:'text'}, {key:'status',label:'çŠ¶æ€',type:'text'}],
                    editFields: [{key:'status',label:'å¤„ç†çŠ¶æ€',type:'select',options:['pending','contacted','closed']}, {key:'contact_name',label:'å§“å',type:'text'}, {key:'message',label:'éœ€æ±‚è¯¦æƒ…',type:'textarea'}]
                },
                'media_requests': {
                    title: 'åª’ä½“ç”³è¯·',
                    listFields: [{key:'organization',label:'æœºæ„',type:'text'}, {key:'request_type',label:'ç±»å‹',type:'text'}, {key:'status',label:'çŠ¶æ€',type:'text'}],
                    editFields: [{key:'status',label:'å®¡æ ¸çŠ¶æ€',type:'select',options:['pending','approved','rejected']}, {key:'material_link',label:'èµ„æ–™é“¾æ¥',type:'text'}]
                },
                'profiles': {
                    title: 'ç”¨æˆ·ç®¡ç†',
                    listFields: [{key:'username',label:'ç”¨æˆ·å',type:'text'}, {key:'email',label:'é‚®ç®±',type:'text'}, {key:'is_expert',label:'ä¸“å®¶',type:'boolean'}, {key:'tier',label:'ç­‰çº§',type:'text'}],
                    editFields: [{key:'username',label:'ç”¨æˆ·å',type:'text'}, {key:'is_expert',label:'è®¤è¯ä¸“å®¶',type:'boolean'}, {key:'industry_role',label:'ä¸“å®¶å¤´è¡”',type:'text'}, {key:'tier',label:'ä¼šå‘˜ç­‰çº§',type:'select',options:['free','pro','enterprise']}, {key:'is_admin',label:'ç®¡ç†å‘˜æƒé™ (æ…ç”¨)',type:'boolean'}]
                }
            };
            return schemas[tableName] || schemas['news'];
        }
    </script>
</body>
</html>
