<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å¤®æ§åˆ¶å° | AeroScope Admin</title>
    <link rel="stylesheet" href="style.css">
    <!-- å¼•å…¥ SheetJS ç”¨äºè§£æ Excel/CSV -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        /* --- æ ·å¼ (ä¿æŒåŸæ ·) --- */
        body { background-color: #f1f5f9; min-height: 100vh; display: flex; flex-direction: column; margin: 0; }
        
        /* å¤´éƒ¨æ ·å¼ */
        header {
            background: white; border-bottom: 1px solid #e2e8f0; height: 64px; width: 100%;
            display: flex; justify-content: center; z-index: 50;
        }
        .header-inner {
            width: 100%; max-width: 1600px; display: flex; align-items: center;
            justify-content: space-between; padding: 0 20px; box-sizing: border-box;
        }
        .header-logo { font-weight: 800; font-size: 1.2rem; color: #0f172a; }
        .header-user-area { display: flex; gap: 12px; align-items: center; font-size: 0.9rem; }
        .header-btn {
            text-decoration: none; padding: 8px 16px; border-radius: 6px;
            font-size: 0.85rem; font-weight: 600; transition: all 0.2s; cursor: pointer;
            display: inline-flex; align-items: center; gap: 6px; border: 1px solid transparent;
        }
        .btn-ghost { color: #64748b; background-color: #f1f5f9; }
        .btn-ghost:hover { color: #3b82f6; background-color: #e2e8f0; }
        .btn-danger-light { color: #ef4444; background-color: #fef2f2; border-color: #fee2e2; }
        .btn-danger-light:hover { background-color: #fee2e2; border-color: #fca5a5; }

        /* å¸ƒå±€ */
        .admin-layout { 
            display: grid; grid-template-columns: 260px 1fr; 
            max-width: 1600px; width: 100%; margin: 0 auto; 
            min-height: calc(100vh - 64px); 
        }
        .admin-sidebar { background: #0f172a; color: #e2e8f0; padding: 20px; display: flex; flex-direction: column; }
        .sidebar-group { margin-bottom: 25px; }
        .group-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #64748b; margin-bottom: 10px; padding-left: 10px; font-weight: 700; }
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 12px 15px; cursor: pointer; border-radius: 8px; transition: 0.2s; color: #94a3b8; font-weight: 500; }
        .nav-item:hover, .nav-item.active { background: #1e293b; color: white; }
        .nav-item.active { border-left: 3px solid #3b82f6; }
        .admin-main { padding: 30px; overflow-y: auto; }
        
        /* ä»ªè¡¨ç›˜ç»Ÿè®¡å¡ç‰‡ */
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .stat-num { font-size: 2rem; font-weight: 700; color: #0f172a; }
        .stat-desc { color: #64748b; font-size: 0.9rem; }
        
        /* å†…å®¹åˆ—è¡¨å¡ç‰‡ */
        .content-card { background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .card-header { padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .card-title { font-size: 1.1rem; font-weight: 700; color: #1e293b; }
        
        /* è¡¨æ ¼æ ·å¼ */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { text-align: left; padding: 12px 20px; background: #f8fafc; color: #475569; font-size: 0.85rem; font-weight: 700; border-bottom: 1px solid #e2e8f0; white-space: nowrap; }
        .data-table td { padding: 15px 20px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; color: #334155; vertical-align: middle; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .data-table tr:hover { background: #f8fafc; }
        
        /* å¾½ç« ä¸æŒ‰é’® */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; display:inline-block; }
        .badge-draft { background: #fef9c3; color: #b45309; }
        .badge-pub { background: #dcfce7; color: #15803d; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .type-tag { display: block; font-size: 0.7rem; font-weight: normal; margin-top: 4px; padding: 1px 6px; border-radius: 4px; width: fit-content; font-family: monospace; letter-spacing: -0.5px; }
        
        .btn-xs { padding: 4px 8px; font-size: 0.8rem; border-radius: 4px; border: 1px solid #e2e8f0; background: white; cursor: pointer; margin-right: 5px; color:#475569; }
        .btn-xs:hover { border-color: #3b82f6; color: #3b82f6; }
        
        /* æ–°å¢ï¼šçŠ¶æ€åˆ‡æ¢æŒ‰é’® */
        .btn-pub { color: #15803d; border-color: #dcfce7; background: #f0fdf4; }
        .btn-pub:hover { border-color: #15803d; background: #dcfce7; }
        .btn-revoke { color: #b45309; border-color: #fef3c7; background: #fffbeb; }
        .btn-revoke:hover { border-color: #b45309; background: #fef3c7; }

        .btn-primary-sm { background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight:600; }
        .btn-primary-sm:hover { background: #2563eb; }
        
        /* å¯¼å…¥æŒ‰é’®æ ·å¼ */
        .btn-import { background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight:600; display:inline-flex; align-items:center; gap:5px; margin-right: 10px; }
        .btn-import:hover { background: #059669; }

        /* åˆ†é¡µæ§ä»¶ */
        .pagination-bar { padding: 15px 20px; display: flex; justify-content: flex-end; align-items: center; border-top: 1px solid #f1f5f9; background: #fff; }
        .page-btn { padding: 6px 12px; border: 1px solid #e2e8f0; background: white; border-radius: 4px; cursor: pointer; font-size: 0.85rem; color: #64748b; margin-left: 5px; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #f8fafc; }
        .page-btn:hover:not(:disabled) { border-color: #3b82f6; color: #3b82f6; }
        .page-info { font-size: 0.85rem; color: #64748b; margin-right: 15px; }

        /* å¼¹çª—è¡¨å• */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 800px; max-height: 85vh; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
        .modal-body { padding: 30px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 20px; border-top: 1px solid #e2e8f0; text-align: right; background: #f8fafc; }
        
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: #334155; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95rem; box-sizing: border-box; }
        .form-control:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .form-hint { font-size: 0.8rem; color: #64748b; margin-top: 5px; }

        /* å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ç®€åŒ–ç‰ˆ */
        .editor-wrapper { border: 1px solid #cbd5e1; border-radius: 6px; overflow: hidden; }
        .rich-content-area { border: none; width: 100%; padding: 15px; outline: none; font-size: 1rem; line-height: 1.6; resize: vertical; min-height: 200px; font-family: inherit; }

        /* --- æ–°å¢ï¼šè°·æ­Œä¸“åˆ©ä¸‹è½½å™¨ ä¸“ç”¨æ ·å¼ --- */
        #google-modal .modal-box { width: 1100px; max-width: 95%; height: 85vh; }
        .scraper-ui-container { padding: 20px; display: flex; flex-direction: column; height: 100%; box-sizing: border-box; }
        .scraper-controls { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        .scraper-list { flex: 1; border: 1px solid #e2e8f0; overflow-y: auto; background: #fff; border-radius: 6px; }
        .scraper-log { height: 120px; background: #0f172a; color: #10b981; font-family: monospace; padding: 10px; overflow-y: auto; margin-top: 15px; border-radius: 6px; font-size: 0.85rem; }
        .scraper-row { display: grid; grid-template-columns: 150px 100px 300px 1fr; gap: 10px; padding: 10px; border-bottom: 1px solid #f1f5f9; align-items: center; font-size: 0.9rem; }
        .scraper-row:hover { background: #f8fafc; }
        .scraper-head { font-weight: bold; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        
        /* å“åº”å¼ */
        @media (max-width: 1024px) {
            .admin-layout { grid-template-columns: 80px 1fr; }
            .nav-item span { display: none; }
            .group-label { display: none; }
            .admin-sidebar { align-items: center; padding: 20px 5px; }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-inner">
            <div class="header-logo">
                AeroScope <span style="color:#3b82f6;">Console</span>
            </div>
            <div class="header-user-area">
                <span id="admin-email" style="color:#64748b; font-weight:500;">Checking...</span>
                <a href="index.html" class="header-btn btn-ghost">ğŸ  è¿”å›å‰å°</a>
                <button onclick="logout()" class="header-btn btn-danger-light">ğŸšª é€€å‡º</button>
            </div>
        </div>
    </header>

    <div class="admin-layout">
        <!-- å·¦ä¾§èœå• -->
        <aside class="admin-sidebar">
            <div class="sidebar-group">
                <div class="group-label">Dashboards</div>
                <div class="nav-item active" onclick="switchTab('dashboard', this)"><span>ğŸ“Š æ¦‚è§ˆ (Overview)</span></div>
                <div class="nav-item" onclick="switchTab('raw_db_viewer', this)"><span>ğŸ—„ï¸ å…¨åº“é€è§† (Raw DB)</span></div>
                <a href="admin-ai.html" class="nav-item" style="text-decoration:none;"><span>ğŸ¤– AI é‡‡ç¼–åŠ©æ‰‹</span></a>
            </div>
            
            <div class="sidebar-group">
                <div class="group-label">Content (å†…å®¹ç®¡ç†)</div>
                <div class="nav-item" onclick="switchTab('news', this)"><span>ğŸ“° èµ„è®¯ (News)</span></div>
                <div class="nav-item" onclick="switchTab('policies', this)"><span>ğŸ“œ æ”¿ç­– (Policy)</span></div>
                <div class="nav-item" onclick="switchTab('tech_trends', this)"><span>ğŸš€ æŠ€æœ¯ (Tech)</span></div>
                <div class="nav-item" onclick="switchTab('deep_reports', this)"><span>ğŸ“‘ ç ”æŠ¥ (Reports)</span></div>
            </div>

            <div class="sidebar-group">
                <div class="group-label">Database (æ ¸å¿ƒåº“)</div>
                <div class="nav-item" onclick="switchTab('companies', this)"><span>ğŸ¢ å…¬å¸ (Companies)</span></div>
                <div class="nav-item" onclick="switchTab('products', this)"><span>âœˆï¸ äº§å“ (Products)</span></div>
                <div class="nav-item" onclick="switchTab('investors', this)"><span>ğŸ¦ æŠ•èµ„æ–¹ (Investors)</span></div>
                <div class="nav-item" onclick="switchTab('funding_events', this)"><span>ğŸ’° èèµ„äº‹ä»¶ (Funding)</span></div>
                <div class="nav-item" onclick="switchTab('patents', this)"><span>ğŸ’¡ ä¸“åˆ©åº“ (Patents)</span></div>
            </div>

            <div class="sidebar-group">
                <div class="group-label">Business (å•†ä¸šåŒ–)</div>
                <div class="nav-item" onclick="switchTab('cooperation_leads', this)"><span>ğŸ¤ å•†åŠ¡çº¿ç´¢ (Leads)</span></div>
                <div class="nav-item" onclick="switchTab('media_requests', this)"><span>ğŸ¤ åª’ä½“ç”³è¯· (PR)</span></div>
                <div class="nav-item" onclick="switchTab('profiles', this)"><span>ğŸ‘¥ ç”¨æˆ·ç®¡ç† (Users)</span></div>
            </div>
        </aside>

        <!-- å³ä¾§ä¸»åŒºåŸŸ -->
        <main class="admin-main" id="main-container">
            <div style="text-align:center; padding:50px;">åŠ è½½ä¸­...</div>
        </main>
    </div>

    <!-- é€šç”¨ç¼–è¾‘/æ–°å¢å¼¹çª— -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal-box">
            <div class="modal-header">
                <div class="card-title" id="modal-title">ç¼–è¾‘</div>
                <button onclick="closeModal()" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">Ã—</button>
            </div>
            <div id="modal-form-body" class="modal-body">
                <!-- åŠ¨æ€è¡¨å•å°†æ¸²æŸ“åœ¨è¿™é‡Œ -->
            </div>
            <div class="modal-footer">
                <button class="btn-xs" style="padding:10px 20px; margin-right:10px;" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn-primary-sm" onclick="saveData()">ä¿å­˜æ›´æ”¹</button>
            </div>
        </div>
    </div>

    <!-- æ–°å¢ï¼šGoogle ä¸“åˆ©ä¸‹è½½å™¨å¼¹çª— -->
    <div class="modal-overlay" id="google-modal">
        <div class="modal-box">
            <div class="modal-header">
                <div class="card-title">ğŸŒ è°·æ­Œä¸“åˆ©ä¸‹è½½å™¨ (Google Patents Collector)</div>
                <button onclick="closeGoogleModal()" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">Ã—</button>
            </div>
            <div class="modal-body" style="padding:0; display:flex; flex-direction:column; height:100%;">
                <div class="scraper-ui-container">
                    <div class="scraper-controls">
                        <input type="text" id="g-url" class="form-control" placeholder="è¾“å…¥ä¸“åˆ© URL (å¦‚ https://patents.google.com/patent/CN123456A/zh)" style="flex:1;">
                        <button class="btn-primary-sm" onclick="addGoogleTask()">+ æ·»åŠ ä»»åŠ¡</button>
                        <button class="btn-import" onclick="refreshGoogleList()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                        <button class="btn-primary-sm" style="background:#10b981;" onclick="controlTask('start')">â–¶ å¼€å§‹ä¸‹è½½</button>
                        <button class="btn-xs" onclick="controlTask('pause')">â¯ æš‚åœ/ç»§ç»­</button>
                    </div>
                    
                    <div class="scraper-list">
                        <div class="scraper-row scraper-head">
                            <div>ID</div>
                            <div>çŠ¶æ€</div>
                            <div>æ ‡é¢˜</div>
                            <div>æ“ä½œ</div>
                        </div>
                        <div id="g-list-body">
                            <div style="text-align:center; padding:20px; color:#94a3b8;">æš‚æ— ä»»åŠ¡ï¼Œè¯·å…ˆå¯åŠ¨ Python åç«¯...</div>
                        </div>
                    </div>
                    
                    <div class="scraper-log" id="g-log">
                        > Waiting for connection...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://ulfktuvatxyakrdrwxfq.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVsZmt0dXZhdHh5YWtyZHJ3eGZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NDYyMjksImV4cCI6MjA4MDIyMjIyOX0.SBvHgp9HK_Lr5vXCgwu4Ae-Q6hH4dhMx3JSRbLiU0fU';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        const ALL_DB_TABLES = ['news', 'policies', 'tech_trends', 'deep_reports', 'companies', 'products', 'investors', 'funding_events', 'patents', 'cooperation_leads', 'media_requests', 'profiles'];
        let currentTable = 'dashboard';
        let currentEditId = null;
        let tableSchema = {}; 
        let rawDataCache = [];
        
        // åˆ†é¡µçŠ¶æ€
        let page = 0;
        const PAGE_SIZE = 10;
        let totalCount = 0;

        // Python API åœ°å€
        const PYTHON_API = "http://127.0.0.1:8001"; 

        document.addEventListener('DOMContentLoaded', async () => {
            await checkAdmin();
            loadDashboard();
        });

        // 1. Google ä¸“åˆ©ç›¸å…³é€»è¾‘
        async function openGoogleModal() {
            document.getElementById('google-modal').style.display = 'flex';
            refreshGoogleList();
            startLogPolling();
        }

        function closeGoogleModal() {
            document.getElementById('google-modal').style.display = 'none';
            if(logTimer) clearInterval(logTimer);
            controlTask('pause'); 
        }

        async function refreshGoogleList() {
            try {
                const res = await fetch(`${PYTHON_API}/api/patents/list`);
                const json = await res.json();
                const container = document.getElementById('g-list-body');
                
                if(!json.data || json.data.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:20px; color:#94a3b8;">æš‚æ— æœ¬åœ°æ•°æ®</div>';
                    return;
                }

                let html = '';
                json.data.forEach(item => {
                    let statusColor = item.status === 'Done' ? '#10b981' : (item.status === 'Skipped' ? '#94a3b8' : '#f59e0b');
                    html += `
                        <div class="scraper-row">
                            <div style="font-family:monospace;">${item.id}</div>
                            <div style="color:${statusColor}; font-weight:600;">${item.status}</div>
                            <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${item.title || '-'}</div>
                            <div>
                                ${item.status === 'Pending' ? '<span class="badge badge-draft">ç­‰å¾…ä¸­</span>' : '<span class="badge badge-pub">å®Œæˆ</span>'}
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch(e) {
                console.error(e);
                document.getElementById('g-list-body').innerHTML = '<div style="color:red; padding:20px;">è¿æ¥ Python æœåŠ¡å¤±è´¥ï¼Œè¯·ç¡®ä¿ pyScript/patent_scraper.py å·²è¿è¡Œã€‚</div>';
            }
        }

        async function addGoogleTask() {
            const url = document.getElementById('g-url').value.trim();
            if(!url) return alert('è¯·è¾“å…¥ URL');
            try {
                await fetch(`${PYTHON_API}/api/patents/add`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({url: url})
                });
                document.getElementById('g-url').value = '';
                refreshGoogleList();
                // è‡ªåŠ¨å¼€å§‹ä»»åŠ¡
                controlTask('start');
            } catch(e) { alert('æ·»åŠ å¤±è´¥: ' + e.message); }
        }

        async function controlTask(action) {
            try {
                await fetch(`${PYTHON_API}/api/patents/control?action=${action}`);
            } catch(e) { console.error(e); }
        }

        let logTimer;
        function startLogPolling() {
            if(logTimer) clearInterval(logTimer);
            logTimer = setInterval(async () => {
                if(document.getElementById('google-modal').style.display === 'none') return;
                try {
                    const res = await fetch(`${PYTHON_API}/api/patents/logs`);
                    const json = await res.json();
                    const logBox = document.getElementById('g-log');
                    logBox.innerHTML = json.logs.join('<br>');
                    logBox.scrollTop = logBox.scrollHeight;
                } catch(e) {}
            }, 2000);
        }

        // 1. æƒé™æ£€æŸ¥
        async function checkAdmin() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) return location.href = 'login.html';
            
            const { data: profile } = await _supabase.from('profiles').select('is_admin, username, email').eq('id', session.user.id).single();
            if (!profile || !profile.is_admin) { 
                alert('æ— æƒè®¿é—®'); 
                return location.href = 'index.html'; 
            }
            document.getElementById('admin-email').innerText = profile.username || profile.email;
        }

        // 2. åˆ‡æ¢ Tab
        function switchTab(tab, el) {
            currentTable = tab;
            page = 0; // é‡ç½®åˆ†é¡µ
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');
            
            if (tab === 'dashboard') loadDashboard();
            else if (tab === 'raw_db_viewer') loadRawDBViewer(); 
            else loadTableData(tab);
        }

        // 3. ä»ªè¡¨ç›˜
        async function loadDashboard() {
            const container = document.getElementById('main-container');
            const [leads, users, companies, patents] = await Promise.all([
                _supabase.from('cooperation_leads').select('id', { count: 'exact', head: true }),
                _supabase.from('profiles').select('id', { count: 'exact', head: true }),
                _supabase.from('companies').select('id', { count: 'exact', head: true }),
                _supabase.from('patents').select('id', { count: 'exact', head: true })
            ]);
            
            container.innerHTML = `
                <h2 style="margin-bottom:20px;">æ•°æ®æ¦‚è§ˆ</h2>
                <div class="stats-row">
                    <div class="stat-card"><div class="stat-desc">æ”¶å½•ä¼ä¸š</div><div class="stat-num">${companies.count || 0}</div></div>
                    <div class="stat-card"><div class="stat-desc">æŠ€æœ¯ä¸“åˆ©</div><div class="stat-num">${patents.count || 0}</div></div>
                    <div class="stat-card"><div class="stat-desc">æ³¨å†Œç”¨æˆ·</div><div class="stat-num">${users.count || 0}</div></div>
                    <div class="stat-card"><div class="stat-desc" style="color:#d97706;">å¾…å¤„ç†çº¿ç´¢</div><div class="stat-num" style="color:#d97706;">${leads.count || 0}</div></div>
                </div>
                <div class="content-card" style="padding:40px; text-align:center; color:#64748b;">
                    <h3>æ¬¢è¿ä½¿ç”¨ AeroScope ä¸­å¤®æ§åˆ¶å°</h3>
                    <p>è¯·ä»å·¦ä¾§èœå•é€‰æ‹©å¯¹åº”çš„æ•°æ®è¡¨è¿›è¡Œç®¡ç†ã€‚</p>
                    <p style="font-size:0.85rem; margin-top:10px;">ğŸ’¡ æç¤ºï¼šåœ¨æ·»åŠ ä¸“åˆ©æˆ–èèµ„ä¿¡æ¯æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å…³è”å·²å­˜åœ¨çš„å…¬å¸ï¼Œæˆ–è‡ªåŠ¨åˆ›å»ºæ–°å…¬å¸ã€‚</p>
                </div>`;
        }

        // 4.1 åŠ è½½ Raw DB Viewer
        async function loadRawDBViewer() {
            const container = document.getElementById('main-container');
            const options = ALL_DB_TABLES.map(t => `<option value="${t}">${t}</option>`).join('');
            container.innerHTML = `
                <div class="content-card">
                    <div class="card-header" style="background:#f8fafc;">
                        <div style="display:flex; align-items:center; gap:15px;">
                            <div class="card-title">ğŸ—„ï¸ æ•°æ®åº“åŸå§‹è®°å½•é€è§†</div>
                            <select id="raw-db-selector" class="form-control" style="width:200px;" onchange="fetchAndRenderRawTable(this.value)"><option value="" disabled selected>é€‰æ‹©æ•°æ®åº“è¡¨...</option>${options}</select>
                            <input type="text" id="raw-db-search" class="form-control" style="width:200px;" placeholder="ğŸ” æœç´¢å½“å‰è¡¨å†…å®¹..." onkeyup="filterRawTable()">
                        </div>
                        <div style="font-size:0.85rem; color:#64748b;">æ˜¾ç¤ºæ‰€æœ‰å­—æ®µåŠç±»å‹ (Audit Mode)</div>
                    </div>
                    <div id="raw-table-container" style="overflow-x:auto; min-height:300px; padding:20px;"><p style="text-align:center; color:#94a3b8; margin-top:50px;">è¯·ä»ä¸Šæ–¹ä¸‹æ‹‰æ¡†é€‰æ‹©ä¸€ä¸ªæ•°æ®è¡¨ä»¥æŸ¥çœ‹è¯¦æƒ…ã€‚</p></div>
                </div>`;
        }

        async function fetchAndRenderRawTable(tableName) {
            const container = document.getElementById('raw-table-container');
            container.innerHTML = '<div style="text-align:center; color:#64748b;">æ­£åœ¨åˆ†ææ•°æ®åº“ç»“æ„...</div>';
            const { data, error } = await _supabase.from(tableName).select('*').limit(30).order('created_at', {ascending: false});
            if (error) { container.innerHTML = `<div style="color:red; text-align:center;">è¯»å–å¤±è´¥: ${error.message}</div>`; return; }
            if (!data || data.length === 0) { container.innerHTML = `<div style="text-align:center; color:#94a3b8;">è¯¥è¡¨ä¸ºç©º (0 records)</div>`; rawDataCache = []; return; }
            rawDataCache = data;
            filterRawTable();
        }

        function filterRawTable() {
            const container = document.getElementById('raw-table-container');
            const keyword = document.getElementById('raw-db-search')?.value.toLowerCase().trim() || '';
            if (!rawDataCache || rawDataCache.length === 0) return;
            const allKeys = Object.keys(rawDataCache[0]);
            const getColumnType = (key) => {
                for (let i = 0; i < rawDataCache.length; i++) {
                    const val = rawDataCache[i][key];
                    if (val !== null && val !== undefined) {
                        if (Array.isArray(val)) return 'array';
                        if (typeof val === 'object') return 'json';
                        if (typeof val === 'boolean') return 'bool';
                        if (typeof val === 'number') return 'num';
                        if (typeof val === 'string' && val.length === 36 && val.split('-').length === 5) return 'uuid';
                        if (typeof val === 'string' && /^\d{4}-\d{2}-\d{2}/.test(val)) return 'date';
                        return 'text';
                    }
                }
                return 'null';
            };
            let thHtml = `<th>#</th>`;
            allKeys.forEach(key => {
                const type = getColumnType(key);
                let color = '#64748b'; let bg = '#e2e8f0';
                if(type === 'num') { color = '#0369a1'; bg = '#e0f2fe'; }
                if(type === 'bool') { color = '#15803d'; bg = '#dcfce7'; }
                if(type === 'json' || type === 'array') { color = '#b45309'; bg = '#fef3c7'; }
                if(type === 'date') { color = '#7e22ce'; bg = '#f3e8ff'; }
                thHtml += `<th><div style="font-size:0.9rem;">${key}</div><span class="type-tag" style="background:${bg}; color:${color};">${type}</span></th>`;
            });
            const filteredData = rawDataCache.filter(item => !keyword || Object.values(item).some(val => String(val).toLowerCase().includes(keyword)));
            let trHtml = '';
            filteredData.forEach((item, index) => {
                let tds = `<td>${index + 1}</td>`;
                allKeys.forEach(key => {
                    let val = item[key];
                    if (val === null || val === undefined) val = '<span style="color:#cbd5e1;">null</span>';
                    else if (typeof val === 'object') val = `<span title='${JSON.stringify(val)}' style="color:#b45309; font-family:monospace; cursor:help;">{...}</span>`;
                    else if (typeof val === 'boolean') val = val ? '<span style="color:green">true</span>' : '<span style="color:red">false</span>';
                    else if (String(val).length > 40) val = `<span title="${val}">${String(val).substring(0, 40)}...</span>`;
                    tds += `<td>${val}</td>`;
                });
                trHtml += `<tr>${tds}</tr>`;
            });
            container.innerHTML = `<table class="data-table"><thead><tr>${thHtml}</tr></thead><tbody>${trHtml}</tbody></table>`;
        }

        // 4.2 åŠ è½½å¸¸è§„è¡¨æ ¼æ•°æ® (æ–°å¢åˆ†é¡µåŠŸèƒ½)
        async function loadTableData(tableName) {
            const container = document.getElementById('main-container');
            container.innerHTML = '<div style="text-align:center; padding:50px;">åŠ è½½æ•°æ®ä¸­...</div>';
            
            const schema = getTableSchema(tableName);
            tableSchema = schema;
            
            // è·å–æ€»æ•°
            const { count } = await _supabase.from(tableName).select('id', { count: 'exact', head: true });
            totalCount = count || 0;

            // è·å–å½“é¡µæ•°æ®
            const from = page * PAGE_SIZE;
            const to = from + PAGE_SIZE - 1;
            const { data, error } = await _supabase.from(tableName)
                .select('*')
                .order('created_at', { ascending: false })
                .range(from, to);
            
            if (error) return container.innerHTML = `<div style="color:red;">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            
            let thHtml = '';
            schema.listFields.forEach(f => thHtml += `<th>${f.label}</th>`);
            thHtml += `<th style="width:240px;">æ“ä½œ</th>`; // ç¨å¾®åŠ å®½ä»¥å®¹çº³æ–°æŒ‰é’®

            let trHtml = '';
            data.forEach(item => {
                let tds = '';
                schema.listFields.forEach(f => {
                    let val = item[f.key];
                    // ç‰¹æ®Šå­—æ®µæ¸²æŸ“
                    if (f.type === 'boolean') {
                        if (f.key === 'draft') val = val ? `<span class="badge badge-draft">è‰ç¨¿</span>` : `<span class="badge badge-pub">å·²å‘å¸ƒ</span>`;
                        else val = val ? 'æ˜¯' : 'å¦';
                    }
                    if (f.type === 'date' && val) val = new Date(val).toLocaleDateString();
                    if (f.type === 'array' && Array.isArray(val)) val = val.join(', ');
                    if (f.type === 'number' && val) val = Number(val).toLocaleString(); 
                    if (val === null || val === undefined) val = '-';
                    if (typeof val === 'string' && val.length > 30) val = val.substring(0, 30) + '...';
                    
                    tds += `<td>${val}</td>`;
                });

                const itemStr = JSON.stringify(item).replace(/'/g, "&#39;");
                
                // åŠ¨æ€ç”Ÿæˆå‘å¸ƒ/æ’¤é”€æŒ‰é’®
                let statusBtn = '';
                if (item.draft === true) {
                    // å½“å‰æ˜¯è‰ç¨¿ -> æ˜¾ç¤ºâ€œå‘å¸ƒâ€
                    statusBtn = `<button class="btn-xs btn-pub" onclick="togglePublish('${tableName}', '${item.id}', true)">ğŸš€ å‘å¸ƒ</button>`;
                } else if (item.draft === false) {
                    // å½“å‰å·²å‘å¸ƒ -> æ˜¾ç¤ºâ€œæ’¤é”€â€
                    statusBtn = `<button class="btn-xs btn-revoke" onclick="togglePublish('${tableName}', '${item.id}', false)">â†©ï¸ æ’¤é”€</button>`;
                }

                const btns = `
                    <button class="btn-xs" onclick='openEditModal(${itemStr})'>ç¼–è¾‘</button>
                    ${statusBtn}
                    <button class="btn-xs" style="color:#ef4444; border-color:#ef4444;" onclick="deleteItem('${tableName}', '${item.id}')">åˆ é™¤</button>
                `;
                trHtml += `<tr>${tds}<td>${btns}</td></tr>`;
            });

            // å¯¼å…¥æŒ‰é’®ä»…åœ¨ä¸“åˆ©åº“æ˜¾ç¤º
            let importBtn = '';
            if (tableName === 'patents') {
                importBtn = `
                    <button class="btn-import" style="background:#8b5cf6; margin-right:10px;" onclick="openGoogleModal()">ğŸŒ ä¸“åˆ©ä¸‹è½½ (è°·æ­Œ)</button>

                    <input type="file" id="patent-file-upload" accept=".xlsx, .xls, .csv" style="display:none;" onchange="handlePatentImport(this)">
                    <button class="btn-import" onclick="document.getElementById('patent-file-upload').click()">ğŸ“‚ æ‰¹é‡å¯¼å…¥ (ä¸“åˆ©ä¹‹æ˜Ÿ)</button>

                    <!-- æ–°å¢ï¼šæ™ºæ…§èŠ½å¯¼å…¥ -->
                    <input type="file" id="patsnap-file-upload" accept=".xlsx, .xls" style="display:none;" onchange="handlePatsnapImport(this)">
                    <button class="btn-import" style="background:#7c3aed;" onclick="document.getElementById('patsnap-file-upload').click()">ğŸ“‚ æ™ºæ…§èŠ½å¯¼å…¥</button>
                `;
            }
            
            // åˆ†é¡µæ§åˆ¶æ 
            const totalPages = Math.ceil(totalCount / PAGE_SIZE);
            const currentPageNum = page + 1;
            const paginationHtml = `
                <div class="pagination-bar">
                    <span class="page-info">ç¬¬ ${currentPageNum} é¡µ / å…± ${totalPages} é¡µ (æ€»è®¡ ${totalCount} æ¡)</span>
                    <button class="page-btn" onclick="changePage(-1)" ${page === 0 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
                    <button class="page-btn" onclick="changePage(1)" ${page >= totalPages - 1 ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>
                </div>
            `;

            container.innerHTML = `
                <div class="content-card">
                    <div class="card-header">
                        <div class="card-title">${schema.title} ç®¡ç†</div>
                        <div>
                            ${importBtn}
                            <button class="btn-primary-sm" onclick="openCreateModal()">+ æ–°å¢è®°å½•</button>
                        </div>
                    </div>
                    <div style="overflow-x:auto;">
                        <table class="data-table">
                            <thead><tr>${thHtml}</tr></thead>
                            <tbody>${trHtml || '<tr><td colspan="10" style="text-align:center; padding:20px;">æš‚æ— æ•°æ®</td></tr>'}</tbody>
                        </table>
                    </div>
                    ${paginationHtml}
                </div>`;
        }
        
        // åˆ†é¡µé€»è¾‘
        function changePage(direction) {
            page += direction;
            loadTableData(currentTable);
        }

        // åˆ‡æ¢å‘å¸ƒçŠ¶æ€
        async function togglePublish(table, id, isDraft) {
            const newDraftStatus = !isDraft; // å¦‚æœæ˜¯è‰ç¨¿(true)ï¼Œç‚¹å‘å¸ƒå˜falseï¼›å¦‚æœæ˜¯å‘å¸ƒ(false)ï¼Œç‚¹æ’¤é”€å˜true
            const { error } = await _supabase.from(table).update({ draft: newDraftStatus }).eq('id', id);
            
            if (error) {
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            } else {
                loadTableData(table); // åˆ·æ–°åˆ—è¡¨
            }
        }

        // 5. æ‰“å¼€è¡¨å• (ç¼–è¾‘/æ–°å¢)
        function openEditModal(item) {
            currentEditId = item.id;
            document.getElementById('modal-title').innerText = `ç¼–è¾‘ ${tableSchema.title}`;
            renderForm(item);
            document.getElementById('edit-modal').style.display = 'flex';
        }

        function openCreateModal() {
            currentEditId = null;
            document.getElementById('modal-title').innerText = `æ–°å¢ ${tableSchema.title}`;
            renderForm({});
            document.getElementById('edit-modal').style.display = 'flex';
        }

        // 6. æ¸²æŸ“è¡¨å•å­—æ®µ (ä¼˜åŒ–ç‰ˆ)
        function renderForm(data) {
            const formBox = document.getElementById('modal-form-body');
            let html = '';
            
            tableSchema.editFields.forEach(f => {
                let val = data[f.key] !== undefined ? data[f.key] : '';
                
                // --- æç¤ºä¿¡æ¯ (Auto-Link) ---
                let hint = '';
                if (f.key === 'applicant' && currentTable === 'patents') hint = '<div class="form-hint">âœ¨ è¾“å…¥å…¬å¸åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å…³è”æˆ–åˆ›å»ºæ–°å…¬å¸</div>';
                if (f.key === 'company_name' && currentTable === 'funding_events') hint = '<div class="form-hint">âœ¨ è¾“å…¥å…¬å¸åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å…³è”æˆ–åˆ›å»ºæ–°å…¬å¸</div>';

                // --- å­—æ®µæ¸²æŸ“ ---
                html += `<div class="form-group"><label class="form-label">${f.label}</label>`;
                
                if (f.type === 'array') {
                    const displayVal = Array.isArray(val) ? val.join(', ') : (val || '');
                    html += `<input type="text" id="f-${f.key}" class="form-control" value="${displayVal}" placeholder="å¤šé¡¹è¯·ç”¨é€—å·åˆ†éš”">`;
                }
                else if (f.type === 'json' || f.key === 'specs') {
                    const jsonStr = val ? JSON.stringify(val, null, 2) : '{}';
                    html += `<textarea id="f-${f.key}" class="form-control" rows="6" style="font-family:monospace; font-size:0.85rem;">${jsonStr}</textarea>`;
                }
                else if (f.key === 'content' || (f.type === 'textarea' && f.label.includes('æ­£æ–‡'))) {
                    html += `<div class="editor-wrapper"><textarea id="f-${f.key}" class="rich-content-area">${val}</textarea></div>`;
                } 
                else if (f.type === 'boolean') {
                    html += `
                        <select id="f-${f.key}" class="form-control">
                            <option value="true" ${val===true?'selected':''}>æ˜¯ (True)</option>
                            <option value="false" ${val!==true?'selected':''}>å¦ (False)</option>
                        </select>`;
                } 
                else if (f.type === 'select') {
                    let opts = f.options.map(o => `<option value="${o}" ${val===o?'selected':''}>${o}</option>`).join('');
                    html += `<select id="f-${f.key}" class="form-control">${opts}</select>`;
                }
                else if (f.type === 'textarea') {
                    html += `<textarea id="f-${f.key}" class="form-control" rows="4">${val}</textarea>`;
                }
                else if (f.type === 'date') {
                    html += `<input type="date" id="f-${f.key}" class="form-control" value="${val}">`;
                }
                else if (f.type === 'number') {
                    html += `<input type="number" id="f-${f.key}" class="form-control" value="${val}" step="0.01">`;
                }
                else {
                    html += `<input type="text" id="f-${f.key}" class="form-control" value="${val}">`;
                }
                
                html += `${hint}</div>`;
            });
            formBox.innerHTML = html;
        }

        // 7. ä¿å­˜æ•°æ® (å¼ºåŒ–ç‰ˆ)
        async function saveData() {
            const payload = {};
            try {
                tableSchema.editFields.forEach(f => {
                    const el = document.getElementById(`f-${f.key}`);
                    if(!el) return;
                    
                    let val = el.value;

                    if (f.type === 'boolean') val = (val === 'true');
                    
                    if (f.type === 'array') {
                        val = val ? val.split(/,|ï¼Œ/).map(s => s.trim()).filter(s => s) : [];
                    }
                    
                    if (f.type === 'json') {
                        try {
                            val = JSON.parse(val);
                        } catch (e) {
                            throw new Error(`å­—æ®µ [${f.label}] JSON æ ¼å¼é”™è¯¯`);
                        }
                    }
                    
                    if (f.type === 'number') val = val ? Number(val) : null;

                    payload[f.key] = val;
                });
            } catch (e) { 
                alert(e.message); 
                return; 
            }

            let error;
            if (currentEditId) {
                const res = await _supabase.from(currentTable).update(payload).eq('id', currentEditId);
                error = res.error;
            } else {
                const res = await _supabase.from(currentTable).insert(payload);
                error = res.error;
            }

            if (error) alert('ä¿å­˜å¤±è´¥: ' + error.message);
            else { closeModal(); loadTableData(currentTable); }
        }

        // 8. åˆ é™¤æ•°æ® (å¸¦å¤–é”®æ£€æŸ¥)
        async function deleteItem(table, id) {
            if(!confirm('âš ï¸ ç¡®å®šè¦å½»åº•åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;

            const { error } = await _supabase.from(table).delete().eq('id', id);

            if (error) {
                if (error.code === '23503') { // Postgres å¤–é”®çº¦æŸé”™è¯¯
                    alert('âŒ åˆ é™¤å¤±è´¥ï¼šè¯¥è®°å½•è¢«å…¶ä»–æ•°æ®å¼•ç”¨ï¼ˆå¦‚äº§å“ã€èèµ„ã€ä¸“åˆ©ï¼‰ã€‚\nè¯·å…ˆåˆ é™¤å…³è”æ•°æ®ã€‚');
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + error.message);
                }
            } else {
                loadTableData(table);
                if(table === 'companies') loadDashboard();
            }
        }

        // 9. æ‰¹é‡å¯¼å…¥ä¸“åˆ© (Excel/CSV) - V2.0 å¢å¼ºç‰ˆ
        async function handlePatentImport(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    if (jsonData.length === 0) {
                        alert('æ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
                        return;
                    }

                    if (!confirm(`å‡†å¤‡å¤„ç† ${jsonData.length} æ¡ä¸“åˆ©æ•°æ®ã€‚\n\næœºåˆ¶è¯´æ˜ï¼š\n1. è‹¥ä¸“åˆ©å·å·²å­˜åœ¨ -> æ›´æ–°ä¿¡æ¯ (æŸ¥é‡)\n2. è‹¥ä¸å­˜åœ¨ -> æ–°å¢è®°å½•\n3. è‡ªåŠ¨è¯†åˆ«å¤šä¸ªç”³è¯·äººå¹¶å…³è”/åˆ›å»ºå…¬å¸\n\næ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                        input.value = '';
                        return;
                    }

                    // --- æ­¥éª¤ 1ï¼šæå–æ‰€æœ‰æ½œåœ¨å…¬å¸åï¼Œå»é‡ï¼Œå¹¶æ’å…¥ Companies è¡¨ ---
                    const uniqueCompanies = new Set();
                    jsonData.forEach(row => {
                        let applicantStr = row['ç”³è¯·äºº'] || row['Applicant'] || '';
                        // å¢å¼ºæ‹†åˆ†é€»è¾‘ï¼šæ”¯æŒç«–çº¿ | å’Œ ||
                        const apps = applicantStr.split(/;|ï¼›|\||\|\||\|\|\||,|ï¼Œ|\s+/).map(s => s.trim()).filter(s => s);
                        
                        apps.forEach(app => {
                            if (isStrictlyOrganization(app)) {
                                uniqueCompanies.add(app);
                            }
                        });
                    });

                    if (uniqueCompanies.size > 0) {
                        console.log(`è¯†åˆ«åˆ° ${uniqueCompanies.size} ä¸ªæœºæ„ï¼Œæ­£åœ¨æ‰¹é‡åˆ›å»º...`);
                        const companyObjects = Array.from(uniqueCompanies).map(name => ({
                            name: name,
                            draft: false // è‡ªåŠ¨åˆ›å»ºçš„å…¬å¸é»˜è®¤ä¸ºéè‰ç¨¿
                        }));
                        
                        // æ‰¹é‡ upsert å…¬å¸ (æ ¹æ® name æŸ¥é‡ï¼Œå¦‚æœå­˜åœ¨åˆ™å¿½ç•¥)
                        const { error: compError } = await _supabase.from('companies').upsert(companyObjects, { 
                            onConflict: 'name', 
                            ignoreDuplicates: true 
                        });
                        
                        if (compError) {
                            console.error('å…¬å¸åˆ›å»ºå¤±è´¥:', compError);
                        } else {
                            console.log('å…¬å¸æ‰¹é‡åˆ›å»º/æ›´æ–°å®Œæˆ');
                        }
                    }

                    const records = jsonData.map(row => {
                        // å¥å£®çš„å­—æ®µè¯»å–
                        const title = row['æ ‡é¢˜'] || row['Title'] || row['ä¸“åˆ©åç§°'] || 'æœªå‘½åä¸“åˆ©';
                        const appNum = row['ç”³è¯·å·'] || row['Application Number'] || '';
                        // ä¸“åˆ©å·æ˜¯æŸ¥é‡çš„å…³é”®ï¼Œå¿…é¡»å¤„ç†
                        let pubNum = row['å…¬å¼€ï¼ˆå…¬å‘Šï¼‰å·'] || row['Publication Number'] || row['ä¸“åˆ©å·'];
                        if(!pubNum) pubNum = appNum; // å¦‚æœæ²¡ä¸“åˆ©å·ï¼Œç”¨ç”³è¯·å·ä»£æ›¿
                        
                        // æ¸…æ´—ç”³è¯·äººå­—æ®µï¼šå»é™¤å¤šä½™ç©ºæ ¼ï¼Œç»Ÿä¸€åˆ†éš”ç¬¦
                        let applicant = row['ç”³è¯·äºº'] || row['Applicant'] || 'æœªçŸ¥';
                        applicant = applicant.replace(/\s+/g, ' ').trim(); // å»é™¤æ¢è¡Œå’Œå¤šä½™ç©ºæ ¼

                        const typeRaw = row['ä¸“åˆ©ç±»å‹'] || row['Patent Type'];
                        const appDateRaw = row['ç”³è¯·æ—¥'] || row['Application Date'];
                        const pubDateRaw = row['å…¬å¼€ï¼ˆå…¬å‘Šï¼‰æ—¥'] || row['Publication Date'];
                        const status = row['æ³•å¾‹çŠ¶æ€'] || row['Legal Status'];
                        const abstract = row['æ‘˜è¦'] || row['Abstract'];
                        const mainClass = row['ä¸»åˆ†ç±»å·'] || row['Main Classification'] || '';
                        const inventors = row['å‘æ˜äºº'] || row['Inventors'];

                        // ç±»å‹æ˜ å°„
                        let patentType = 'Invention';
                        if (typeRaw) {
                            if (typeRaw.includes('å®ç”¨')) patentType = 'Utility Model';
                            else if (typeRaw.includes('å¤–è§‚')) patentType = 'Design';
                        }

                        return {
                            title: title,
                            application_number: appNum,
                            patent_number: pubNum, // å”¯ä¸€ç´¢å¼•é”®
                            applicant: applicant,
                            patent_type: patentType,
                            application_date: parseExcelDate(appDateRaw),
                            publication_date: parseExcelDate(pubDateRaw),
                            legal_status: status || 'æœªçŸ¥',
                            abstract: abstract,
                            technical_categories: mainClass ? [mainClass.split(/;|ï¼›|\s/)[0]] : [],
                            inventors: inventors ? inventors.split(/;|ï¼›/) : [],
                            draft: false,
                            updated_at: new Date() // æ ‡è®°æ›´æ–°æ—¶é—´
                        };
                    });

                    // è¿‡æ»¤æ‰æ²¡æœ‰å”¯ä¸€æ ‡è¯†çš„æ•°æ®
                    const validRecords = records.filter(r => r.patent_number);
                    if (validRecords.length < records.length) {
                        console.warn(`è·³è¿‡äº† ${records.length - validRecords.length} æ¡æ²¡æœ‰ä¸“åˆ©å·çš„æ•°æ®`);
                    }

                    // æ‰¹é‡ Upsert (æ’å…¥æˆ–æ›´æ–°)
                    // onConflict: 'patent_number' æŒ‡å®šäº†æŸ¥é‡ä¾æ®
                    const { error } = await _supabase.from('patents').upsert(validRecords, { 
                        onConflict: 'patent_number',
                        ignoreDuplicates: false // false è¡¨ç¤ºå¦‚æœé‡å¤åˆ™æ›´æ–° (Update)
                    });

                    if (error) {
                        throw error;
                    } else {
                        alert(`âœ… æˆåŠŸå¤„ç† ${validRecords.length} æ¡æ•°æ®ï¼\n\nç³»ç»Ÿæ­£åœ¨åå°ï¼š\n1. è‡ªåŠ¨åˆ›å»ºç¼ºå¤±çš„å­å…¬å¸\n2. å…³è”å¤šä¸»ä½“å…³ç³»\n\nè¯·ç¨ååˆ·æ–°åˆ—è¡¨æŸ¥çœ‹ã€‚`);
                        loadTableData('patents');
                    }

                } catch (err) {
                    console.error(err);
                    alert('å¯¼å…¥å¤±è´¥: ' + err.message + '\n(è¯·æ£€æŸ¥Excelä¸­æ˜¯å¦æœ‰é‡å¤çš„ä¸“åˆ©å·è¡Œ)');
                } finally {
                    input.value = ''; 
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // 10. æ‰¹é‡å¯¼å…¥ä¸“åˆ© (æ™ºæ…§èŠ½ Patsnap æ ¼å¼) - æ–°å¢
        async function handlePatsnapImport(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    if (jsonData.length === 0) {
                        alert('æ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
                        return;
                    }

                    if (!confirm(`å‡†å¤‡å¤„ç† ${jsonData.length} æ¡ä¸“åˆ©æ•°æ® (æ™ºæ…§èŠ½æ ¼å¼)ã€‚\n\næœºåˆ¶è¯´æ˜ï¼š\n1. è‹¥ä¸“åˆ©å·å·²å­˜åœ¨ -> æ›´æ–°ä¿¡æ¯ (æŸ¥é‡)\n2. è‡ªåŠ¨æ¸…æ´—æ³•å¾‹çŠ¶æ€\n3. è‡ªåŠ¨è¯†åˆ«æœºæ„å¹¶åˆ›å»ºå…¬å¸ (ä¸¥æ ¼è¿‡æ»¤ä¸ªäºº)\n\næ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                        input.value = '';
                        return;
                    }

                    // --- æ­¥éª¤ 1ï¼šæå–æ‰€æœ‰æ½œåœ¨å…¬å¸åï¼Œå»é‡ï¼Œå¹¶æ’å…¥ Companies è¡¨ ---
                    const uniqueCompanies = new Set();
                    jsonData.forEach(row => {
                        let applicantStr = getValueFuzzy(row, ['[æ ‡]å½“å‰ç”³è¯·(ä¸“åˆ©æƒ)äºº', 'å½“å‰ç”³è¯·(ä¸“åˆ©æƒ)äºº', 'ç”³è¯·äºº', 'Applicant']) || '';
                        // å¢å¼ºæ‹†åˆ†é€»è¾‘ï¼šæ”¯æŒç«–çº¿ | å’Œ ||
                        const apps = applicantStr.split(/;|ï¼›|\||\|\||\|\|\||,|ï¼Œ|\s+/).map(s => s.trim()).filter(s => s);
                        
                        apps.forEach(app => {
                            if (isStrictlyOrganization(app)) {
                                uniqueCompanies.add(app);
                            }
                        });
                    });

                    if (uniqueCompanies.size > 0) {
                        console.log(`è¯†åˆ«åˆ° ${uniqueCompanies.size} ä¸ªæœºæ„ï¼Œæ­£åœ¨æ‰¹é‡åˆ›å»º...`);
                        const companyObjects = Array.from(uniqueCompanies).map(name => ({
                            name: name,
                            draft: false // è‡ªåŠ¨åˆ›å»ºçš„å…¬å¸é»˜è®¤ä¸ºéè‰ç¨¿
                        }));
                        
                        // æ‰¹é‡ upsert å…¬å¸ (æ ¹æ® name æŸ¥é‡ï¼Œå¦‚æœå­˜åœ¨åˆ™å¿½ç•¥)
                        const { error: compError } = await _supabase.from('companies').upsert(companyObjects, { 
                            onConflict: 'name', 
                            ignoreDuplicates: true 
                        });
                        
                        if (compError) {
                            console.error('å…¬å¸åˆ›å»ºå¤±è´¥:', compError);
                        } else {
                            console.log('å…¬å¸æ‰¹é‡åˆ›å»º/æ›´æ–°å®Œæˆ');
                        }
                    }

                    // --- æ­¥éª¤ 2ï¼šå¤„ç†ä¸“åˆ©æ•°æ®å¹¶æ’å…¥ Patents è¡¨ ---
                    const records = jsonData.map(row => {
                        // 1. æ™ºèƒ½åŒ¹é…åˆ—å (Fuzzy Matching)
                        const title = getValueFuzzy(row, ['æ ‡é¢˜', 'Title', 'ä¸“åˆ©åç§°']) || 'æœªå‘½åä¸“åˆ©';
                        const appNum = getValueFuzzy(row, ['ç”³è¯·å·', 'ApplicationNumber']) || '';
                        let pubNum = getValueFuzzy(row, ['å…¬å¼€(å…¬å‘Š)å·', 'å…¬å¼€å…¬å‘Šå·', 'PublicationNumber', 'ä¸“åˆ©å·']);
                        if (!pubNum) pubNum = appNum;

                        let applicant = getValueFuzzy(row, ['[æ ‡]å½“å‰ç”³è¯·(ä¸“åˆ©æƒ)äºº', 'å½“å‰ç”³è¯·(ä¸“åˆ©æƒ)äºº', 'ç”³è¯·äºº', 'Applicant']) || 'æœªçŸ¥';
                        applicant = applicant.replace(/\s+/g, ' ').trim();
                        // ä¸“åˆ©è¡¨é‡Œä¿ç•™åŸå§‹(æˆ–ç¨å¾®æ¸…æ´—è¿‡)çš„å®Œæ•´ç”³è¯·äººå­—ç¬¦ä¸²ï¼Œä¸å¼ºè¡Œæ‹†åˆ†
                        // ä½†ä¸ºäº†ç¾è§‚ï¼ŒæŠŠå„ç§åˆ†éš”ç¬¦ç»Ÿä¸€ä¸º "; "
                        applicant = applicant.replace(/;|ï¼›|\||\|\||\|\|\|/g, '; ');

                        const typeRaw = getValueFuzzy(row, ['ä¸“åˆ©ç±»å‹', 'PatentType']);
                        let patentType = 'Invention';
                        if (typeRaw) {
                            if (typeRaw.includes('å®ç”¨')) patentType = 'Utility Model';
                            else if (typeRaw.includes('å¤–è§‚')) patentType = 'Design';
                        }

                        // 2. çŠ¶æ€æ¸…æ´— (Strict Mapping)
                        const statusRaw = getValueFuzzy(row, ['æ³•å¾‹çŠ¶æ€/äº‹ä»¶', 'æ³•å¾‹çŠ¶æ€', 'LegalStatus']);
                        // å¼ºåˆ¶å°†çŠ¶æ€æ˜ å°„ä¸ºæ•°æ®åº“å…è®¸çš„å€¼ï¼š'æœ‰æ•ˆ', 'å®¡ä¸­', 'æ— æ•ˆ'
                        const legalStatus = normalizeLegalStatus(statusRaw);

                        const ipc = getValueFuzzy(row, ['IPCåˆ†ç±»å·', 'IPC']) || '';
                        const inventors = getValueFuzzy(row, ['å‘æ˜äºº', 'Inventor']) || '';
                        
                        const appDateRaw = getValueFuzzy(row, ['ç”³è¯·æ—¥', 'ApplicationDate']);
                        const pubDateRaw = getValueFuzzy(row, ['å…¬å¼€(å…¬å‘Š)æ—¥', 'å…¬å¼€å…¬å‘Šæ—¥', 'PublicationDate']);

                        return {
                            title: title,
                            application_number: appNum,
                            patent_number: pubNum, // å”¯ä¸€ç´¢å¼•é”®
                            applicant: applicant,
                            patent_type: patentType,
                            application_date: parseExcelDate(appDateRaw),
                            publication_date: parseExcelDate(pubDateRaw),
                            legal_status: legalStatus, 
                            abstract: getValueFuzzy(row, ['æ‘˜è¦', 'Abstract']),
                            technical_categories: ipc ? ipc.split(/;|ï¼›/).map(s=>s.trim()).filter(s=>s) : [],
                            inventors: inventors ? inventors.split(/;|ï¼›/).map(s=>s.trim()).filter(s=>s) : [],
                            draft: false,
                            updated_at: new Date()
                        };
                    });

                    const validRecords = records.filter(r => r.patent_number);
                    
                    const { error } = await _supabase.from('patents').upsert(validRecords, { 
                        onConflict: 'patent_number',
                        ignoreDuplicates: false 
                    });

                    if (error) {
                        throw error;
                    } else {
                        alert(`âœ… æˆåŠŸå¤„ç† ${validRecords.length} æ¡æ™ºæ…§èŠ½æ•°æ®ï¼\nå¹¶å·²è‡ªåŠ¨è¯†åˆ«/åˆ›å»ºäº† ${uniqueCompanies.size} ä¸ªå…³è”æœºæ„ã€‚`);
                        loadTableData('patents');
                    }

                } catch (err) {
                    console.error(err);
                    alert('å¯¼å…¥å¤±è´¥: ' + err.message);
                } finally {
                    input.value = ''; 
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // è¾…åŠ©ï¼šå¤„ç† Excel æ—¥æœŸ (å¯èƒ½æ˜¯æ•°å­— 20210610 æˆ– Excel åºåˆ—å·)
        function parseExcelDate(val) {
            if (!val) return null;
            // æ ¼å¼: 20210610 (æ•°å­—æˆ–å­—ç¬¦ä¸²)
            if (String(val).length === 8 && !isNaN(val)) {
                const s = String(val);
                return `${s.substring(0,4)}-${s.substring(4,6)}-${s.substring(6,8)}`;
            }
            // æ ¼å¼: 2021/6/10
            if (String(val).includes('/')) {
                return new Date(val).toISOString().split('T')[0];
            }
            // å¦‚æœæ˜¯ Excel åºåˆ—å· (ä¾‹å¦‚ 44357)
            if (typeof val === 'number' && val > 20000 && val < 60000) {
                 const date = new Date((val - 25569) * 86400 * 1000);
                 return date.toISOString().split('T')[0];
            }
            return null; // æ— æ³•è§£æ
        }
        
        // è¾…åŠ©ï¼šä¸¥æ ¼åˆ¤æ–­æ˜¯å¦ä¸ºæœºæ„ (å¼ºåˆ¶ç™½åå•æ¨¡å¼)
        function isStrictlyOrganization(name) {
            if (!name) return false;
            let s = name.trim();

            // è§„åˆ™1: å¿…é¡»åŒ…å«â€œæœºæ„ç‰¹å¾è¯â€
            const orgKeywords = [
                'å…¬å¸', 'å¤§å­¦', 'å­¦é™¢', 'ç ”ç©¶æ‰€', 'ç ”ç©¶é™¢', 'ä¸­å¿ƒ', 'é›†å›¢', 'ç¤¾', 'å±€', 'å…', 'å§”', 'å‚', 'çŸ¿', 
                'Limited', 'Ltd', 'Inc', 'Corp', 'Group', 'GmbH', 'AG', 'S.p.A', 'S.A.', 'è¡Œ', 'éƒ¨'
            ];
            
            const hasKeyword = orgKeywords.some(k => s.includes(k));
            
            if (!hasKeyword) {
                return false; 
            }

            // è§„åˆ™2: é•¿åº¦æ ¡éªŒ
            if (s.length < 4) { 
                return false; 
            }

            return true;
        }
        
        // å…¼å®¹æ—§å‡½æ•°å
        function isOrganization(name) { return isStrictlyOrganization(name); }

        // è¾…åŠ©ï¼šæ¨¡ç³ŠæŸ¥æ‰¾ Excel åˆ—å€¼
        function getValueFuzzy(row, possibleNames) {
            const keys = Object.keys(row);
            for (let name of possibleNames) {
                if (row[name] !== undefined) return row[name];
                const cleanName = name.replace(/\s|\(|\)|\[|\]/g, '').toLowerCase();
                const matchedKey = keys.find(k => k.replace(/\s|\(|\)|\[|\]/g, '').toLowerCase() === cleanName);
                if (matchedKey) return row[matchedKey];
            }
            return null;
        }

        // è¾…åŠ©ï¼šä¸¥æ ¼æ¸…æ´—æ³•å¾‹çŠ¶æ€ (DB Check Constraint: æœ‰æ•ˆ, å®¡ä¸­, æ— æ•ˆ, é©³å›, è¿‡æœŸ)
        function normalizeLegalStatus(raw) {
            if (!raw) return 'æ— æ•ˆ'; // é»˜è®¤å½’ä¸ºæ— æ•ˆ
            const s = String(raw).trim();
            
            // 1. æœ‰æ•ˆï¼šåŒ…å«â€œæˆæƒâ€
            if (s.includes('æˆæƒ') || s.includes('ä¸“åˆ©æƒç»´æŒ') || s.includes('æœ‰æ•ˆ')) {
                return 'æœ‰æ•ˆ';
            }
            
            // 2. å®¡ä¸­ï¼šåŒ…å«â€œå…¬å¼€â€ or â€œå®è´¨å®¡æŸ¥â€
            if (s.includes('å…¬å¼€') || s.includes('å®è´¨å®¡æŸ¥') || s.includes('å®å®¡')) {
                return 'å®¡ä¸­';
            }
            
            // 3. æ— æ•ˆï¼šå…¶ä½™æƒ…å†µï¼ˆé©³å›ã€æœªç¼´å¹´è´¹ã€æ’¤å›ã€æ”¾å¼ƒã€ç»ˆæ­¢ã€å±Šæ»¡ç­‰ï¼‰
            return 'æ— æ•ˆ'; 
        }

        function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }
        async function logout() { await _supabase.auth.signOut(); location.href='index.html'; }

        // =========================================
        // â˜…â˜…â˜… æ ¸å¿ƒé…ç½®ï¼šå„è¡¨ Schema å®šä¹‰ â˜…â˜…â˜…
        // =========================================
        function getTableSchema(tableName) {
            const schemas = {
                'investors': {
                    title: 'æŠ•èµ„æ–¹ (Investors)',
                    listFields: [{key:'name',label:'æœºæ„åç§°',type:'text'}, {key:'type',label:'ç±»å‹',type:'text'}, {key:'country',label:'åœ°åŒº',type:'text'}, {key:'total_amount',label:'æ€»æŠ•é‡‘é¢(USD)',type:'number'}],
                    editFields: [
                        {key:'name',label:'æœºæ„åç§°',type:'text'},
                        {key:'type',label:'ç±»å‹',type:'select',options:['VC','PE','CVC','Angel','Gov','Other']},
                        {key:'country',label:'å›½å®¶/åœ°åŒº',type:'text'},
                        {key:'website',label:'å®˜ç½‘ URL',type:'text'},
                        {key:'description',label:'ç®€ä»‹',type:'textarea'},
                        {key:'focus_areas',label:'å…³æ³¨é¢†åŸŸ (æ•°ç»„, é€—å·åˆ†éš”)',type:'array'},
                        {key:'investment_stages',label:'æŠ•èµ„è½®æ¬¡åå¥½ (æ•°ç»„, é€—å·åˆ†éš”)',type:'array'},
                        {key:'total_amount',label:'ç®¡ç†/æŠ•èµ„æ€»é¢ (Est. USD)',type:'number'},
                        {key:'draft',label:'è‰ç¨¿çŠ¶æ€',type:'boolean'}
                    ]
                },
                'funding_events': {
                    title: 'èèµ„äº‹ä»¶ (Funding)',
                    listFields: [{key:'funding_date',label:'æ—¥æœŸ',type:'date'}, {key:'company_name',label:'å…¬å¸',type:'text'}, {key:'funding_round',label:'è½®æ¬¡',type:'text'}, {key:'funding_amount',label:'é‡‘é¢(M)',type:'number'}],
                    editFields: [
                        {key:'company_name',label:'è·æŠ•å…¬å¸å (è¾“å…¥åè‡ªåŠ¨å…³è”/åˆ›å»º)',type:'text'},
                        {key:'funding_date',label:'èèµ„æ—¥æœŸ',type:'date'},
                        {key:'announcement_date',label:'å…¬å‘Šæ—¥æœŸ',type:'date'},
                        {key:'funding_round',label:'è½®æ¬¡',type:'select',options:['Seed','Angel','Pre-A','A','A+','B','C','D','IPO','Strategic','M&A']},
                        {key:'funding_amount',label:'é‡‘é¢ (ç™¾ä¸‡)',type:'number'},
                        {key:'funding_currency',label:'è´§å¸',type:'select',options:['USD','CNY','EUR','GBP']},
                        {key:'valuation',label:'æŠ•åä¼°å€¼ (ç™¾ä¸‡)',type:'number'},
                        {key:'lead_investor',label:'é¢†æŠ•æ–¹',type:'text'},
                        {key:'participating_investors',label:'è·ŸæŠ•æ–¹ (é€—å·åˆ†éš”)',type:'text'},
                        {key:'source_url',label:'æ–°é—»æ¥æº URL',type:'text'},
                        {key:'draft',label:'è‰ç¨¿çŠ¶æ€',type:'boolean'}
                    ]
                },
                'patents': {
                    title: 'ä¸“åˆ©æŠ€æœ¯ (Patents)',
                    listFields: [{key:'title',label:'ä¸“åˆ©æ ‡é¢˜',type:'text'}, {key:'applicant',label:'ç”³è¯·äºº',type:'text'}, {key:'patent_type',label:'ç±»å‹',type:'text'}, {key:'legal_status',label:'çŠ¶æ€',type:'text'}],
                    editFields: [
                        {key:'title',label:'ä¸“åˆ©æ ‡é¢˜',type:'text'},
                        {key:'patent_number',label:'ä¸“åˆ©å·/ç”³è¯·å·',type:'text'},
                        {key:'applicant',label:'ç”³è¯·äºº (è¾“å…¥å…¬å¸åè‡ªåŠ¨å…³è”)',type:'text'},
                        {key:'patent_type',label:'ç±»å‹',type:'select',options:['Invention','Utility Model','Design']},
                        {key:'application_date',label:'ç”³è¯·æ—¥',type:'date'},
                        {key:'publication_date',label:'å…¬å¼€æ—¥',type:'date'},
                        {key:'legal_status',label:'æ³•å¾‹çŠ¶æ€',type:'select',options:['æœ‰æ•ˆ','å®¡ä¸­','æ— æ•ˆ','é©³å›','è¿‡æœŸ']},
                        {key:'abstract',label:'æ‘˜è¦',type:'textarea'},
                        {key:'technical_categories',label:'æŠ€æœ¯æ ‡ç­¾ (æ•°ç»„, é€—å·åˆ†éš”)',type:'array'},
                        {key:'industry_chain_position',label:'äº§ä¸šé“¾ä½ç½®',type:'select',options:['upstream','midstream','downstream']},
                        {key:'data_source',label:'æ•°æ®æ¥æº',type:'text'},
                        {key:'draft',label:'è‰ç¨¿çŠ¶æ€',type:'boolean'}
                    ]
                },
                'companies': {
                    title: 'å…¬å¸åº“ (Companies)',
                    listFields: [{key:'name',label:'åç§°',type:'text'}, {key:'industry_chain',label:'äº§ä¸šé“¾',type:'text'}, {key:'primary_category',label:'èµ›é“',type:'text'}, {key:'is_listed',label:'ä¸Šå¸‚',type:'boolean'}],
                    editFields: [
                        {key:'name',label:'å…¬å¸å',type:'text'}, 
                        {key:'name_en',label:'è‹±æ–‡å',type:'text'},
                        {key:'country_code',label:'å›½å®¶ä»£ç  (CN/US)',type:'text'}, 
                        {key:'industry_chain',label:'äº§ä¸šé“¾',type:'select',options:['upstream','midstream','downstream']}, 
                        {key:'primary_category',label:'èµ›é“',type:'select',options:['eVTOL','Drone','FlyingCar','Battery','Avionics','Service']}, 
                        {key:'description',label:'ç®€ä»‹',type:'textarea'}, 
                        {key:'tags',label:'æ ‡ç­¾ (æ•°ç»„, é€—å·åˆ†éš”)',type:'array'},
                        {key:'total_funding_est_usd',label:'ç´¯è®¡èèµ„ (M USD)',type:'number'}, 
                        {key:'is_listed',label:'æ˜¯å¦ä¸Šå¸‚',type:'boolean'}, 
                        {key:'ticker_symbol',label:'è‚¡ç¥¨ä»£ç ',type:'text'},
                        {key:'logo_url',label:'Logo URL',type:'text'},
                        {key:'website_url',label:'å®˜ç½‘',type:'text'},
                        {key:'draft',label:'è‰ç¨¿',type:'boolean'}
                    ]
                },
                'products': {
                    title: 'äº§å“ (Products)',
                    listFields: [{key:'name',label:'å‹å·',type:'text'}, {key:'type',label:'ç±»å‹',type:'text'}, {key:'certification_status',label:'çŠ¶æ€',type:'text'}],
                    editFields: [
                        {key:'name',label:'å‹å·åç§°',type:'text'}, 
                        {key:'type',label:'ç±»å‹',type:'select',options:['Multicopter','Lift+Cruise','Vectored Thrust','FlyingCar']}, 
                        {key:'company_id',label:'æ‰€å±å…¬å¸ID (æ‰‹åŠ¨å…³è”)',type:'number'}, 
                        {key:'manufacturer_name',label:'å‚å•†å (è‡ªåŠ¨å…³è”è¾…åŠ©)',type:'text'},
                        {key:'specs',label:'æ€§èƒ½å‚æ•° (JSON)',type:'json'}, 
                        {key:'image_url',label:'å›¾ç‰‡ URL',type:'text'},
                        {key:'certification_status',label:'å–è¯çŠ¶æ€',type:'select',options:['Concept','Prototype','Testing','Certified']}, 
                        {key:'draft',label:'è‰ç¨¿',type:'boolean'}
                    ]
                },
                'news': {
                    title: 'èµ„è®¯å¿«æŠ¥',
                    listFields: [{key:'title',label:'æ ‡é¢˜',type:'text'}, {key:'category',label:'åˆ†ç±»',type:'text'}, {key:'publish_date',label:'æ—¥æœŸ',type:'date'}],
                    editFields: [
                        {key:'title',label:'æ ‡é¢˜',type:'text'},
                        {key:'category',label:'åˆ†ç±»',type:'select',options:['Market','Policy','Capital','Global']},
                        {key:'summary',label:'æ‘˜è¦',type:'textarea'},
                        {key:'content',label:'æ­£æ–‡ (Markdown)',type:'textarea'},
                        {key:'image_url',label:'å°é¢å›¾ URL',type:'text'},
                        {key:'source',label:'æ¥æº',type:'text'},
                        {key:'publish_date',label:'å‘å¸ƒæ—¥æœŸ',type:'date'},
                        {key:'tags',label:'æ ‡ç­¾ (æ•°ç»„, é€—å·åˆ†éš”)',type:'array'},
                        {key:'draft',label:'æ˜¯å¦è‰ç¨¿',type:'boolean'}
                    ]
                },
                'policies': {
                    title: 'æ”¿ç­–æ³•è§„',
                    listFields: [{key:'title',label:'æ ‡é¢˜',type:'text'}, {key:'department',label:'éƒ¨é—¨',type:'text'}, {key:'level',label:'å±‚çº§',type:'text'}],
                    editFields: [
                        {key:'title',label:'æ ‡é¢˜',type:'text'},
                        {key:'department',label:'å‘æ–‡éƒ¨é—¨',type:'text'},
                        {key:'level',label:'å±‚çº§',type:'select',options:['å›½å®¶éƒ¨å§”','åœ°æ–¹æ”¿åºœ','å›½é™…ç»„ç»‡','å›½å¤–/å›½é™…']},
                        {key:'summary',label:'è§£è¯»æ‘˜è¦',type:'textarea'},
                        {key:'content',label:'æ­£æ–‡/å…¨æ–‡',type:'textarea'},
                        {key:'file_url',label:'é™„ä»¶é“¾æ¥',type:'text'}, 
                        {key:'related_city',label:'å…³è”åŸå¸‚',type:'text'},
                        {key:'publish_date',label:'å‘å¸ƒæ—¥æœŸ',type:'date'},
                        {key:'draft',label:'è‰ç¨¿',type:'boolean'}
                    ]
                },
                'deep_reports': {
                    title: 'æ·±åº¦ç ”æŠ¥',
                    listFields: [{key:'title',label:'æ ‡é¢˜',type:'text'}, {key:'author',label:'ä½œè€…',type:'text'}, {key:'publish_date',label:'æ—¥æœŸ',type:'date'}],
                    editFields: [{key:'title',label:'æ ‡é¢˜',type:'text'}, {key:'author',label:'ä½œè€…',type:'text'}, {key:'summary',label:'æ‘˜è¦',type:'textarea'}, {key:'content',label:'æ­£æ–‡',type:'textarea'}, {key:'is_pro_only',label:'Proä¸“äº«',type:'boolean'}, {key:'draft',label:'è‰ç¨¿',type:'boolean'}]
                },
                'tech_trends': {
                    title: 'æŠ€æœ¯å‰æ²¿',
                    listFields: [{key:'title',label:'æ ‡é¢˜',type:'text'}, {key:'type',label:'ç±»å‹',type:'text'}, {key:'org',label:'æœºæ„',type:'text'}],
                    editFields: [{key:'title',label:'æ ‡é¢˜',type:'text'}, {key:'type',label:'ç±»å‹',type:'select',options:['Patent','Paper','Product']}, {key:'org',label:'æœºæ„',type:'text'}, {key:'summary',label:'æ‘˜è¦',type:'textarea'}, {key:'content',label:'å†…å®¹',type:'textarea'}, {key:'draft',label:'è‰ç¨¿',type:'boolean'}]
                },
                'cooperation_leads': {
                    title: 'å•†åŠ¡çº¿ç´¢',
                    listFields: [{key:'contact_name',label:'è”ç³»äºº',type:'text'}, {key:'company_name',label:'å…¬å¸',type:'text'}, {key:'status',label:'çŠ¶æ€',type:'text'}],
                    editFields: [{key:'status',label:'çŠ¶æ€',type:'select',options:['pending','contacted','closed']}, {key:'contact_name',label:'å§“å',type:'text'}, {key:'message',label:'ç•™è¨€',type:'textarea'}]
                },
                'profiles': {
                    title: 'ç”¨æˆ·ç®¡ç†',
                    listFields: [{key:'username',label:'ç”¨æˆ·å',type:'text'}, {key:'email',label:'é‚®ç®±',type:'text'}, {key:'tier',label:'ç­‰çº§',type:'text'}],
                    editFields: [{key:'username',label:'ç”¨æˆ·å',type:'text'}, {key:'is_expert',label:'ä¸“å®¶',type:'boolean'}, {key:'tier',label:'ç­‰çº§',type:'select',options:['free','pro','enterprise']}]
                }
            };
            
            return schemas[tableName] || schemas['news'];
        }
    </script>
</body>
</html>