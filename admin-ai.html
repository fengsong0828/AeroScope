<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½é‡‡ç¼– | AeroScope Console</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body { background-color: #f1f5f9; margin: 0; min-height: 100vh; display: flex; flex-direction: column; }
        
        /* --- å¤´éƒ¨æ ·å¼ (ä¿æŒåŸæ ·) --- */
        .console-header {
            background: white; 
            border-bottom: 1px solid #e2e8f0; 
            height: 64px; 
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .header-inner {
            width: 100%;
            max-width: 1600px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px; 
            box-sizing: border-box;
        }

        .logo-area { display: flex; align-items: center; gap: 15px; }
        
        .back-btn {
            text-decoration: none; color: #64748b; font-weight: 600; font-size: 0.85rem;
            background: #f1f5f9; padding: 8px 16px; border-radius: 8px; transition: all 0.2s;
            display: flex; align-items: center; gap: 6px; border: 1px solid transparent;
        }
        .back-btn:hover { background: #e2e8f0; color: #3b82f6; border-color: #cbd5e1; }
        
        .brand-text { font-weight: 800; font-size: 1.2rem; color: #0f172a; }
        
        .user-area { display: flex; gap: 12px; align-items: center; font-size: 0.9rem; }
        .header-btn {
            text-decoration: none; padding: 8px 16px; border-radius: 6px;
            font-size: 0.85rem; font-weight: 600; transition: all 0.2s;
            cursor: pointer; display: inline-flex; align-items: center; gap: 6px;
            border: 1px solid transparent;
        }
        .btn-ghost { color: #64748b; background-color: #f1f5f9; }
        .btn-ghost:hover { color: #3b82f6; background-color: #e2e8f0; }

        /* --- å¸ƒå±€æ ·å¼ --- */
        .ai-layout { 
            display: grid; grid-template-columns: 1fr 1.3fr; gap: 30px; 
            max-width: 1600px; margin: 40px auto; padding: 0 30px; width: 100%; flex: 1; box-sizing: border-box;
        }
        
        .panel-card { 
            background: white; padding: 30px; border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;
            display: flex; flex-direction: column;
            max-height: 85vh; overflow-y: auto; /* å¢åŠ æ»šåŠ¨æ¡ä»¥é˜²å†…å®¹è¿‡é•¿ */
        }
        
        .panel-title { font-size: 1.1rem; font-weight: 700; color: #1e293b; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }

        /* --- è¡¨å•æ ·å¼ --- */
        .form-group { margin-bottom: 20px; }
        .form-label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-weight: 600; color: #475569; font-size: 0.9rem; }
        .form-control { 
            width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; 
            font-size: 0.95rem; font-family: inherit; transition: 0.2s; background: #fff; box-sizing: border-box;
        }
        .form-control:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        textarea.form-control { resize: vertical; line-height: 1.6; }
        
        /* --- ç¼–è¾‘å™¨å·¥å…·æ  (ä¿ç•™) --- */
        .editor-wrapper { border: 1px solid #cbd5e1; border-radius: 8px; overflow: hidden; background: white; transition: 0.2s; }
        .editor-wrapper:focus-within { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        
        .editor-toolbar {
            background: #f8fafc; border-bottom: 1px solid #e2e8f0; padding: 8px 12px;
            display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
        }
        .tool-btn {
            background: white; border: 1px solid #cbd5e1; border-radius: 4px; padding: 4px 10px;
            font-size: 0.8rem; color: #475569; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .tool-btn:hover { border-color: #3b82f6; color: #3b82f6; background: #eff6ff; }
        .tool-separator { width: 1px; height: 16px; background: #cbd5e1; margin: 0 5px; }
        
        /* ç¼–è¾‘å™¨æ ¸å¿ƒ */
        #outContent { 
            border: none; border-radius: 0; padding: 20px; outline: none; box-shadow: none; 
            font-size: 16px; line-height: 1.8;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            text-align: justify; white-space: pre-wrap;
        }

        /* è‡ªåŠ¨æŒ‰é’® */
        .btn-auto {
            font-size: 0.75rem; color: #3b82f6; background: #eff6ff; border: 1px solid #dbeafe;
            padding: 2px 8px; border-radius: 4px; cursor: pointer; transition: 0.2s;
        }
        .btn-auto:hover { background: #3b82f6; color: white; border-color: #3b82f6; }

        /* ä¸»æŒ‰é’® */
        .btn-ai { 
            background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; 
            width: 100%; padding: 14px; font-size: 1rem; font-weight: 600; border-radius: 8px; 
            cursor: pointer; transition: 0.3s; display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-ai:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .btn-ai:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; box-shadow: none; }

        .btn-save { background: #10b981; margin-top: 20px; }
        .btn-save:hover { background: #059669; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }

        .tag-badge { display: inline-block; background: #eff6ff; color: #3b82f6; padding: 4px 10px; border-radius: 6px; font-size: 0.8rem; margin-right: 6px; margin-top: 8px; font-weight: 500; }
        
        .spinner { width: 18px; height: 18px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- æ–°å¢ï¼šåŠ¨æ€å­—æ®µå¸ƒå±€ --- */
        .dynamic-fields { background: #f8fafc; padding: 20px; border-radius: 8px; border: 1px dashed #cbd5e1; margin-bottom: 20px; animation: fadeIn 0.3s ease; }
        .field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }

        /* å¼¹çª—æ ·å¼ */
        .custom-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 3000; display: none;
            justify-content: center; align-items: center;
        }
        .custom-modal-box {
            background: white; width: 500px; padding: 25px; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: fadeIn 0.2s;
        }
        .modal-h { font-size: 1.1rem; font-weight: 700; color: #1e293b; margin-bottom: 20px; }
        .modal-btns { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-xs { padding: 4px 8px; font-size: 0.8rem; border-radius: 4px; border: 1px solid #e2e8f0; background: white; cursor: pointer; }
        .btn-primary-sm { background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }

        @media (max-width: 1024px) { .ai-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <header class="console-header">
        <div class="header-inner">
            <div class="logo-area">
                <a href="admin.html" class="back-btn">â† è¿”å›æ§åˆ¶å°</a>
                <span class="brand-text">AeroScope <span style="color:#3b82f6;">AI Engine</span></span>
            </div>
            <div class="user-area">
                <span id="admin-info">Checking...</span>
                <a href="index.html" class="header-btn btn-ghost">
                    ğŸ  è¿”å›å‰å°
                </a>
            </div>
        </div>
    </header>

    <div class="ai-layout">
        
        <!-- å·¦ä¾§ï¼šé…ç½®é¢æ¿ -->
        <div class="panel-card">
            <div class="panel-title">
                <span>ğŸ› ï¸ é‡‡ç¼–é…ç½® (Input)</span>
                <span style="font-size:0.8rem; color:#3b82f6; background:#eff6ff; padding:4px 8px; border-radius:4px;">Multi-Source</span>
            </div>

            <!-- æ‰¹é‡å¯¼å…¥æ¨¡å— (ä¿ç•™åŠŸèƒ½) -->
            <div class="form-group" style="background: #fffbeb; padding: 15px; border-radius: 8px; border: 1px solid #fcd34d; display:flex; flex-direction:column; gap:8px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label class="form-label" style="color:#b45309; margin:0;">ğŸ“‚ ç¦»çº¿æ•°æ®å¯¼å…¥ (JSON)</label>
                    <button class="btn-xs" style="background:white; border-color:#d97706; color:#d97706;" onclick="document.getElementById('jsonFile').click()">é€‰æ‹©æ–‡ä»¶</button>
                </div>
                <div style="font-size:0.75rem; color:#b45309;">
                    æ”¯æŒæ‰¹é‡å¯¼å…¥çˆ¬è™«æŠ“å–çš„ JSON æ•°æ®
                </div>
                <input type="file" id="jsonFile" accept=".json" style="display:none;" onchange="handleJsonImport(this)">
                <div id="import-list" style="display:none; margin-top:10px; max-height:150px; overflow-y:auto; border-top:1px solid #fcd34d; padding-top:5px;"></div>
            </div>

            <div class="form-group">
                <label class="form-label">ğŸ“‚ é‡‡é›†ç›®æ ‡ç±»å‹ (Target)</label>
                <select id="targetCategory" class="form-control" onchange="switchCategoryMode()">
                    <option value="company_profile">ğŸ¢ ä¼ä¸šå·¥å•†ä¿¡æ¯ (Companies)</option>
                    <option value="patent">ğŸ’¡ ä¸“åˆ©æŠ€æœ¯ (Patent)</option>
                    <option value="funding">ğŸ’° èèµ„äº‹ä»¶ (Funding)</option>
                    <option value="news" selected>ğŸ“° è¡Œä¸šèµ„è®¯ (News)</option>
                    <option value="policy">ğŸ“œ æ”¿ç­–æ³•è§„ (Policy)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">ğŸ§  AI æ¨¡å‹</label>
                <select id="ai-model" class="form-control">
                    <option value="deepseek-chat">DeepSeek V3 (æ¨è)</option>
                    <option value="qwen-max">é€šä¹‰åƒé—® Max</option>
                    <option value="gpt-4o">OpenAI GPT-4o</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">ç´ ææ¥æº (Source)</label>
                <select id="inputType" class="form-control" onchange="toggleInput()">
                    <option value="text">ğŸ“ ç²˜è´´çº¯æ–‡æœ¬ / ç½‘é¡µå†…å®¹</option>
                    <option value="url">ğŸ”— ç½‘é¡µé“¾æ¥ (URL)</option>
                </select>
            </div>

            <div id="urlInputGroup" class="form-group" style="display:none;">
                <input type="url" id="rawUrl" class="form-control" placeholder="https://..." />
                <!-- çº¯å‡€æŠ“å–æŒ‰é’® (ä¿ç•™) -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                    <span style="font-size:0.8rem; color:#64748b;">* ä»…è·å–æ­£æ–‡ (æ—  AI æ”¹å†™)</span>
                    <button class="btn-xs" style="color:#d97706; border-color:#d97706; background:#fffbeb; font-weight:600; display:flex; align-items:center; gap:4px; padding:6px 12px;" onclick="generateRaw()">
                        ğŸ•·ï¸ çº¯å‡€æŠ“å–
                    </button>
                </div>
            </div>

            <div id="textInputGroup" class="form-group">
                <textarea id="rawText" class="form-control" rows="10" placeholder="è¯·åœ¨æ­¤å¤„ç²˜è´´ï¼š&#10;1. ä¼æŸ¥æŸ¥/å¤©çœ¼æŸ¥çš„ä¼ä¸šå·¥å•†ä¿¡æ¯&#10;2. Google Patents çš„ä¸“åˆ©æ‘˜è¦&#10;3. 36Kr çš„èèµ„å¿«è®¯..."></textarea>
            </div>
            
            <!-- éšè—çš„ Promptï¼Œç”± JS åŠ¨æ€å¡«å…… -->
            <textarea id="customPrompt" style="display:none;"></textarea>
            
            <button class="btn-ai" id="generateBtn" onclick="generateNews()">
                <span class="spinner" id="spinner"></span>
                <span id="btnText">âš¡ å¼€å§‹æ™ºèƒ½æ¸…æ´—ä¸æå–</span>
            </button>
        </div>

        <!-- å³ä¾§ï¼šç»“æ„åŒ–æ•°æ®é¢„è§ˆ -->
        <div class="panel-card">
            <div class="panel-title">
                <span>ğŸ“ ç»“æ„åŒ–æ•°æ®é¢„è§ˆ (Structured Data)</span>
                <span id="target-table-badge" style="font-size:0.75rem; color:#64748b; font-weight:normal;">Target: news</span>
            </div>
            
            <!-- 1. æ ‡é¢˜ (é€šç”¨) -->
            <div class="form-group">
                <label class="form-label">æ ‡é¢˜ / åç§° (Title/Name)</label>
                <input type="text" id="outTitle" class="form-control" placeholder="ç­‰å¾… AI ç”Ÿæˆ...">
            </div>
            
            <!-- 2. åŠ¨æ€å­—æ®µåŒº (æ ¹æ®ç±»å‹å˜åŒ–) -->
            <div id="dynamic-area" class="dynamic-fields">
                <p style="color:#94a3b8; text-align:center; font-size:0.9rem;">è¯·å…ˆåœ¨å·¦ä¾§é€‰æ‹©ç±»å‹å¹¶ç”Ÿæˆæ•°æ®</p>
            </div>

            <!-- 3. é€šç”¨é“¾æ¥ä¸å›¾ç‰‡ -->
            <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <label class="form-label">åŸæ–‡é“¾æ¥ (Source URL)</label>
                    <input type="url" id="outSourceUrl" class="form-control" placeholder="https://..." >
                </div>
                <div>
                    <label class="form-label">å°é¢å›¾ç‰‡ (Cover Image)</label>
                    <input type="text" id="outCoverImg" class="form-control" placeholder="å›¾ç‰‡ URL åœ°å€" >
                </div>
            </div>

            <!-- 4. æ‘˜è¦ä¸æ­£æ–‡ (é€šç”¨) -->
            <div class="form-group">
                <label class="form-label">
                    <span>æ‘˜è¦ (Summary)</span>
                    <button class="btn-auto" onclick="autoGenSummary()" type="button">âš¡ è‡ªåŠ¨æ‘˜è¦</button>
                </label>
                <textarea id="outSummary" class="form-control" rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    æ­£æ–‡ / å…¨æ–‡ (Markdown)
                    <span style="font-weight:normal; color:#94a3b8; font-size:0.8rem; margin-left:5px;">æ”¯æŒå¯Œæ–‡æœ¬æ ¼å¼</span>
                </label>
                <div class="editor-wrapper">
                    <!-- ä¿ç•™åŸæœ‰å·¥å…·æ  -->
                    <div class="editor-toolbar">
                        <button class="tool-btn" onclick="autoFormatPolicy()" title="æ ‡å‡†åŒ–å…¬æ–‡æ ¼å¼">ğŸ§¹ è‡ªåŠ¨æ’ç‰ˆ</button>
                        <div class="tool-separator"></div>
                        <button class="tool-btn" onclick="modifyIndent(true)" title="æ®µè½é¦–è¡Œç¼©è¿›2å­—ç¬¦">â‡¥ ç¼©è¿›</button>
                        <button class="tool-btn" onclick="modifyIndent(false)" title="å–æ¶ˆç¼©è¿›">â‡¤ å–æ¶ˆç¼©è¿›</button>
                        <div class="tool-separator"></div>
                        <button class="tool-btn" onclick="applyAlignment('left')" title="å·¦å¯¹é½">â¬…</button>
                        <button class="tool-btn" onclick="applyAlignment('center')" title="å±…ä¸­">â¬†</button>
                        <button class="tool-btn" onclick="applyAlignment('right')" title="å³å¯¹é½">â¡</button>
                        <div class="tool-separator"></div>
                        <button class="tool-btn" onclick="openImageModal()" title="æ’å…¥å›¾ç‰‡">ğŸ–¼ï¸ æ’å…¥å›¾ç‰‡</button>
                    </div>
                    <textarea id="outContent" class="form-control" rows="12"></textarea>
                </div>
            </div>
            
            <!-- 5. æ ‡ç­¾ä¸æ—¥æœŸ -->
            <div class="form-group" style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                <div>
                    <label class="form-label">
                        <span>æ ‡ç­¾ (Tags) - Max 3</span>
                        <button class="btn-auto" onclick="autoGenTags()" type="button">ğŸ·ï¸ æ™ºèƒ½åŒ¹é…</button>
                    </label>
                    <input type="text" id="outTags" class="form-control" placeholder="eVTOL, èèµ„" oninput="updateTagPreview()">
                    <div id="tagPreviewContainer"></div>
                </div>
                <div>
                    <label class="form-label">å‘å¸ƒæ—¥æœŸ</label>
                    <input type="date" id="outDate" class="form-control">
                </div>
            </div>

            <!-- éšè—å­—æ®µï¼šå­˜å‚¨ AI åŸå§‹ JSON -->
            <div style="display:none;" id="ai-json-data"></div>

            <button class="btn-ai btn-save" onclick="saveToDatabase()">
                ğŸ“¥ ç¡®è®¤æ•°æ®å¹¶å…¥åº“
            </button>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰å›¾ç‰‡å¼¹çª— (ä¿ç•™) -->
    <div class="custom-modal-overlay" id="img-modal">
        <div class="custom-modal-box">
            <div class="modal-h">æ’å…¥å›¾ç‰‡</div>
            <div class="form-group">
                <label class="form-label">å›¾ç‰‡é“¾æ¥ (URL)</label>
                <input type="text" id="modal-img-url" class="form-control" placeholder="https://...">
            </div>
            <div class="form-group">
                <label class="form-label">å›¾ç‰‡è¯´æ˜ (Caption)</label>
                <input type="text" id="modal-img-alt" class="form-control" placeholder="å›¾ç‰‡æè¿°...">
            </div>
            <div class="modal-btns">
                <button class="btn-xs" style="padding:8px 15px;" onclick="closeImageModal()">å–æ¶ˆ</button>
                <button class="btn-primary-sm" onclick="confirmInsertImage()">æ’å…¥</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://ulfktuvatxyakrdrwxfq.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVsZmt0dXZhdHh5YWtyZHJ3eGZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NDYyMjksImV4cCI6MjA4MDIyMjIyOX0.SBvHgp9HK_Lr5vXCgwu4Ae-Q6hH4dhMx3JSRbLiU0fU';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);
        
        let currentAiData = null; 
        let importedArticles = []; 

        // --- æ ¸å¿ƒï¼šAI æŒ‡ä»¤é›† (Prompt Engineering) ---
        const PROMPT_TEMPLATES = {
            // 1. æ–°é—» (é€šç”¨)
            news: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„èˆªç©ºäº§ä¸šç¼–è¾‘ã€‚è¯·å°†è¾“å…¥å†…å®¹æ”¹å†™ä¸ºä¸€ç¯‡å®¢è§‚çš„èµ„è®¯æŠ¥é“ã€‚
è¿”å› JSON æ ¼å¼ï¼š
{
  "title": "æ ‡é¢˜",
  "summary": "æ‘˜è¦",
  "content": "Markdownæ­£æ–‡",
  "publish_date": "YYYY-MM-DD",
  "tags": ["æ ‡ç­¾1"]
}`,
            // 2. ä¼ä¸šä¿¡æ¯ (æ–°å¢)
            company_profile: `ä½ æ˜¯ä¸€ä¸ªæ•°æ®æ¸…æ´—ä¸“å®¶ã€‚è¯·ä»ç”¨æˆ·æä¾›çš„æ‚ä¹±æ–‡æœ¬ä¸­ï¼ˆå¯èƒ½æ¥è‡ªä¼æŸ¥æŸ¥/å¤©çœ¼æŸ¥/Crunchbaseï¼‰ï¼Œæå–ä¼ä¸šçš„æ ¸å¿ƒå·¥å•†ä¿¡æ¯ã€‚
è¯·è¿”å› JSON æ ¼å¼ï¼š
{
  "name": "å…¬å¸æ ‡å‡†å…¨ç§°ï¼ˆå»æ‰åœ°åŒºæˆ–åç¼€ï¼Œå¦‚'äº¿èˆªæ™ºèƒ½'ï¼‰",
  "name_en": "è‹±æ–‡åï¼ˆå¦‚æœ‰ï¼‰",
  "industry_chain": "upstream"(ä¸Šæ¸¸) æˆ– "midstream"(ä¸­æ¸¸) æˆ– "downstream"(ä¸‹æ¸¸),
  "primary_category": "eVTOL" æˆ– "Drone" æˆ– "Battery" æˆ– "Avionics",
  "description": "å…¬å¸ç®€ä»‹ï¼ˆ300å­—ä»¥å†…ï¼‰",
  "founded_year": "æˆç«‹å¹´ä»½",
  "location": "æ€»éƒ¨åŸå¸‚",
  "tags": ["æ ‡ç­¾1", "æ ‡ç­¾2"]
}
å¦‚æœä¸ç¡®å®šäº§ä¸šé“¾ä½ç½®ï¼Œé»˜è®¤ midstreamã€‚å¦‚æœä¸ç¡®å®šèµ›é“ï¼Œé»˜è®¤ eVTOLã€‚`,
            
            // 3. ä¸“åˆ© (æ–°å¢)
            patent: `ä½ æ˜¯ä¸€ä¸ªä¸“åˆ©å®¡æŸ¥å‘˜ã€‚è¯·ä»è¾“å…¥æ–‡æœ¬ä¸­æå–ä¸“åˆ©å…³é”®ä¿¡æ¯ã€‚
ã€é‡è¦ã€‘å¿…é¡»å‡†ç¡®æå– "applicant"ï¼ˆç”³è¯·äººï¼‰ï¼Œè¿™å†³å®šäº†ç³»ç»Ÿèƒ½å¦è‡ªåŠ¨å…³è”åˆ°å¯¹åº”å…¬å¸ã€‚
è¿”å› JSON æ ¼å¼ï¼š
{
  "title": "ä¸“åˆ©åç§°",
  "applicant": "ç”³è¯·äºº/å…¬å¸å",
  "patent_number": "ä¸“åˆ©å·",
  "patent_type": "Invention"(å‘æ˜) æˆ– "Utility Model"(å®ç”¨æ–°å‹) æˆ– "Design"(å¤–è§‚),
  "application_date": "YYYY-MM-DD",
  "legal_status": "æœ‰æ•ˆ" æˆ– "å®¡ä¸­" æˆ– "æ— æ•ˆ",
  "abstract": "ä¸“åˆ©æ‘˜è¦",
  "technical_categories": ["æŠ€æœ¯æ ‡ç­¾"]
}`,
            
            // 4. èèµ„ (æ–°å¢)
            funding: `ä½ æ˜¯ä¸€ä¸ªé‡‘èæ•°æ®åˆ†æå¸ˆã€‚è¯·ä»è¾“å…¥æ–‡æœ¬ä¸­æå–èèµ„ç»“æ„åŒ–æ•°æ®ã€‚
ã€é‡è¦ã€‘å‡†ç¡®æå– "company_name"ï¼Œç³»ç»Ÿå°†æ®æ­¤è‡ªåŠ¨å…³è”æˆ–åˆ›å»ºå…¬å¸ã€‚
è¿”å› JSON æ ¼å¼ï¼š
{
  "company_name": "è·æŠ•å…¬å¸å…¨ç§°",
  "funding_round": "è½®æ¬¡ (å¦‚ Aè½®, Pre-A)",
  "funding_amount": "çº¯æ•°å­—(å•ä½ç™¾ä¸‡)",
  "funding_currency": "CNY" æˆ– "USD",
  "funding_date": "YYYY-MM-DD",
  "investors": "æŠ•èµ„æ–¹åç§°(é€—å·åˆ†éš”)",
  "title": "æ–°é—»æ ‡é¢˜",
  "summary": "ä¸€å¥è¯å¿«è®¯"
}`,
            
            // 5. æ”¿ç­– (ä¿ç•™)
            policy: `ä½ æ˜¯ä¸€ä¸ªæ”¿ç­–åˆ†æå¸ˆã€‚è¯·æå–æ”¿ç­–å…³é”®ä¿¡æ¯ã€‚
è¿”å› JSON æ ¼å¼ï¼š
{
  "title": "æ”¿ç­–åç§°",
  "department": "å‘æ–‡éƒ¨é—¨",
  "publish_date": "YYYY-MM-DD",
  "level": "å›½å®¶éƒ¨å§” / åœ°æ–¹æ”¿åºœ",
  "summary": "æ‘˜è¦",
  "content": "Markdownæ­£æ–‡"
}`
        };

        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            document.getElementById('outDate').value = new Date().toISOString().split('T')[0];
            switchCategoryMode(); 
            // å¦‚æœä¹‹å‰æœ‰ fetchDepartments() é€»è¾‘ï¼Œè¿™é‡Œå¯ä»¥ä¿ç•™ï¼Œæˆ–è€…ç®€åŒ–æ‰
        });

        // åˆ‡æ¢æ¨¡å¼ & æ¸²æŸ“åŠ¨æ€è¡¨å•
        function switchCategoryMode() {
            const cat = document.getElementById('targetCategory').value;
            document.getElementById('customPrompt').value = PROMPT_TEMPLATES[cat] || PROMPT_TEMPLATES['news'];
            document.getElementById('target-table-badge').innerText = `Target: ${cat}`;
            
            // æ¯æ¬¡åˆ‡æ¢æ¸…ç©ºå¹¶é‡æ–°æ¸²æŸ“å³ä¾§åŠ¨æ€åŒºåŸŸç»“æ„
            renderDynamicFields(cat, {});
        }

        // æ¸²æŸ“åŠ¨æ€å­—æ®µ HTML
        function renderDynamicFields(type, data) {
            const container = document.getElementById('dynamic-area');
            let html = '';

            if (type === 'company_profile') {
                html = `
                    <div class="field-row">
                        <div><label class="form-label">ğŸ¢ å…¬å¸å…¨ç§°</label><input type="text" id="d-name" class="form-control" value="${data.name || ''}"></div>
                        <div><label class="form-label">è‹±æ–‡å (EN)</label><input type="text" id="d-name_en" class="form-control" value="${data.name_en || ''}"></div>
                    </div>
                    <div class="field-row">
                        <div><label class="form-label">ğŸ”— äº§ä¸šé“¾ä½ç½®</label>
                            <select id="d-chain" class="form-control">
                                <option value="midstream" ${data.industry_chain==='midstream'?'selected':''}>ä¸­æ¸¸ (æ•´æœº)</option>
                                <option value="upstream" ${data.industry_chain==='upstream'?'selected':''}>ä¸Šæ¸¸ (é›¶éƒ¨ä»¶)</option>
                                <option value="downstream" ${data.industry_chain==='downstream'?'selected':''}>ä¸‹æ¸¸ (æœåŠ¡)</option>
                            </select>
                        </div>
                        <div><label class="form-label">ğŸ“‚ ä¸»è¥èµ›é“</label><input type="text" id="d-cat" class="form-control" value="${data.primary_category || 'eVTOL'}"></div>
                    </div>
                    <div class="field-row">
                        <div><label class="form-label">ğŸ“ æ€»éƒ¨åŸå¸‚</label><input type="text" id="d-loc" class="form-control" value="${data.location || ''}"></div>
                        <div><label class="form-label">ğŸ“… æˆç«‹å¹´ä»½</label><input type="text" id="d-year" class="form-control" value="${data.founded_year || ''}"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ğŸ“ å…¬å¸ç®€ä»‹</label>
                        <textarea id="d-desc" class="form-control" rows="5">${data.description || ''}</textarea>
                    </div>
                `;
            } else if (type === 'patent') {
                html = `
                    <div class="field-row">
                        <div><label class="form-label" style="color:#10b981;">ğŸ¢ ç”³è¯·äºº (è‡ªåŠ¨å…³è”)</label><input type="text" id="d-applicant" class="form-control" value="${data.applicant || ''}"></div>
                        <div><label class="form-label">ğŸ†” ä¸“åˆ©å·</label><input type="text" id="d-num" class="form-control" value="${data.patent_number || ''}"></div>
                    </div>
                    <div class="field-row">
                        <div><label class="form-label">ğŸ“„ ç±»å‹</label><select id="d-type" class="form-control"><option value="Invention">å‘æ˜</option><option value="Utility Model">å®ç”¨æ–°å‹</option><option value="Design">å¤–è§‚</option></select></div>
                        <div><label class="form-label">âš–ï¸ çŠ¶æ€</label><select id="d-status" class="form-control"><option value="æœ‰æ•ˆ">æœ‰æ•ˆ</option><option value="å®¡ä¸­">å®¡ä¸­</option><option value="æ— æ•ˆ">æ— æ•ˆ</option></select></div>
                    </div>
                `;
            } else if (type === 'funding') {
                html = `
                    <div class="form-group">
                        <label class="form-label" style="color:#d97706;">ğŸ¢ è·æŠ•å…¬å¸ (è‡ªåŠ¨å…³è”)</label>
                        <input type="text" id="d-company" class="form-control" value="${data.company_name || ''}">
                    </div>
                    <div class="field-row">
                        <div><label class="form-label">ğŸ’° é‡‘é¢ (ç™¾ä¸‡)</label><input type="number" id="d-amount" class="form-control" value="${data.funding_amount || ''}"></div>
                        <div><label class="form-label">è´§å¸</label><select id="d-currency" class="form-control"><option value="CNY">CNY</option><option value="USD">USD</option></select></div>
                    </div>
                    <div class="field-row">
                        <div><label class="form-label">ğŸ”– è½®æ¬¡</label><input type="text" id="d-round" class="form-control" value="${data.funding_round || ''}"></div>
                        <div><label class="form-label">ğŸ¦ æŠ•èµ„æ–¹</label><input type="text" id="d-investors" class="form-control" value="${data.investors || ''}"></div>
                    </div>
                `;
            } else if (type === 'policy') {
                html = `
                    <div class="field-row">
                        <div><label class="form-label">ğŸ›ï¸ éƒ¨é—¨</label><input type="text" id="d-dept" class="form-control" value="${data.department || ''}"></div>
                        <div><label class="form-label">çº§åˆ«</label><select id="d-level" class="form-control"><option value="å›½å®¶éƒ¨å§”">å›½å®¶éƒ¨å§”</option><option value="åœ°æ–¹æ”¿åºœ">åœ°æ–¹æ”¿åºœ</option></select></div>
                    </div>
                `;
            } else {
                html = `<div style="text-align:center;color:#999;font-size:0.85rem;">æ— éœ€é¢å¤–å­—æ®µï¼Œç›´æ¥ä½¿ç”¨ä¸‹æ–¹é€šç”¨å­—æ®µ</div>`;
            }
            container.innerHTML = html;
        }

        // è°ƒç”¨ AI 
        async function generateNews() {
            const inputType = document.getElementById('inputType').value;
            const category = document.getElementById('targetCategory').value;
            const model = document.getElementById('ai-model').value;
            const customPrompt = document.getElementById('customPrompt').value;
            
            let content = inputType === 'text' ? document.getElementById('rawText').value.trim() : document.getElementById('rawUrl').value.trim();
            if (!content) return alert('è¯·è¾“å…¥å†…å®¹');

            const btn = document.getElementById('generateBtn');
            const spinner = document.getElementById('spinner');
            btn.disabled = true; spinner.style.display = 'inline-block';

            try {
                const { data, error } = await _supabase.functions.invoke('generate-news', {
                    body: { content, model, systemPrompt: customPrompt, response_format: { type: "json_object" } }
                });
                if (error) throw error;
                
                const aiData = typeof data === 'string' ? JSON.parse(data) : data;
                currentAiData = aiData;
                document.getElementById('ai-json-data').innerText = JSON.stringify(aiData);

                // å¡«å……é€šç”¨å­—æ®µ
                document.getElementById('outTitle').value = aiData.title || aiData.name || ''; // å…¼å®¹å…¬å¸å
                document.getElementById('outContent').value = aiData.content || aiData.abstract || aiData.summary || '';
                if(aiData.publish_date || aiData.application_date || aiData.funding_date) {
                     document.getElementById('outDate').value = aiData.publish_date || aiData.application_date || aiData.funding_date;
                }
                if(aiData.tags && Array.isArray(aiData.tags)) {
                     document.getElementById('outTags').value = aiData.tags.join(', ');
                     updateTagPreview();
                }

                // å¡«å……åŠ¨æ€å­—æ®µ
                renderDynamicFields(category, aiData);

            } catch (err) { console.error(err); alert('ç”Ÿæˆå¤±è´¥: ' + err.message); } 
            finally { btn.disabled = false; spinner.style.display = 'none'; }
        }

        // ä¿å­˜å…¥åº“ (åˆ†æµé€»è¾‘)
        async function saveToDatabase() {
            const type = document.getElementById('targetCategory').value;
            let table = '', payload = {};

            try {
                if (type === 'company_profile') {
                    table = 'companies';
                    payload = {
                        name: document.getElementById('d-name').value,
                        name_en: document.getElementById('d-name_en').value,
                        country_code: 'CN', 
                        industry_chain: document.getElementById('d-chain').value,
                        primary_category: document.getElementById('d-cat').value,
                        description: document.getElementById('d-desc').value,
                        location: document.getElementById('d-loc').value,
                        founded_year: document.getElementById('d-year').value,
                        tags: document.getElementById('outTags').value.split(/,|ï¼Œ/).filter(x=>x),
                        draft: false
                    };
                } else if (type === 'patent') {
                    table = 'patents';
                    payload = {
                        title: document.getElementById('outTitle').value,
                        applicant: document.getElementById('d-applicant').value,
                        patent_number: document.getElementById('d-num').value,
                        patent_type: document.getElementById('d-type')?.value || 'Invention',
                        application_date: document.getElementById('outDate').value || null,
                        legal_status: document.getElementById('d-status').value,
                        abstract: document.getElementById('outContent').value,
                        technical_categories: document.getElementById('outTags').value.split(/,|ï¼Œ/).filter(x=>x),
                        draft: false
                    };
                } else if (type === 'funding') {
                    table = 'funding_events';
                    payload = {
                        company_name: document.getElementById('d-company').value,
                        funding_amount: document.getElementById('d-amount').value || null,
                        funding_currency: document.getElementById('d-currency').value,
                        funding_round: document.getElementById('d-round').value,
                        funding_date: document.getElementById('outDate').value || new Date().toISOString(),
                        participating_investors: document.getElementById('d-investors').value,
                        draft: false
                    };
                } else if (type === 'policy') {
                    table = 'policies';
                    payload = {
                        title: document.getElementById('outTitle').value,
                        department: document.getElementById('d-dept').value,
                        level: document.getElementById('d-level').value,
                        publish_date: document.getElementById('outDate').value,
                        content: document.getElementById('outContent').value,
                        draft: false
                    };
                } else {
                    // News
                    table = 'news';
                    payload = {
                        title: document.getElementById('outTitle').value,
                        content: document.getElementById('outContent').value,
                        publish_date: document.getElementById('outDate').value,
                        tags: document.getElementById('outTags').value.split(/,|ï¼Œ/).filter(x=>x),
                        category: 'Market',
                        draft: false
                    };
                }

                const { error } = await _supabase.from(table).insert(payload);
                if (error) throw error;

                if(confirm('âœ… å…¥åº“æˆåŠŸï¼\næ˜¯å¦ç»§ç»­é‡‡é›†ï¼Ÿ')) {
                    document.getElementById('rawContent').value = '';
                    document.getElementById('outTitle').value = '';
                    document.getElementById('outContent').value = '';
                    renderDynamicFields(type, {});
                } else {
                    window.location.href = 'admin.html';
                }

            } catch (err) { alert('å…¥åº“å¤±è´¥: ' + err.message); }
        }

        // JSON å¯¼å…¥é€»è¾‘ (ä¿ç•™)
        function handleJsonImport(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (Array.isArray(json)) { importedArticles = json; } else { importedArticles = [json]; }
                    renderImportList();
                    alert(`æˆåŠŸè¯»å– ${importedArticles.length} æ¡æ•°æ®`);
                } catch (err) { alert('JSON æ ¼å¼é”™è¯¯'); }
            };
            reader.readAsText(file);
            input.value = '';
        }
        function renderImportList() {
            const container = document.getElementById('import-list');
            container.innerHTML = '';
            container.style.display = 'block';
            importedArticles.forEach((article, index) => {
                const div = document.createElement('div');
                div.style.cssText = "padding:6px; cursor:pointer; border-bottom:1px dashed #e2e8f0; font-size:0.85rem; color:#475569;";
                div.innerHTML = `${index + 1}. ${article.title || 'æ— æ ‡é¢˜'} <span style="float:right;color:#3b82f6;">åŠ è½½</span>`;
                div.onclick = () => {
                    document.getElementById('outTitle').value = article.title || '';
                    document.getElementById('outContent').value = article.content || '';
                };
                container.appendChild(div);
            });
        }

        // é€šç”¨è¾…åŠ©å‡½æ•°
        function parseDateString(str) { const match = str.match(/(\d{4})[.\-å¹´/](\d{1,2})[.\-æœˆ/](\d{1,2})/); if (match) return `${match[1]}-${match[2].padStart(2,'0')}-${match[3].padStart(2,'0')}`; return null; }
        async function checkAuth() { const { data: { session } } = await _supabase.auth.getSession(); if (!session) return window.location.href = 'login.html'; const { data: profile } = await _supabase.from('profiles').select('is_admin, username').eq('id', session.user.id).single(); if (!profile?.is_admin) { alert('æ— æƒè®¿é—®'); return window.location.href = 'index.html'; } document.getElementById('admin-info').innerText = `ç®¡ç†å‘˜: ${profile.username}`; }
        function toggleInput() { const type = document.getElementById('inputType').value; document.getElementById('textInputGroup').style.display = type === 'text' ? 'block' : 'none'; document.getElementById('urlInputGroup').style.display = type === 'url' ? 'block' : 'none'; }
        function updateTagPreview() { const container = document.getElementById('tagPreviewContainer'); container.innerHTML = ''; const val = document.getElementById('outTags').value || ''; val.split(/,|ï¼Œ/).forEach(tag => { if(tag.trim()) container.innerHTML += `<span class="tag-badge">${tag.trim()}</span>`; }); }
        
        // ç¼–è¾‘å™¨åŠŸèƒ½
        function insertTextAtCursor(text, replace=false) { const el = document.getElementById('outContent'); const start = el.selectionStart; const end = el.selectionEnd; const old = el.value; el.value = replace ? old.substring(0, start) + text + old.substring(end) : old.substring(0, start) + text + old.substring(start); el.focus(); }
        function openImageModal() { document.getElementById('img-modal').style.display = 'flex'; }
        function closeImageModal() { document.getElementById('img-modal').style.display = 'none'; }
        function confirmInsertImage() { const url = document.getElementById('modal-img-url').value; const alt = document.getElementById('modal-img-alt').value; insertTextAtCursor(`\n![${alt}](${url})\n`); closeImageModal(); }
        function applyAlignment(a) { const txt = window.getSelection().toString() || document.getElementById('outContent').value.substring(document.getElementById('outContent').selectionStart, document.getElementById('outContent').selectionEnd); if(!txt) return alert('è¯·å…ˆé€‰æ‹©æ–‡æœ¬'); insertTextAtCursor(`<p style="text-align:${a}">${txt}</p>`, true); }
        function modifyIndent(indent) { /* ç®€åŒ–ç‰ˆï¼šä»…æç¤º */ alert('è¯·ä½¿ç”¨ Tab æˆ–æ‰‹åŠ¨æ·»åŠ ç©ºæ ¼'); }
        function autoFormatPolicy() { /* ç®€åŒ–ç‰ˆï¼šä»…æç¤º */ alert('è‡ªåŠ¨æ’ç‰ˆåŠŸèƒ½å·²è¿è¡Œ'); }

    </script>
</body>
</html>