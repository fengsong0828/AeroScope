<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½ç©ºç»æµè¯•ç‚¹åŸå¸‚åˆ†å¸ƒ | AeroScope Insight</title>
    <link rel="stylesheet" href="style.css">
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* å¤ç”¨ç»„ä»¶æ ·å¼ */
        .search-component { position: relative; margin-right: 15px; }
        .search-box { display: flex; align-items: center; border: 1px solid #cbd5e1; border-radius: 20px; background: white; padding: 5px 12px; transition: 0.3s; }
        .search-box:focus-within { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .search-icon { font-size: 1rem; color: #64748b; margin-right: 8px; }
        .search-input { border: none; outline: none; font-size: 0.9rem; width: 160px; color: #1e293b; }
        #search-dropdown { position: absolute; top: 45px; right: 0; width: 280px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 2000; display: none; max-height: 400px; overflow-y: auto; }
        .search-result-item { display: block; padding: 12px; border-bottom: 1px solid #f1f5f9; text-decoration: none; color: #1e293b; transition: 0.2s; }
        .search-result-item:hover { background: #f8fafc; }

        /* é¡µè„šæ ·å¼ */
        .footer-grid { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 40px; padding-bottom: 40px; }
        .footer-col h4 { color: white; margin-bottom: 20px; font-size: 1rem; font-weight: 600; }
        .footer-col ul li { margin-bottom: 12px; }
        .footer-col a { color: #94a3b8; font-size: 0.9rem; transition: color 0.2s; }
        .footer-col a:hover { color: #3b82f6; }
        .social-icons { display: flex; gap: 15px; margin-top: 20px; }
        .social-btn { width: 36px; height: 36px; background: #334155; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; transition: 0.3s; }
        .social-btn:hover { background: #3b82f6; transform: translateY(-2px); }

        /* å¼¹çª—æ ·å¼å¾®è°ƒ */
        .modal-box { max-width: 600px; }
        .city-policy-item { padding: 10px 0; border-bottom: 1px dashed #eee; display:flex; justify-content:space-between; align-items:center; }
        .city-policy-item:last-child { border-bottom: none; }
        .city-policy-item a { color: #1e293b; text-decoration: none; font-size: 0.95rem; }
        .city-policy-item a:hover { color: #3b82f6; }
        .policy-date { font-size: 0.8rem; color: #94a3b8; }

        @media (max-width: 768px) {
            .footer-grid { grid-template-columns: 1fr; text-align: center; }
            .social-icons { justify-content: center; }
            .search-component { display: none; }
        }
    </style>
</head>
<body>

    <!-- 1. Header (ä¸ Index ä¸€è‡´) -->
    <header>
        <div class="standard-container">
            <div class="nav-inner">
                <a href="index.html" class="logo">AeroScope<span>Insight</span></a>
                <button class="mobile-menu-btn" onclick="toggleMenu()">â˜°</button>
                <nav class="nav-links" id="navMenu">
                    <a href="index.html">é¦–é¡µ</a>
                    <a href="news.html">èµ„è®¯å¿«æŠ¥</a>
                    <a href="policies.html">æ”¿ç­–æ³•è§„</a>
                    <a href="tech.html">æŠ€æœ¯å‰æ²¿</a>
                    <a href="companies.html">å…¬å¸æ•°æ®åº“</a>
                    <a href="forum.html">è®ºå›äº¤æµ</a>
                </nav>
                <div class="header-actions">
                    <div class="search-component">
                        <div class="search-box"><span class="search-icon">ğŸ”</span><input type="text" class="search-input" placeholder="æœå…¬å¸ã€æ”¿ç­–..." id="global-search" onkeyup="performGlobalSearch(this.value)"></div>
                        <div id="search-dropdown"></div>
                    </div>
                    <button class="btn btn-primary" id="auth-btn" onclick="location.href='login.html'">ç™»å½•/æ³¨å†Œ</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Page Hero -->
    <section class="page-hero">
        <div class="standard-container">
            <h1>å…¨å›½ä½ç©ºç»æµè¯•ç‚¹åŸå¸‚åˆ†å¸ƒå›¾</h1>
            <p>åŸºäºæ”¿ç­–æ³•è§„åº“å®æ—¶ç›‘æ§å„çœå¸‚å¼€æ”¾çƒ­åº¦</p>
        </div>
    </section>

    <!-- åœ°å›¾å®¹å™¨ -->
    <div class="standard-container">
        <div id="map-container" style="width: 100%; height: 700px; margin-bottom: 60px; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0; background: #f8fafc;"></div>
    </div>

    <!-- è¯¦æƒ…å¼¹çª— -->
    <div class="modal-overlay" id="info-modal">
        <div class="modal-box">
            <div class="modal-close" onclick="closeModal()">Ã—</div>
            <div class="modal-title" id="m-title">åŸå¸‚è¯¦æƒ…</div>
            <div class="modal-content" id="m-content" style="max-height: 400px; overflow-y: auto;"></div>
            <div class="modal-meta" id="m-meta" style="margin-top:15px; padding-top:10px; border-top:1px solid #eee; color:#64748b; font-size:0.85rem;"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="standard-container">
            <div class="footer-grid">
                <div class="footer-col brand-col">
                    <h4>AeroScope Insight</h4>
                    <p style="font-size:0.9rem; color:#94a3b8; line-height: 1.6; margin-bottom: 20px;">è¿æ¥æ”¿ç­–ã€èµ„æœ¬ä¸æŠ€æœ¯ï¼Œæ‰“é€ ä½ç©ºç»æµé¢†åŸŸçš„æ•°å­—åŒ–åŸºç¡€è®¾æ–½ä¸å†³ç­–å¼•æ“ã€‚</p>
                    <div class="social-icons">
                        <a href="#" class="social-btn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></a>
                        <a href="#" class="social-btn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a>
                        <a href="mailto:contact@aeroscope.cn" class="social-btn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a>
                    </div>
                </div>
                <div class="footer-col"><h4>æ ¸å¿ƒæ¿å—</h4><ul><li><a href="news.html">èµ„è®¯å¿«æŠ¥</a></li><li><a href="policies.html">æ”¿ç­–æ³•è§„</a></li><li><a href="companies.html">ä¼ä¸šæ•°æ®åº“</a></li></ul></div>
                <div class="footer-col"><h4>æ•°æ®å›¾è°±</h4><ul><li><a href="chart-funding.html">å…¨çƒèèµ„è¶‹åŠ¿</a></li><li><a href="chart-cities.html">è¯•ç‚¹åŸå¸‚åˆ†å¸ƒ</a></li><li><a href="chart-companies.html">äº§ä¸šé“¾å…¨æ™¯å›¾</a></li></ul></div>
                
                <div class="footer-col">
                    <h4>å…³äº</h4>
                    <ul>
                        <li><a href="about.html">å›¢é˜Ÿæ„¿æ™¯</a></li>
                        <li><a href="submit-report.html">å¯»æ±‚æŠ¥é“</a></li>
                        <li><a href="contact.html">å•†åŠ¡åˆä½œ</a></li>
                    </ul>
                </div>
            </div>
            <div class="copyright" style="border-top:1px solid #334155; padding-top:20px; margin-top:20px; text-align:center; color:#64748b; font-size:0.85rem;">&copy; 2025 AeroScope Insight. All rights reserved.</div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ================= é…ç½® =================
        const supabaseUrl = 'https://ulfktuvatxyakrdrwxfq.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVsZmt0dXZhdHh5YWtyZHJ3eGZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NDYyMjksImV4cCI6MjA4MDIyMjIyOX0.SBvHgp9HK_Lr5vXCgwu4Ae-Q6hH4dhMx3JSRbLiU0fU';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // é¢„å®šä¹‰æ ¸å¿ƒåŸå¸‚åæ ‡ (ä½œä¸ºæ•°æ®èšåˆçš„é”šç‚¹)
        const cityCoordinates = {
            'åŒ—äº¬': [116.407526, 39.904030],
            'ä¸Šæµ·': [121.473701, 31.230416],
            'å¹¿å·': [113.264385, 23.129112],
            'æ·±åœ³': [114.057868, 22.543099],
            'æˆéƒ½': [104.066541, 30.572269],
            'åˆè‚¥': [117.227239, 31.820586],
            'é•¿æ²™': [112.938814, 28.228209],
            'æ­¦æ±‰': [114.305393, 30.593099],
            'å—äº¬': [118.796877, 32.060255],
            'æ­å·': [120.15507, 30.274085],
            'è‹å·': [120.585315, 31.298886],
            'è¥¿å®‰': [108.93977, 34.341574],
            'é‡åº†': [106.551556, 29.56301]
        };

        // å­˜å‚¨èšåˆåçš„æ•°æ®
        let mapData = [];

        document.addEventListener('DOMContentLoaded', async function() {
            checkUserLogin();
            await initMapData();
            initChart();
        });

        // 1. ä» Policies è¡¨æ‹‰å–æ•°æ®å¹¶èšåˆ
        async function initMapData() {
            // æ‹‰å–æ‰€æœ‰å·²å‘å¸ƒæ”¿ç­–
            const { data: policies, error } = await _supabase
                .from('policies')
                .select('id, title, department, publish_date')
                .eq('draft', false);

            if (error || !policies) return;

            // ä¸´æ—¶å¯¹è±¡å­˜å‚¨ç»Ÿè®¡ç»“æœ
            // ç»“æ„: { 'æ·±åœ³': { count: 0, policies: [] } }
            let cityStats = {};

            // åˆå§‹åŒ–
            for (let city in cityCoordinates) {
                cityStats[city] = { count: 0, policies: [] };
            }

            // éå†æ”¿ç­–ï¼Œæ ¹æ®æ ‡é¢˜æˆ–éƒ¨é—¨å…³é”®è¯åŒ¹é…åŸå¸‚
            policies.forEach(p => {
                const text = (p.title + p.department).toLowerCase();
                for (let city in cityCoordinates) {
                    if (text.includes(city)) {
                        cityStats[city].count++;
                        cityStats[city].policies.push(p);
                        // ä¸€æ¡æ”¿ç­–å¯èƒ½å½’å±å¤šä¸ª(æå°‘æƒ…å†µ)ï¼Œè¿™é‡Œç®€åŒ–ä¸ºåŒ¹é…åˆ°å³ç®—
                        // å¯ä»¥åŠ  break é˜²æ­¢é‡å¤è®¡æ•°ï¼Œä½†æœ‰äº›æ”¿ç­–æ˜¯"äº¬æ²ª"è”åˆï¼Œç®—ä¸¤æ¬¡ä¹Ÿæ— å¦¨
                    }
                }
            });

            // è½¬æ¢ä¸º ECharts éœ€è¦çš„æ ¼å¼
            mapData = [];
            for (let city in cityStats) {
                if (cityStats[city].count > 0) {
                    mapData.push({
                        name: city,
                        value: [...cityCoordinates[city], cityStats[city].count * 10], // value[2]æ˜¯å¤§å°æƒé‡ï¼Œä¹˜ä»¥10è®©åœˆåœˆæ˜æ˜¾ç‚¹
                        rawCount: cityStats[city].count,
                        policies: cityStats[city].policies
                    });
                }
            }
        }

        // 2. åˆå§‹åŒ–åœ°å›¾
        function initChart() {
            var myChart = echarts.init(document.getElementById('map-container'));
            myChart.showLoading({ color: '#3b82f6', maskColor: 'rgba(255, 255, 255, 0.8)' });

            fetch('./china.json')
                .then(response => response.json())
                .then(geoJson => {
                    myChart.hideLoading();
                    echarts.registerMap('china', geoJson);

                    var option = {
                        backgroundColor: '#f8fafc',
                        tooltip: {
                            trigger: 'item',
                            formatter: function(params) {
                                return `${params.name}<br/>å…³è”æ”¿ç­–: <b>${params.data.rawCount}</b> æ¡`;
                            }
                        },
                        geo: {
                            map: 'china',
                            roam: false, // ç¦æ­¢ç¼©æ”¾
                            center: [105, 36], 
                            zoom: 1.6,
                            label: { emphasis: { show: false } },
                            itemStyle: {
                                normal: {
                                    areaColor: '#e2e8f0', // é™†åœ°é¢œè‰²
                                    borderColor: '#fff',  // çœç•Œé¢œè‰²
                                    borderWidth: 1
                                },
                                emphasis: {
                                    areaColor: '#cbd5e1' // æ‚¬åœé¢œè‰²
                                }
                            }
                        },
                        series: [
                            {
                                name: 'è¯•ç‚¹åŸå¸‚',
                                type: 'effectScatter',
                                coordinateSystem: 'geo',
                                data: mapData,
                                symbolSize: function (val) { 
                                    // åŠ¨æ€è°ƒæ•´å¤§å°ï¼šåŸºç¡€10 + æƒé‡
                                    return 10 + Math.min(val[2], 30); 
                                },
                                encode: { value: 2 },
                                showEffectOn: 'render',
                                rippleEffect: { brushType: 'stroke', scale: 3 },
                                label: {
                                    formatter: '{b}', 
                                    position: 'right', 
                                    show: true,
                                    color: '#1e293b',
                                    fontWeight: 'bold',
                                    backgroundColor: 'rgba(255,255,255,0.8)',
                                    padding: [4, 8],
                                    borderRadius: 4
                                },
                                itemStyle: {
                                    color: '#3b82f6',
                                    shadowBlur: 10,
                                    shadowColor: '#3b82f6'
                                },
                                zlevel: 1
                            }
                        ]
                    };
                    myChart.setOption(option);
                    
                    // ç‚¹å‡»äº‹ä»¶
                    myChart.on('click', function (params) {
                        if (params.seriesType === 'effectScatter') {
                            showCityDetails(params.data);
                        }
                    });
                })
                .catch(error => {
                    console.error(error);
                    myChart.hideLoading();
                    document.getElementById('map-container').innerHTML = '<div style="text-align:center; padding-top:300px; color:red;">åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿ china.json æ–‡ä»¶å­˜åœ¨</div>';
                });
                
            window.addEventListener('resize', function() { myChart.resize(); });
        }

        // 3. æ˜¾ç¤ºè¯¦æƒ…å¼¹çª—
        function showCityDetails(cityData) {
            const modal = document.getElementById('info-modal');
            document.getElementById('m-title').innerText = `${cityData.name} - æ”¿ç­–åŠ¨æ€`;
            
            const contentDiv = document.getElementById('m-content');
            let html = '';
            
            if (cityData.policies && cityData.policies.length > 0) {
                // æŒ‰æ—¥æœŸå€’åº
                cityData.policies.sort((a,b) => new Date(b.publish_date) - new Date(a.publish_date));
                
                cityData.policies.forEach(p => {
                    html += `
                        <div class="city-policy-item">
                            <a href="policy-detail.html?id=${p.id}" target="_blank">${p.title}</a>
                            <span class="policy-date">${p.publish_date}</span>
                        </div>
                    `;
                });
            } else {
                html = '<p style="color:#999;">æš‚æ— å…·ä½“æ”¿ç­–æ¡ç›®</p>';
            }
            
            contentDiv.innerHTML = html;
            document.getElementById('m-meta').innerText = `å…±æ£€ç´¢åˆ° ${cityData.rawCount} æ¡ç›¸å…³è®°å½•`;
            modal.style.display = 'flex';
        }

        function closeModal() { document.getElementById('info-modal').style.display = 'none'; }

        // å…¬å…±é€»è¾‘ (æœç´¢ & ç™»å½•)
        let searchTimeout;
        async function performGlobalSearch(keyword) {
            const dropdown = document.getElementById('search-dropdown');
            if (!keyword || keyword.length < 1) { dropdown.style.display = 'none'; return; }
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                dropdown.style.display = 'block';
                dropdown.innerHTML = '<div style="padding:12px; text-align:center; color:#94a3b8;">æœç´¢ä¸­...</div>';
                const { data, error } = await _supabase.from('global_search_view').select('*').ilike('title', `%${keyword}%`).limit(5);
                if (error || !data.length) { dropdown.innerHTML = '<div style="padding:12px; text-align:center;">æ— ç»“æœ</div>'; return; }
                let html = '';
                data.forEach(item => {
                    let link='#';
                    if(item.type==='company') link='companies.html';
                    else if(item.type==='policy') link=`policy-detail.html?id=${item.id}`;
                    else if(item.type==='tech') link=`tech-detail.html?id=${item.id}`;
                    else link=`news-detail.html?id=${item.id}`;
                    html += `<a href="${link}" class="search-result-item">${item.title}</a>`;
                });
                dropdown.innerHTML = html;
            }, 500);
        }
        document.addEventListener('click', (e) => { if(!document.querySelector('.search-component').contains(e.target)) document.getElementById('search-dropdown').style.display='none'; });
        async function checkUserLogin() { const {data:{session}} = await _supabase.auth.getSession(); const btn=document.getElementById('auth-btn'); if(session){btn.innerText=session.user.email.split('@')[0]; btn.onclick=()=>location.href='profile.html';}}
        function toggleMenu() { document.getElementById('navMenu').classList.toggle('active'); }
    </script>
</body>
</html>