<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ç« è¯¦æƒ… | AeroScope Insight</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* === é¡µé¢ä¸“å±æ ·å¼ === */
        body { background-color: #f8fafc; }
        
        .layout-grid {
            display: grid; grid-template-columns: 2.5fr 1fr; gap: 30px;
            max-width: 1200px; margin: 30px auto 60px; padding: 0 20px;
            align-items: start;
        }

        /* å·¦ä¾§ï¼šæ–‡ç« å¡ç‰‡ */
        .main-card {
            background: white; border-radius: 12px; border: 1px solid #e2e8f0;
            padding: 40px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02);
        }

        /* æ–‡ç« å¤´éƒ¨ */
        .article-meta { display: flex; gap: 10px; margin-bottom: 15px; }
        .category-tag { background: #eff6ff; color: #3b82f6; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: 600; }
        .meta-text { color: #94a3b8; font-size: 0.85rem; display: flex; align-items: center; }

        .article-title { font-size: 2rem; font-weight: 800; color: #0f172a; line-height: 1.3; margin-bottom: 25px; }

        /* ä½œè€…åç‰‡ (æ ¸å¿ƒå·®å¼‚ç‚¹) */
        .author-card-large {
            display: flex; align-items: center; gap: 15px;
            padding: 20px; background: #f8fafc; border-radius: 12px; margin-bottom: 30px;
            border: 1px solid #f1f5f9;
        }
        .ac-avatar { 
            width: 56px; height: 56px; border-radius: 50%; background: #cbd5e1; 
            color: white; font-size: 1.5rem; font-weight: bold; 
            display: flex; align-items: center; justify-content: center;
        }
        .ac-info { flex: 1; }
        .ac-name { font-size: 1.1rem; font-weight: 700; color: #1e293b; margin-bottom: 2px; }
        .ac-role { font-size: 0.85rem; color: #64748b; background: #fff; border: 1px solid #e2e8f0; padding: 1px 6px; border-radius: 4px; display: inline-block; }
        .btn-follow { 
            padding: 6px 16px; border-radius: 20px; border: 1px solid #3b82f6; 
            color: #3b82f6; background: white; font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        .btn-follow:hover { background: #eff6ff; }

        /* å°é¢å›¾ */
        .article-cover { width: 100%; max-height: 400px; object-fit: cover; border-radius: 8px; margin-bottom: 30px; display: none; }

        /* æ­£æ–‡åŒºåŸŸ (é€‚é… contenteditable ç”Ÿæˆçš„ HTML) */
        .article-body { font-size: 1.1rem; line-height: 1.8; color: #334155; overflow-wrap: break-word; }
        .article-body p { margin-bottom: 1.5em; }
        .article-body img { max-width: 100%; border-radius: 8px; margin: 10px 0; }
        .article-body h2 { font-size: 1.6rem; color: #1e293b; margin-top: 40px; margin-bottom: 20px; font-weight: 700; }
        .article-body blockquote { border-left: 4px solid #3b82f6; padding-left: 15px; color: #64748b; font-style: italic; background: #f8fafc; padding: 15px; margin: 20px 0; }

        /* åº•éƒ¨äº’åŠ¨ */
        .interaction-bar { 
            margin-top: 50px; padding-top: 30px; border-top: 1px solid #f1f5f9; 
            display: flex; justify-content: center; gap: 30px; 
        }
        .action-btn { 
            display: flex; flex-direction: column; align-items: center; gap: 5px; 
            background: none; border: none; cursor: pointer; color: #64748b; font-size: 0.9rem; transition: 0.2s;
        }
        .action-icon { 
            width: 48px; height: 48px; border-radius: 50%; background: #f1f5f9; 
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: 0.2s;
        }
        .action-btn:hover .action-icon { background: #eff6ff; color: #3b82f6; transform: translateY(-2px); }
        .action-btn.active .action-icon { background: #eff6ff; color: #3b82f6; }

        /* å³ä¾§ä¾§è¾¹æ  */
        .sidebar-widget { background: white; border-radius: 12px; border: 1px solid #e2e8f0; padding: 20px; margin-bottom: 20px; }
        .widget-title { font-size: 1rem; font-weight: 700; color: #1e293b; margin-bottom: 15px; padding-left: 10px; border-left: 3px solid #3b82f6; }
        
        .more-article-item { display: block; padding: 10px 0; border-bottom: 1px dashed #f1f5f9; text-decoration: none; }
        .more-article-item:last-child { border-bottom: none; }
        .more-title { font-size: 0.95rem; color: #334155; font-weight: 500; margin-bottom: 5px; transition: 0.2s; }
        .more-article-item:hover .more-title { color: #3b82f6; }
        .more-meta { font-size: 0.8rem; color: #94a3b8; }

        @media (max-width: 768px) {
            .layout-grid { grid-template-columns: 1fr; }
            .article-title { font-size: 1.6rem; }
            .main-card { padding: 20px; }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="standard-container">
            <div class="nav-inner">
                <a href="index.html" class="logo">AeroScope<span>Insight</span></a>
                <button class="mobile-menu-btn" onclick="toggleMenu()">â˜°</button>
                <nav class="nav-links" id="navMenu">
                    <a href="index.html">é¦–é¡µ</a>
                    <a href="news.html">èµ„è®¯å¿«æŠ¥</a>
                    <a href="policies.html">æ”¿ç­–æ³•è§„</a>
                    <a href="tech.html">æŠ€æœ¯å‰æ²¿</a>
                    <a href="companies.html">è¡Œä¸šå›¾è°±</a>
                    <a href="forum.html">è®ºå›äº¤æµ</a>
                </nav>
                <div class="header-actions">
                    <div class="search-component">
                        <div class="search-box"><span class="search-icon">ğŸ”</span><input type="text" class="search-input" placeholder="æœå…¬å¸ã€æ”¿ç­–..." id="global-search" onkeyup="performGlobalSearch(this.value)"></div>
                        <div id="search-dropdown"></div>
                    </div>
                    <button class="btn btn-primary" id="auth-btn" onclick="location.href='login.html'">ç™»å½•/æ³¨å†Œ</button>
                </div>
            </div>
        </div>
    </header>

    <div class="layout-grid">
        <!-- å·¦ä¾§ï¼šæ–‡ç« ä¸»ä½“ -->
        <main class="main-card">
            <div id="loading-state" style="text-align:center; padding:40px; color:#94a3b8;">æ–‡ç« åŠ è½½ä¸­...</div>
            
            <div id="article-content" style="display: none;">
                <!-- 1. æ ‡é¢˜ä¸Meta -->
                <div class="article-meta">
                    <span class="category-tag" id="art-cat">--</span>
                    <span class="meta-text"><span id="art-date">--</span> Â· é˜…è¯» <span id="art-views">0</span></span>
                </div>
                <h1 class="article-title" id="art-title">--</h1>

                <!-- 2. ä½œè€…åç‰‡ -->
                <div class="author-card-large">
                    <div class="ac-avatar" id="auth-av">U</div>
                    <div class="ac-info">
                        <div class="ac-name" id="auth-name">--</div>
                        <span class="ac-role" id="auth-role">æ™®é€šç”¨æˆ·</span>
                    </div>
                    <button class="btn-follow" onclick="toggleFollow()">+ å…³æ³¨</button>
                </div>

                <!-- 3. å°é¢ä¸æ­£æ–‡ -->
                <img id="art-cover" class="article-cover">
                <div class="article-body" id="art-body">
                    <!-- HTML å†…å®¹å°†æ³¨å…¥è¿™é‡Œ -->
                </div>

                <!-- 4. åº•éƒ¨äº’åŠ¨ -->
                <div class="interaction-bar">
                    <button class="action-btn" onclick="handleLike()">
                        <div class="action-icon">ğŸ‘</div>
                        <span id="like-count">0</span>
                    </button>
                    <button class="action-btn" onclick="copyLink()">
                        <div class="action-icon">ğŸ”—</div>
                        <span>åˆ†äº«</span>
                    </button>
                </div>
            </div>
        </main>

        <!-- å³ä¾§ï¼šä¾§è¾¹æ  -->
        <aside>
            <div class="sidebar-widget">
                <div class="widget-title">è¯¥ä½œè€…çš„å…¶ä»–æ–‡ç« </div>
                <div id="more-articles-list">
                    <p style="color:#94a3b8; font-size:0.85rem;">æš‚æ— æ›´å¤š</p>
                </div>
            </div>

            <div class="sidebar-widget">
                <div class="widget-title">ç›¸å…³æ¨è</div>
                <div style="font-size:0.85rem; color:#64748b;">
                    AI æ¨èç®—æ³•æ­£åœ¨å­¦ä¹ ä¸­...
                </div>
            </div>
        </aside>
    </div>

    <!-- Footer -->
    <footer>
        <div class="standard-container">
            <div class="footer-grid">
                <div class="footer-col brand-col">
                    <h4>AeroScope Insight</h4>
                    <p style="font-size:0.9rem; color:#94a3b8; line-height: 1.6; margin-bottom: 20px;">è¿æ¥æ”¿ç­–ã€èµ„æœ¬ä¸æŠ€æœ¯ï¼Œæ‰“é€ ä½ç©ºç»æµé¢†åŸŸçš„æ•°å­—åŒ–åŸºç¡€è®¾æ–½ä¸å†³ç­–å¼•æ“ã€‚</p>
                    <div class="social-icons">
                        <a href="#" class="social-btn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></a>
                    </div>
                </div>
                <div class="footer-col"><h4>æ ¸å¿ƒæ¿å—</h4><ul><li><a href="news.html">èµ„è®¯å¿«æŠ¥</a></li><li><a href="policies.html">æ”¿ç­–æ³•è§„</a></li><li><a href="companies.html">ä¼ä¸šæ•°æ®åº“</a></li></ul></div>
                <div class="footer-col"><h4>æ•°æ®å›¾è°±</h4><ul><li><a href="chart-funding.html">å…¨çƒèèµ„è¶‹åŠ¿</a></li><li><a href="chart-cities.html">è¯•ç‚¹åŸå¸‚åˆ†å¸ƒ</a></li><li><a href="chart-companies.html">äº§ä¸šé“¾å…¨æ™¯å›¾</a></li></ul></div>
            </div>
            <div class="copyright" style="border-top:1px solid #334155; padding-top:20px; margin-top:20px; text-align:center; color:#64748b; font-size:0.85rem;">&copy; 2025 AeroScope Insight. All rights reserved.</div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://ulfktuvatxyakrdrwxfq.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVsZmt0dXZhdHh5YWtyZHJ3eGZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NDYyMjksImV4cCI6MjA4MDIyMjIyOX0.SBvHgp9HK_Lr5vXCgwu4Ae-Q6hH4dhMx3JSRbLiU0fU';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let articleId = null;
        let currentLikes = 0;

        document.addEventListener('DOMContentLoaded', async () => {
            checkUserLogin();
            
            const params = new URLSearchParams(window.location.search);
            articleId = params.get('id');
            
            if(!articleId) {
                document.getElementById('loading-state').innerText = 'æ–‡ç« ä¸å­˜åœ¨';
                return;
            }

            await loadArticle();
            incrementView(); // å¢åŠ é˜…è¯»æ•°
        });

        async function loadArticle() {
            // è”è¡¨æŸ¥è¯¢ï¼šæ–‡ç«  + ä½œè€…ä¿¡æ¯
            const { data, error } = await _supabase
                .from('user_articles')
                .select(`
                    *,
                    profiles:user_id ( username, is_expert, industry_role )
                `)
                .eq('id', articleId)
                .single();

            if (error || !data) {
                document.getElementById('loading-state').innerText = 'åŠ è½½å¤±è´¥æˆ–æ–‡ç« å·²è¢«åˆ é™¤';
                return;
            }

            // æ¸²æŸ“å…ƒæ•°æ®
            document.title = `${data.title} | AeroScope`;
            document.getElementById('art-cat').innerText = data.category || 'æ´å¯Ÿ';
            document.getElementById('art-date').innerText = new Date(data.created_at).toLocaleDateString();
            document.getElementById('art-views').innerText = data.views || 0;
            document.getElementById('art-title').innerText = data.title;
            
            // æ¸²æŸ“ä½œè€…
            const author = data.profiles;
            const authorName = author?.username || 'åŒ¿åç”¨æˆ·';
            document.getElementById('auth-name').innerText = authorName;
            document.getElementById('auth-av').innerText = authorName.charAt(0).toUpperCase();
            if (author?.is_expert) {
                document.getElementById('auth-role').innerText = author.industry_role || 'è®¤è¯ä¸“å®¶';
                document.getElementById('auth-role').style.cssText = "color:#d97706; background:#fef3c7; border-color:#fcd34d;";
            }

            // æ¸²æŸ“å°é¢
            if (data.cover_image) {
                const img = document.getElementById('art-cover');
                img.src = data.cover_image;
                img.style.display = 'block';
            }

            // æ¸²æŸ“æ­£æ–‡ (ç›´æ¥æ³¨å…¥ HTML)
            document.getElementById('art-body').innerHTML = data.content;

            // äº’åŠ¨æ•°æ®
            currentLikes = data.likes || 0;
            document.getElementById('like-count').innerText = currentLikes;

            // æ˜¾ç¤ºå†…å®¹
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('article-content').style.display = 'block';

            // åŠ è½½ä½œè€…çš„å…¶ä»–æ–‡ç« 
            loadMoreArticles(data.user_id);
        }

        async function loadMoreArticles(userId) {
            const { data } = await _supabase
                .from('user_articles')
                .select('id, title, created_at')
                .eq('user_id', userId)
                .eq('status', 'published')
                .neq('id', articleId) // æ’é™¤å½“å‰æ–‡ç« 
                .limit(5);

            if (data && data.length > 0) {
                const list = document.getElementById('more-articles-list');
                list.innerHTML = '';
                data.forEach(item => {
                    list.innerHTML += `
                        <a href="article-detail.html?id=${item.id}" class="more-article-item">
                            <div class="more-title">${item.title}</div>
                            <div class="more-meta">${new Date(item.created_at).toLocaleDateString()}</div>
                        </a>
                    `;
                });
            }
        }

        async function incrementView() {
            // ä½¿ç”¨ RPC æˆ–ç›´æ¥ update (ç®€å•èµ·è§è¿™é‡Œå…ˆä¸åšä¸¥æ ¼é˜²åˆ·)
            const { data } = await _supabase.rpc('increment_article_view', { article_id: articleId });
            // å¦‚æœæ²¡æœ‰é…ç½® RPCï¼Œä¹Ÿå¯ä»¥å¿½ç•¥ï¼Œæˆ–è€…å‰ç«¯ä¸åšå®æ—¶åˆ·æ–°
        }

        async function handleLike() {
            // ç®€å•ç‚¹èµé€»è¾‘
            currentLikes++;
            document.getElementById('like-count').innerText = currentLikes;
            
            await _supabase
                .from('user_articles')
                .update({ likes: currentLikes })
                .eq('id', articleId);
        }

        function copyLink() {
            navigator.clipboard.writeText(window.location.href);
            alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }

        function toggleFollow() {
            alert('å…³æ³¨åŠŸèƒ½å¼€å‘ä¸­...');
        }

        // --- Header é€»è¾‘ ---
        async function checkUserLogin() {
            const { data: { session } } = await _supabase.auth.getSession();
            const btn = document.getElementById('auth-btn');
            if (session) {
                btn.innerText = session.user.email.split('@')[0];
                btn.onclick = () => location.href = 'profile.html';
            }
        }
        function toggleMenu() { document.getElementById('navMenu').classList.toggle('active'); }
        let searchTimeout;
        async function performGlobalSearch(keyword) {
            const dropdown = document.getElementById('search-dropdown');
            if (!keyword || keyword.length < 1) { dropdown.style.display = 'none'; return; }
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                dropdown.style.display = 'block';
                const { data } = await _supabase.from('global_search_view').select('*').ilike('title', `%${keyword}%`).limit(5);
                if (!data || !data.length) { dropdown.innerHTML = '<div style="padding:12px; text-align:center;">æ— ç»“æœ</div>'; return; }
                let html = '';
                data.forEach(item => {
                    let link=`news-detail.html?id=${item.id}`;
                    if(item.type==='company') link='companies.html';
                    else if(item.type==='policy') link=`policy-detail.html?id=${item.id}`;
                    html += `<a href="${link}" class="search-result-item">${item.title}</a>`;
                });
                dropdown.innerHTML = html;
            }, 500);
        }
        document.addEventListener('click', (e) => { if(!document.querySelector('.search-component').contains(e.target)) document.getElementById('search-dropdown').style.display='none'; });
    </script>
</body>
</html>