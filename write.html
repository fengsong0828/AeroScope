<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’°å†™ä¸“æ æ–‡ç«  | AeroScope</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* === å…¨å±€é‡ç½®ä¸èƒŒæ™¯ === */
        body { 
            background-color: #f8fafc; /* ä¸ Index ä¿æŒä¸€è‡´çš„èƒŒæ™¯è‰² */
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: #1e293b;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* === é¡¶éƒ¨å¯¼èˆªæ  (å›ºå®š) === */
        header {
            background: white;
            height: 64px; /* ä¸ Index é«˜åº¦ä¸€è‡´ */
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            z-index: 100;
        }
        
        .header-inner {
            width: 100%; 
            max-width: 1200px; /* ã€å…³é”®ä¿®æ”¹ã€‘ä¸ Index çš„ standard-container å®½åº¦ä¸€è‡´ */
            padding: 0 20px;
            box-sizing: border-box; /* é˜²æ­¢paddingæ’‘å¤§ */
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        
        /* Logo æ ·å¼å¤ç”¨ */
        .logo { font-size: 1.2rem; font-weight: 800; color: #0f172a; text-decoration: none; display: flex; align-items: center; gap: 5px; }
        .logo span { color: #3b82f6; }
        
        .header-actions { display: flex; gap: 12px; align-items: center; }
        
        /* æŒ‰é’®æ ·å¼å¤ç”¨ */
        .btn { padding: 8px 16px; border-radius: 6px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: 0.2s; border: 1px solid transparent; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; }
        .btn-text { background: transparent; color: #64748b; font-weight: 500; }
        .btn-text:hover { color: #1e293b; }
        .btn-secondary { background: white; border-color: #cbd5e1; color: #475569; }
        .btn-secondary:hover { border-color: #94a3b8; background: #f8fafc; }
        .btn-primary { background: #3b82f6; color: white; box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3); border: none; }
        .btn-primary:hover { background: #2563eb; transform: translateY(-1px); }

        /* === ä¸»æ»šåŠ¨åŒºåŸŸ === */
        .scroll-container {
            flex: 1; overflow-y: auto; scroll-behavior: smooth;
        }

        /* === ç™½çº¸å¡ç‰‡å®¹å™¨ === */
        .editor-paper {
            width: 100%;
            max-width: 1200px; /* ã€å…³é”®ä¿®æ”¹ã€‘ä¸ Index å®½åº¦ä¸€è‡´ */
            margin: 30px auto 60px;
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0; /* è¾¹æ¡†é¢œè‰²ä¸ Index ä¸€è‡´ */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); /* é˜´å½±ä¸ Index å¡ç‰‡ä¸€è‡´ */
            overflow: hidden;
            position: relative;
            min-height: 800px;
            box-sizing: border-box;
        }

        /* === 1. é¡µé¢æ ‡é¢˜åŒºåŸŸ === */
        .paper-header {
            padding: 30px 50px 20px 50px;
        }
        
        /* ã€å…³é”®ä¿®æ”¹ã€‘ä¼˜åŒ–â€œæ’°å†™ä¸“æ æ–‡ç« â€æ ·å¼ */
        .page-heading {
            font-size: 1.1rem; /* æ”¾å¤§ */
            font-weight: 800; 
            color: #0f172a; /* æ”¹ä¸ºé»‘è‰² */
            margin-bottom: 10px; 
            display: flex; align-items: center; gap: 8px;
        }
        /* å›¾æ ‡è£…é¥° */
        .page-heading::before {
            content: 'âœï¸'; 
            font-size: 1.2rem;
        }

        /* ã€å…³é”®ä¿®æ”¹ã€‘ç¼©å°æ–‡ç« æ ‡é¢˜è¾“å…¥æ¡†é«˜åº¦ */
        .title-input {
            width: 100%; border: none; 
            font-size: 1.8rem; /* ç¨å¾®è°ƒå°ä¸€ç‚¹ */
            font-weight: 800; color: #0f172a;
            padding: 5px 0; /* å‡å°å†…è¾¹è· */
            outline: none; background: transparent; 
            line-height: 1.2;
        }
        .title-input::placeholder { color: #cbd5e1; }

        /* === 2. å…ƒæ•°æ®é…ç½®é¢æ¿ (ç°è‰²èƒŒæ™¯å—) === */
        .meta-panel {
            margin: 10px 50px 20px 50px;
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }
        
        .meta-row { display: grid; grid-template-columns: 300px 1fr; gap: 30px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group:last-child { margin-bottom: 0; }
        .form-label { display: block; font-size: 0.85rem; font-weight: 700; color: #475569; margin-bottom: 6px; }
        
        .form-select, .form-textarea {
            width: 100%; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px;
            font-size: 0.9rem; background: white; color: #1e293b; transition: 0.2s; box-sizing: border-box;
        }
        .form-select:focus, .form-textarea:focus { border-color: #3b82f6; outline: none; }

        /* å°é¢å›¾ä¸Šä¼ åŒº */
        .cover-row { display: flex; gap: 10px; }
        .cover-uploader {
            width: 100px; height: 60px; border: 1px dashed #cbd5e1; border-radius: 6px;
            background: white; display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; flex-shrink: 0;
        }
        .cover-uploader:hover { border-color: #3b82f6; background: #eff6ff; }
        .cover-hint { color: #94a3b8; font-size: 0.7rem; pointer-events: none; text-align: center; line-height: 1.2; }
        .cover-icon { font-size: 16px; margin-bottom: 2px; }
        .cover-preview { width: 100%; height: 100%; object-fit: cover; position: absolute; top:0; left:0; display: none; }
        
        .cover-input-text {
            flex: 1; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem;
        }

        /* === 3. å·¥å…·æ  (å¸é¡¶) === */
        .toolbar-sticky {
            position: sticky; top: 0; z-index: 50; 
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid #e2e8f0;
            border-top: 1px dashed #e2e8f0; /* æ”¹ä¸ºè™šçº¿åˆ†éš”ï¼Œæ›´è½»é‡ */
            padding: 8px 50px;
            display: flex; gap: 5px; align-items: center; flex-wrap: wrap;
        }
        
        .tool-btn {
            width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
            border: 1px solid transparent; border-radius: 4px; background: transparent;
            color: #64748b; cursor: pointer; transition: 0.2s; font-size: 0.85rem;
        }
        .tool-btn:hover { background: #f1f5f9; color: #1e293b; border-color: #cbd5e1; }
        .tool-btn i { font-style: normal; font-weight: bold; }
        
        /* æ–‡å­—æŒ‰é’® */
        .tool-btn-text { width: auto; padding: 0 8px; font-size: 0.8rem; font-weight: 500; }
        
        .separator { width: 1px; height: 16px; background: #e2e8f0; margin: 0 6px; }

        /* === 4. æ­£æ–‡ç¼–è¾‘åŒº === */
        #rich-editor {
            padding: 40px 50px 80px 50px;
            min-height: 500px;
            outline: none;
            font-size: 1.05rem;
            line-height: 1.8;
            color: #334155;
        }
        /* ç¼–è¾‘å™¨å†…æ ·å¼é‡ç½® */
        #rich-editor p { margin-bottom: 1.2em; min-height: 1.2em; }
        #rich-editor h2 { font-size: 1.5rem; color: #1e293b; margin-top: 1.5em; margin-bottom: 0.8em; font-weight: 700; border-bottom: none; }
        #rich-editor blockquote { border-left: 4px solid #cbd5e1; padding-left: 16px; color: #64748b; font-style: italic; margin: 1.5em 0; background: #f8fafc; padding-top:10px; padding-bottom:10px;}
        #rich-editor img { max-width: 100%; border-radius: 8px; display: block; margin: 20px auto; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }

        #file-input-cover, #file-input-editor { display: none; }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 1200px) {
            .header-inner, .editor-paper { max-width: 95%; }
        }
        @media (max-width: 768px) {
            .header-inner { padding: 0 15px; }
            .editor-paper { margin: 0; border-radius: 0; box-shadow: none; border:none; min-height: calc(100vh - 64px); }
            .paper-header, .toolbar-sticky, #rich-editor { padding-left: 20px; padding-right: 20px; }
            .meta-panel { margin: 20px; padding: 15px; }
            .meta-row { grid-template-columns: 1fr; gap: 20px; }
            .title-input { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header>
        <div class="header-inner">
            <a href="index.html" class="logo">AeroScope <span>Insight</span></a>
            <div class="header-actions">
                <a href="index.html" class="btn btn-text">å–æ¶ˆ</a>
                <button class="btn btn-secondary" onclick="saveArticle('draft')">ğŸ’¾ æš‚å­˜è‰ç¨¿</button>
                <button class="btn btn-primary" onclick="saveArticle('published')">ğŸš€ ç«‹å³å‘å¸ƒ</button>
            </div>
        </div>
    </header>

    <div class="scroll-container">
        <div class="editor-paper">
            
            <!-- 1. æ ‡é¢˜åŒº -->
            <div class="paper-header">
                <!-- ä¼˜åŒ–ï¼šé»‘è‰²å¤§å­—ä½“æ ‡é¢˜ -->
                <div class="page-heading">æ’°å†™ä¸“æ æ–‡ç« </div>
                <!-- ä¼˜åŒ–ï¼šç¼©å°äº†paddingå’Œå­—ä½“ï¼Œæ›´ç´§å‡‘ -->
                <input type="text" id="art-title" class="title-input" placeholder="è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜...">
            </div>

            <!-- 2. é…ç½®é¢æ¿ (æ”¶çº³ é¢†åŸŸã€æ‘˜è¦ã€å°é¢) -->
            <div class="meta-panel">
                <div class="meta-row">
                    <!-- å·¦åˆ—ï¼šè®¾ç½® -->
                    <div class="meta-col">
                        <div class="form-group">
                            <label class="form-label">æ‰€å±é¢†åŸŸ</label>
                            <select id="art-cat" class="form-select">
                                <option value="æŠ€æœ¯åˆ†æ">âš™ï¸ æŠ€æœ¯åˆ†æ</option>
                                <option value="å¸‚åœºç ”åˆ¤">ğŸ“Š å¸‚åœºç ”åˆ¤</option>
                                <option value="æ”¿ç­–è§£è¯»">ğŸ“œ æ”¿ç­–è§£è¯»</option>
                                <option value="æŠ•èµ„é€»è¾‘">ğŸ’° æŠ•èµ„é€»è¾‘</option>
                                <option value="äº§ä¸šè§‚å¯Ÿ">ğŸ”­ äº§ä¸šè§‚å¯Ÿ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å°é¢å›¾ç‰‡</label>
                            <div class="cover-row">
                                <div class="cover-uploader" onclick="document.getElementById('file-input-cover').click()">
                                    <div class="cover-hint" id="cover-placeholder">
                                        <div class="cover-icon">ğŸ“·</div>
                                        ç‚¹å‡»ä¸Šä¼ 
                                    </div>
                                    <img id="cover-img-preview" class="cover-preview">
                                </div>
                                <input type="hidden" id="art-cover">
                                <input type="file" id="file-input-cover" accept="image/*" onchange="uploadCover(this)">
                                <!-- å¢åŠ ä¸€ä¸ªé“¾æ¥è¾“å…¥æ¡†ä½œä¸ºå¤‡ç”¨ï¼Œå¹¶è‡ªåŠ¨å¯¹é½ -->
                                <input type="text" class="form-select" placeholder="æˆ–è¾“å…¥å›¾ç‰‡é“¾æ¥..." oninput="updateCoverFromLink(this.value)" style="height: 60px;">
                            </div>
                        </div>
                    </div>

                    <!-- å³åˆ—ï¼šæ‘˜è¦ -->
                    <div class="meta-col">
                        <div class="form-group" style="height: 100%; display: flex; flex-direction: column;">
                            <label class="form-label">æ–‡ç« æ‘˜è¦ (é€‰å¡«)</label>
                            <textarea id="art-summary" class="form-textarea" style="flex: 1; resize: none;" placeholder="å¦‚æœä¸å¡«ï¼Œå‘å¸ƒæ—¶ç³»ç»Ÿå°†è‡ªåŠ¨æˆªå–æ­£æ–‡å‰80å­—ä½œä¸ºæ‘˜è¦..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. å·¥å…·æ  (å¸é¡¶) -->
            <div class="toolbar-sticky">
                <button class="tool-btn" onmousedown="handleUndo(); return false;" title="æ’¤é”€ (Ctrl+Z)">â†©ï¸</button>
                <button class="tool-btn" onmousedown="handleRedo(); return false;" title="é‡åš (Ctrl+Y)">â†ªï¸</button>
                <div class="separator"></div>

                <button class="tool-btn" onmousedown="formatDoc('bold'); return false;" title="åŠ ç²—"><b>B</b></button>
                <button class="tool-btn tool-btn-text" onmousedown="formatDoc('formatBlock', '<h2>'); return false;" title="äºŒçº§æ ‡é¢˜">H2</button>
                <button class="tool-btn tool-btn-text" onmousedown="formatDoc('formatBlock', '<p>'); return false;" title="æ­£æ–‡æ®µè½">P</button>
                <div class="separator"></div>
                
                <button class="tool-btn tool-btn-text" onmousedown="customStyle('indent'); return false;">â‡¥ ç¼©è¿›</button>
                <button class="tool-btn tool-btn-text" onmousedown="customStyle('outdent'); return false;">â‡¤ å–æ¶ˆ</button>
                <div class="separator"></div>

                <button class="tool-btn" onmousedown="customStyle('justifyLeft'); return false;" title="å·¦å¯¹é½">â¬…</button>
                <button class="tool-btn" onmousedown="customStyle('justifyCenter'); return false;" title="å±…ä¸­">â¬†</button>
                <button class="tool-btn" onmousedown="customStyle('justifyRight'); return false;" title="å³å¯¹é½">â¡</button>
                <div class="separator"></div>

                <button class="tool-btn tool-btn-text" onmousedown="customStyle('lineHeight'); return false;" title="å¢åŠ è¡Œé—´è·">â†•ï¸ é—´è·+</button>
                
                <div class="separator"></div>
                <button class="tool-btn tool-btn-text" onclick="document.getElementById('file-input-editor').click()" title="æ’å…¥æ­£æ–‡å›¾ç‰‡" style="color:#3b82f6;">
                    ğŸ–¼ï¸ æ’å…¥å›¾ç‰‡
                </button>
                <input type="file" id="file-input-editor" accept="image/*" onchange="insertEditorImage(this)">
            </div>

            <!-- 4. æ­£æ–‡ç¼–è¾‘ä¸»ä½“ -->
            <div id="rich-editor" contenteditable="true">
                <p>åœ¨æ­¤è¾“å…¥æ­£æ–‡å†…å®¹...</p>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://ulfktuvatxyakrdrwxfq.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVsZmt0dXZhdHh5YWtyZHJ3eGZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NDYyMjksImV4cCI6MjA4MDIyMjIyOX0.SBvHgp9HK_Lr5vXCgwu4Ae-Q6hH4dhMx3JSRbLiU0fU';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) {
                alert('è¯·ç™»å½•åå‘å¸ƒæ–‡ç« ');
                window.location.href = 'login.html';
                return;
            }
            currentUser = session.user;
        });

        // ================= ç¼–è¾‘å™¨æ ¸å¿ƒé€»è¾‘ =================

        function formatDoc(cmd, value = null) {
            document.execCommand(cmd, false, value);
            document.getElementById('rich-editor').focus();
        }

        function handleUndo() { document.execCommand('undo', false, null); }
        function handleRedo() { document.execCommand('redo', false, null); }

        function customStyle(action) {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;

            let node = selection.anchorNode;
            while (node && node.nodeName !== 'P' && node.nodeName !== 'H2' && node.nodeName !== 'DIV' && node.nodeName !== 'BLOCKQUOTE' && node.id !== 'rich-editor') {
                node = node.parentNode;
            }

            if (!node || node.id === 'rich-editor') {
                document.execCommand('formatBlock', false, 'p');
                node = window.getSelection().anchorNode.parentNode;
            }

            if (node.id === 'rich-editor') return; 

            switch (action) {
                case 'indent': node.style.textIndent = '2em'; break;
                case 'outdent': node.style.textIndent = '0'; break;
                case 'justifyLeft': node.style.textAlign = 'left'; break;
                case 'justifyCenter': node.style.textAlign = 'center'; break;
                case 'justifyRight': node.style.textAlign = 'right'; break;
                case 'lineHeight':
                    node.style.lineHeight = node.style.lineHeight === '2' ? '1.6' : '2';
                    node.style.marginBottom = '24px';
                    break;
            }
        }

        // ================= å›¾ç‰‡ä¸Šä¼ é€»è¾‘ =================

        async function insertEditorImage(input) {
            const file = input.files[0];
            if (!file) return;
            try {
                const id = 'img-' + Date.now();
                const loadingHtml = `<div id="${id}" style="color:#94a3b8;text-align:center;padding:10px;background:#f8fafc;">[å›¾ç‰‡ä¸Šä¼ ä¸­...]</div><br>`;
                document.execCommand('insertHTML', false, loadingHtml);
                const url = await uploadToSupabase(file);
                const imgTag = `<img src="${url}" style="max-width:100%; border-radius:8px; display:block; margin:10px auto; box-shadow:0 4px 10px rgba(0,0,0,0.1);"><br>`;
                const placeholder = document.getElementById(id);
                if(placeholder) placeholder.outerHTML = imgTag;
            } catch (err) { alert('ä¸Šä¼ å¤±è´¥: ' + err.message); } finally { input.value = ''; }
        }

        // å°é¢å›¾ï¼šé“¾æ¥è¾“å…¥åŒæ­¥é¢„è§ˆ
        function updateCoverFromLink(url) {
            document.getElementById('art-cover').value = url;
            const img = document.getElementById('cover-img-preview');
            const placeholder = document.getElementById('cover-placeholder');
            if (url) {
                img.src = url; img.style.display = 'block'; placeholder.style.display = 'none';
            } else {
                img.style.display = 'none'; placeholder.style.display = 'block';
            }
        }

        // å°é¢å›¾ï¼šæ–‡ä»¶ä¸Šä¼ 
        async function uploadCover(input) {
            const file = input.files[0];
            if (!file) return;
            const hint = document.getElementById('cover-placeholder');
            hint.innerHTML = 'ä¸Šä¼ ä¸­...';
            try {
                const url = await uploadToSupabase(file);
                updateCoverFromLink(url); // å¤ç”¨é¢„è§ˆé€»è¾‘
            } catch (err) { 
                alert('å°é¢ä¸Šä¼ å¤±è´¥'); hint.innerHTML = '<div class="cover-icon">ğŸ“·</div>ç‚¹å‡»ä¸Šä¼ '; 
            } finally { input.value = ''; }
        }

        async function uploadToSupabase(file) {
            const fileName = `user_${currentUser.id}_${Date.now()}_${file.name.replace(/[^\w.]/g, '')}`;
            const { data, error } = await _supabase.storage.from('article_images').upload(fileName, file);
            if (error) throw error;
            const { data: { publicUrl } } = _supabase.storage.from('article_images').getPublicUrl(fileName);
            return publicUrl;
        }

        // ================= å‘å¸ƒé€»è¾‘ =================

        async function saveArticle(status) {
            const title = document.getElementById('art-title').value.trim();
            const editor = document.getElementById('rich-editor');
            const content = editor.innerHTML; 
            const plainText = editor.innerText;

            if (!title) return alert('è¯·å¡«å†™æ–‡ç« æ ‡é¢˜');
            if (!plainText || plainText.length < 5) return alert('æ­£æ–‡å†…å®¹å¤ªå°‘');

            const btn = status === 'published' ? document.querySelector('.btn-primary') : document.querySelector('.btn-secondary');
            const originalText = btn.innerText;
            btn.innerText = 'æäº¤ä¸­...';
            btn.disabled = true;

            let summary = document.getElementById('art-summary').value.trim();
            if (!summary) summary = plainText.substring(0, 100).replace(/\n/g, ' ') + '...';

            const payload = {
                user_id: currentUser.id,
                title: title,
                category: document.getElementById('art-cat').value,
                cover_image: document.getElementById('art-cover').value || null,
                content: content, 
                summary: summary,
                status: status,
                updated_at: new Date()
            };

            try {
                const { error } = await _supabase.from('user_articles').insert(payload);
                if (error) throw error;
                if (status === 'published') {
                    alert('ğŸ‰ å‘å¸ƒæˆåŠŸï¼'); location.href = 'index.html'; 
                } else {
                    alert('ğŸ’¾ è‰ç¨¿å·²ä¿å­˜ã€‚');
                }
            } catch (err) { console.error(err); alert('æäº¤å¤±è´¥: ' + err.message); } 
            finally { btn.disabled = false; btn.innerText = originalText; }
        }
    </script>
</body>
</html>