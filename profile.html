<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººä¸­å¿ƒ | AeroScope Insight</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* å¤ç”¨ Header/Footer æ ·å¼ */
        .search-component { position: relative; margin-right: 15px; }
        .search-box { display: flex; align-items: center; border: 1px solid #cbd5e1; border-radius: 20px; background: white; padding: 5px 12px; transition: 0.3s; }
        .search-box:focus-within { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .search-icon { font-size: 1rem; color: #64748b; margin-right: 8px; }
        .search-input { border: none; outline: none; font-size: 0.9rem; width: 160px; color: #1e293b; }
        #search-dropdown { position: absolute; top: 45px; right: 0; width: 280px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 2000; display: none; max-height: 400px; overflow-y: auto; }
        .search-result-item { display: block; padding: 12px; border-bottom: 1px solid #f1f5f9; text-decoration: none; color: #1e293b; transition: 0.2s; }
        .search-result-item:hover { background: #f8fafc; }
        
        .footer-grid { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 40px; padding-bottom: 40px; }
        .footer-col h4 { color: white; margin-bottom: 20px; font-size: 1rem; font-weight: 600; }
        .footer-col ul li { margin-bottom: 12px; }
        .footer-col a { color: #94a3b8; font-size: 0.9rem; transition: color 0.2s; }
        .footer-col a:hover { color: #3b82f6; }
        .social-icons { display: flex; gap: 15px; margin-top: 20px; }
        .social-btn { width: 36px; height: 36px; background: #334155; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; transition: 0.3s; }
        .social-btn:hover { background: #3b82f6; transform: translateY(-2px); }

        /* --- ä¸ªäººä¸­å¿ƒå¸ƒå±€ --- */
        body { background-color: #f8fafc; }
        
        .profile-layout { 
            max-width: 1200px; margin: 40px auto; padding: 0 20px; 
            display: grid; grid-template-columns: 300px 1fr; gap: 30px;
        }

        /* å·¦ä¾§å¡ç‰‡ */
        .profile-sidebar {
            background: white; border-radius: 12px; border: 1px solid #e2e8f0; 
            padding: 30px 20px; text-align: center; height: fit-content;
        }
        
        .user-avatar-lg {
            width: 100px; height: 100px; margin: 0 auto 20px; 
            background: #0f172a; color: white; font-size: 2.5rem; font-weight: bold; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            border: 4px solid #f1f5f9;
        }
        
        .user-name-lg { font-size: 1.2rem; font-weight: 700; color: #1e293b; margin-bottom: 5px; }
        .user-role-badge { 
            display: inline-block; background: #e0f2fe; color: #0284c7; 
            padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; margin-bottom: 20px;
        }
        .user-expert-badge {
            background: linear-gradient(135deg, #f59e0b, #d97706); color: white;
        }

        .side-menu { list-style: none; text-align: left; margin-top: 30px; border-top: 1px solid #f1f5f9; padding-top: 20px; }
        .side-menu li { margin-bottom: 5px; }
        .menu-btn { 
            display: block; width: 100%; padding: 12px 15px; border-radius: 8px; 
            color: #64748b; font-weight: 500; cursor: pointer; transition: 0.2s; border: none; background: none; text-align: left;
        }
        .menu-btn:hover, .menu-btn.active { background: #f1f5f9; color: #3b82f6; }
        .menu-btn.logout { color: #ef4444; }
        .menu-btn.logout:hover { background: #fee2e2; }

        /* å³ä¾§å†…å®¹åŒº */
        .profile-content { background: white; border-radius: 12px; border: 1px solid #e2e8f0; padding: 40px; min-height: 500px; }
        
        .section-title { font-size: 1.2rem; font-weight: 700; color: #1e293b; margin-bottom: 30px; border-left: 4px solid #3b82f6; padding-left: 10px; }

        /* è¡¨å• */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #475569; font-size: 0.9rem; }
        .form-control { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.95rem; transition: 0.2s; }
        .form-control:focus { border-color: #3b82f6; outline: none; }
        .form-control:disabled { background: #f8fafc; color: #94a3b8; cursor: not-allowed; }

        /* åˆ—è¡¨é¡¹ (è¯é¢˜/å…³æ³¨) */
        .list-item { padding: 15px 0; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .list-item:last-child { border-bottom: none; }
        .item-main a { color: #1e293b; font-weight: 500; text-decoration: none; transition: 0.2s; }
        .item-main a:hover { color: #3b82f6; }
        .item-sub { font-size: 0.85rem; color: #94a3b8; margin-top: 4px; }
        .btn-sm { padding: 4px 10px; border-radius: 4px; border: 1px solid #e2e8f0; background: white; color: #64748b; font-size: 0.8rem; cursor: pointer; transition: 0.2s; }
        .btn-sm:hover { border-color: #ef4444; color: #ef4444; }

        /* ç®¡ç†å‘˜å…¥å£ */
        .admin-banner { 
            background: #0f172a; color: white; padding: 15px; border-radius: 8px; 
            margin-top: 20px; text-align: center; cursor: pointer; transition: 0.2s; 
            display: none; text-decoration: none;
        }
        .admin-banner:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(15, 23, 42, 0.3); }

        @media (max-width: 768px) {
            .profile-layout { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .footer-grid { grid-template-columns: 1fr; text-align: center; }
            .search-component { display: none; }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="standard-container">
            <div class="nav-inner">
                <a href="index.html" class="logo">AeroScope<span>Insight</span></a>
                <button class="mobile-menu-btn" onclick="toggleMenu()">â˜°</button>
                <nav class="nav-links" id="navMenu">
                    <a href="index.html">é¦–é¡µ</a>
                    <a href="news.html">èµ„è®¯å¿«æŠ¥</a>
                    <a href="policies.html">æ”¿ç­–æ³•è§„</a>
                    <a href="tech.html">æŠ€æœ¯å‰æ²¿</a>
                    <a href="companies.html">è¡Œä¸šå›¾è°±</a>
                    <a href="forum.html">è®ºå›äº¤æµ</a>
                </nav>
                <div class="header-actions">
                    <div class="search-component">
                        <div class="search-box"><span class="search-icon">ğŸ”</span><input type="text" class="search-input" placeholder="æœå…¬å¸ã€æ”¿ç­–..." id="global-search" onkeyup="performGlobalSearch(this.value)"></div>
                        <div id="search-dropdown"></div>
                    </div>
                    <button class="btn btn-primary" onclick="logout()">é€€å‡ºç™»å½•</button>
                </div>
            </div>
        </div>
    </header>

    <div class="profile-layout">
        
        <!-- å·¦ä¾§å¯¼èˆª -->
        <aside class="profile-sidebar">
            <div class="user-avatar-lg" id="avatar-text">U</div>
            <div class="user-name-lg" id="display-name">Loading...</div>
            <div id="role-badge-container"></div>
            
            <a href="admin.html" class="admin-banner" id="admin-entry">
                ğŸ› ï¸ è¿›å…¥åå°ç®¡ç†ç³»ç»Ÿ
            </a>

            <ul class="side-menu">
                <li><button class="menu-btn active" onclick="switchSection('info', this)">ğŸ‘¤ ä¸ªäººèµ„æ–™</button></li>
                <li><button class="menu-btn" onclick="switchSection('posts', this)">ğŸ“ æˆ‘çš„å‘å¸ƒ</button></li>
                <!-- <li><button class="menu-btn" onclick="switchSection('follows', this)">â­ æˆ‘çš„å…³æ³¨</button></li> -->
                <li><button class="menu-btn logout" onclick="logout()">ğŸ›‘ é€€å‡ºç™»å½•</button></li>
            </ul>
        </aside>

        <!-- å³ä¾§å†…å®¹ -->
        <main class="profile-content">
            
            <!-- 1. ä¸ªäººèµ„æ–™ -->
            <div id="section-info">
                <h2 class="section-title">ç¼–è¾‘èµ„æ–™</h2>
                <div class="form-grid">
                    <div class="form-group" style="grid-column: 1/-1;">
                        <label>ç™»å½•é‚®ç®± (ä¸å¯ä¿®æ”¹)</label>
                        <input type="text" id="email" class="form-control" disabled>
                    </div>
                    <div class="form-group">
                        <label>æ˜µç§° / å§“å</label>
                        <input type="text" id="username" class="form-control" placeholder="æ€ä¹ˆç§°å‘¼æ‚¨ï¼Ÿ">
                    </div>
                    <div class="form-group">
                        <label>æ‰‹æœºå·</label>
                        <input type="text" id="phone" class="form-control" placeholder="è”ç³»æ–¹å¼">
                    </div>
                    <div class="form-group">
                        <label>æ‰€åœ¨å…¬å¸</label>
                        <input type="text" id="company" class="form-control" placeholder="ä¾‹å¦‚ï¼šäº¿èˆªæ™ºèƒ½">
                    </div>
                    <div class="form-group">
                        <label>èŒä½ / å¤´è¡”</label>
                        <input type="text" id="role" class="form-control" placeholder="ä¾‹å¦‚ï¼šç ”å‘å·¥ç¨‹å¸ˆ">
                    </div>
                </div>
                <div style="margin-top: 30px; text-align: right;">
                    <span id="save-msg" style="margin-right: 15px; font-size: 0.9rem; display:none;"></span>
                    <button class="btn btn-primary" onclick="updateProfile()" style="padding: 12px 30px;">ä¿å­˜ä¿®æ”¹</button>
                </div>
            </div>

            <!-- 2. æˆ‘çš„å‘å¸ƒ -->
            <div id="section-posts" style="display: none;">
                <h2 class="section-title">æˆ‘å‘å¸ƒçš„è¯é¢˜</h2>
                <div id="my-posts-list">
                    <p style="color:#94a3b8; text-align:center; padding:40px;">åŠ è½½ä¸­...</p>
                </div>
            </div>

        </main>
    </div>

    <!-- Footer -->
    <footer>
        <div class="standard-container">
            <div class="footer-grid">
                <div class="footer-col brand-col">
                    <h4 style="font-size:1.2rem;">AeroScope Insight</h4>
                    <p style="font-size:0.9rem; color:#94a3b8; line-height: 1.6; margin-bottom: 20px;">
                        è¿æ¥æ”¿ç­–ã€èµ„æœ¬ä¸æŠ€æœ¯ï¼Œæ‰“é€ ä½ç©ºç»æµé¢†åŸŸçš„æ•°å­—åŒ–åŸºç¡€è®¾æ–½ä¸å†³ç­–å¼•æ“ã€‚
                    </p>
                    <div class="social-icons">
                        <a href="#" class="social-btn"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></a>
                        <a href="#" class="social-btn"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a>
                        <a href="mailto:contact@aeroscope.cn" class="social-btn"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a>
                    </div>
                </div>
                <div class="footer-col"><h4>æ ¸å¿ƒæ¿å—</h4><ul><li><a href="news.html">èµ„è®¯å¿«æŠ¥</a></li><li><a href="policies.html">æ”¿ç­–æ³•è§„</a></li><li><a href="companies.html">ä¼ä¸šæ•°æ®åº“</a></li></ul></div>
                <div class="footer-col"><h4>æ•°æ®å›¾è°±</h4><ul><li><a href="chart-funding.html">å…¨çƒèèµ„è¶‹åŠ¿</a></li><li><a href="chart-cities.html">è¯•ç‚¹åŸå¸‚åˆ†å¸ƒ</a></li><li><a href="chart-companies.html">äº§ä¸šé“¾å…¨æ™¯å›¾</a></li></ul></div>
                <div class="footer-col">
                    <h4>å…³äº</h4>
                    <ul>
                        <li><a href="about.html">å›¢é˜Ÿæ„¿æ™¯</a></li>
                        <li><a href="submit-report.html">å¯»æ±‚æŠ¥é“</a></li>
                        <li><a href="contact.html">å•†åŠ¡åˆä½œ</a></li>
                    </ul>
                </div>
            </div>
            <div class="copyright" style="border-top:1px solid #334155; padding-top:20px; margin-top:20px; text-align:center; color:#64748b; font-size:0.85rem;">&copy; 2025 AeroScope Insight. All rights reserved.</div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://ulfktuvatxyakrdrwxfq.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVsZmt0dXZhdHh5YWtyZHJ3eGZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NDYyMjksImV4cCI6MjA4MDIyMjIyOX0.SBvHgp9HK_Lr5vXCgwu4Ae-Q6hH4dhMx3JSRbLiU0fU';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let currentUserId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) return location.href = 'login.html';
            
            currentUserId = session.user.id;
            loadProfile();
            loadMyPosts();
        });

        // 1. åŠ è½½èµ„æ–™
        async function loadProfile() {
            const { data: profile } = await _supabase.from('profiles').select('*').eq('id', currentUserId).single();
            if(!profile) return;

            // å¡«å……è¡¨å•
            document.getElementById('email').value = profile.email;
            document.getElementById('username').value = profile.username || '';
            document.getElementById('phone').value = profile.phone || '';
            document.getElementById('company').value = profile.company_name || '';
            document.getElementById('role').value = profile.job_title || '';
            
            // å·¦ä¾§å¡ç‰‡
            const displayName = profile.username || profile.email.split('@')[0];
            document.getElementById('display-name').innerText = displayName;
            document.getElementById('avatar-text').innerText = displayName.charAt(0).toUpperCase();

            // å¾½ç« é€»è¾‘
            const badgeContainer = document.getElementById('role-badge-container');
            if (profile.is_expert) {
                badgeContainer.innerHTML = `<span class="user-role-badge user-expert-badge">è®¤è¯ä¸“å®¶</span>`;
            } else {
                badgeContainer.innerHTML = `<span class="user-role-badge">${profile.tier === 'pro' ? 'Pro ä¼šå‘˜' : 'æ™®é€šç”¨æˆ·'}</span>`;
            }

            // ç®¡ç†å‘˜å…¥å£
            if (profile.is_admin) {
                document.getElementById('admin-entry').style.display = 'block';
            }
        }

        // 2. åŠ è½½æˆ‘çš„å‘å¸ƒ
        async function loadMyPosts() {
            const container = document.getElementById('my-posts-list');
            const { data } = await _supabase.from('forum_topics').select('*').eq('user_id', currentUserId).order('created_at', {ascending:false});
            
            if (!data || !data.length) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#94a3b8;">æ‚¨è¿˜æ²¡æœ‰å‘å¸ƒè¿‡è¯é¢˜</div>';
                return;
            }

            container.innerHTML = '';
            data.forEach(t => {
                container.innerHTML += `
                    <div class="list-item">
                        <div class="item-main">
                            <a href="forum-topic.html?id=${t.id}" target="_blank">${t.title}</a>
                            <div class="item-sub">
                                å‘å¸ƒäº ${new Date(t.created_at).toLocaleDateString()} Â· 
                                ğŸ”¥ ${t.heat_score} Â· 
                                ğŸ’¬ ${t.comments_count}
                            </div>
                        </div>
                        <button class="btn-sm" onclick="deleteTopic('${t.id}')">åˆ é™¤</button>
                    </div>
                `;
            });
        }

        // 3. æ›´æ–°èµ„æ–™
        async function updateProfile() {
            const btn = document.querySelector('.btn-primary');
            const msg = document.getElementById('save-msg');
            btn.innerText = 'ä¿å­˜ä¸­...';
            btn.disabled = true;

            const updates = {
                username: document.getElementById('username').value,
                phone: document.getElementById('phone').value,
                company_name: document.getElementById('company').value,
                job_title: document.getElementById('role').value,
                updated_at: new Date()
            };

            const { error } = await _supabase.from('profiles').update(updates).eq('id', currentUserId);
            
            btn.innerText = 'ä¿å­˜ä¿®æ”¹';
            btn.disabled = false;
            msg.style.display = 'inline';
            
            if (error) {
                msg.style.color = '#ef4444';
                msg.innerText = 'ä¿å­˜å¤±è´¥: ' + error.message;
            } else {
                msg.style.color = '#10b981';
                msg.innerText = 'ä¿å­˜æˆåŠŸ';
                loadProfile(); // åˆ·æ–°å·¦ä¾§å¡ç‰‡
                setTimeout(() => msg.style.display = 'none', 3000);
            }
        }

        // 4. åˆ é™¤è¯é¢˜
        async function deleteTopic(id) {
            if(!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è¯é¢˜å—ï¼Ÿä¸å¯æ¢å¤ã€‚')) return;
            const { error } = await _supabase.from('forum_topics').delete().eq('id', id);
            if(error) alert('åˆ é™¤å¤±è´¥');
            else loadMyPosts();
        }

        // 5. åˆ‡æ¢æ¿å—
        function switchSection(sec, btn) {
            document.getElementById('section-info').style.display = 'none';
            document.getElementById('section-posts').style.display = 'none';
            document.getElementById('section-' + sec).style.display = 'block';
            
            document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        async function logout() {
            await _supabase.auth.signOut();
            window.location.href = 'index.html';
        }

        function toggleMenu() { document.getElementById('navMenu').classList.toggle('active'); }
        
        let searchTimeout;
        async function performGlobalSearch(keyword) {
            // å¤ç”¨å…¶ä»–é¡µé¢çš„æœç´¢é€»è¾‘
            const dropdown = document.getElementById('search-dropdown');
            if (!keyword || keyword.length < 1) { dropdown.style.display = 'none'; return; }
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                dropdown.style.display = 'block';
                dropdown.innerHTML = '<div style="padding:12px; text-align:center; color:#94a3b8;">æœç´¢ä¸­...</div>';
                const { data, error } = await _supabase.from('global_search_view').select('*').ilike('title', `%${keyword}%`).limit(5);
                if (error || !data.length) { dropdown.innerHTML = '<div style="padding:12px; text-align:center;">æ— ç»“æœ</div>'; return; }
                let html = '';
                data.forEach(item => {
                    let link=`news-detail.html?id=${item.id}`;
                    if(item.type==='company') link='companies.html';
                    else if(item.type==='policy') link=`policy-detail.html?id=${item.id}`;
                    else if(item.type==='tech') link=`tech-detail.html?id=${item.id}`;
                    html += `<a href="${link}" class="search-result-item">${item.title}</a>`;
                });
                dropdown.innerHTML = html;
            }, 500);
        }
        document.addEventListener('click', (e) => { if(!document.querySelector('.search-component').contains(e.target)) document.getElementById('search-dropdown').style.display='none'; });
    </script>
</body>
</html>