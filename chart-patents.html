<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸“åˆ©æŠ€æœ¯åº“ | AeroScope Insight</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ä¸“åˆ©åˆ—è¡¨æ ·å¼ */
        .patent-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
            margin-bottom: 60px;
        }
        
        .patent-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
            display: block;
            text-decoration: none;
            color: inherit;
        }
        
        .patent-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-color: #3b82f6;
        }
        
        .patent-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .patent-title-container {
            flex: 1;
            min-width: 0;
        }
        
        .patent-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #0f172a;
            line-height: 1.4;
            margin-bottom: 5px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .patent-meta {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.85rem;
            color: #64748b;
            flex-wrap: wrap;
        }
        
        .patent-id {
            font-size: 0.85rem;
            color: #3b82f6;
            background: #eff6ff;
            padding: 4px 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            white-space: nowrap;
        }
        
        .legal-status-badge {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .status-valid {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-invalid {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .patent-applicant {
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        
        .applicant-name {
            font-weight: 600;
            color: #0f172a;
            cursor: pointer;
            transition: color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .applicant-name:hover {
            color: #3b82f6;
            text-decoration: underline;
        }
        
        .patent-abstract {
            font-size: 0.9rem;
            color: #475569;
            line-height: 1.5;
            margin-bottom: 15px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .patent-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .patent-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .patent-tag {
            background: #f1f5f9;
            color: #475569;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            white-space: nowrap;
        }
        
        .patent-tag.category {
            background: #dbeafe;
            color: #1d4ed8;
        }
        
        .patent-tag.chain-upstream {
            background: #ecfdf5;
            color: #059669;
        }
        
        .patent-tag.chain-midstream {
            background: #e0f2fe;
            color: #0284c7;
        }
        
        .patent-tag.chain-downstream {
            background: #fffbeb;
            color: #d97706;
        }
        
        .patent-citation {
            font-size: 0.85rem;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* ç­›é€‰æ æ ·å¼ */
        .filter-bar {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 15px 0;
            position: sticky;
            top: 64px;
            z-index: 90;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        
        .filter-inner {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            background-color: #f8fafc;
            color: #334155;
            font-size: 0.9rem;
            outline: none;
            cursor: pointer;
            min-width: 150px;
        }
        
        .filter-select:focus {
            border-color: #3b82f6;
            background: white;
        }
        
        .local-search {
            flex-grow: 1;
            padding: 8px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 0.9rem;
            max-width: 300px;
        }
        
        /* ç»Ÿè®¡æ•°æ®æ ·å¼ */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 30px 0;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #64748b;
        }
        
        /* åˆ†é¡µæ ·å¼ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 40px 0 20px;
            padding: 20px 0;
            border-top: 1px solid #e2e8f0;
        }
        
        .pagination-btn {
            padding: 8px 16px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            color: #475569;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }
        
        .pagination-info {
            font-size: 0.9rem;
            color: #64748b;
            margin: 0 15px;
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: #f8fafc;
            border-radius: 10px;
            margin: 30px 0;
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #cbd5e1;
        }
        
        .empty-state-title {
            font-size: 1.2rem;
            color: #475569;
            margin-bottom: 10px;
        }
        
        .empty-state-desc {
            color: #94a3b8;
            font-size: 0.9rem;
            max-width: 400px;
            margin: 0 auto;
        }
        
        @media (max-width: 1024px) {
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .patent-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .patent-id {
                align-self: flex-start;
            }
            
            .filter-inner {
                flex-direction: column;
                align-items: stretch;
            }
            
            .local-search {
                max-width: 100%;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .pagination {
                flex-wrap: wrap;
            }
            
            .patent-footer {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- 1. Header -->
    <header>
        <div class="standard-container">
            <div class="nav-inner">
                <a href="index.html" class="logo">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                    AeroScope<span>Insight</span>
                </a>
                <button class="mobile-menu-btn" onclick="toggleMenu()">â˜°</button>
                <nav class="nav-links" id="navMenu">
                    <a href="index.html">é¦–é¡µ</a>
                    <a href="news.html">èµ„è®¯å¿«æŠ¥</a>
                    <a href="policies.html">æ”¿ç­–æ³•è§„</a>
                    <a href="tech.html">æŠ€æœ¯å‰æ²¿</a>
                    <a href="companies.html">å…¬å¸æ•°æ®åº“</a>
                    <a href="forum.html">è®ºå›äº¤æµ</a>
                </nav>
                <div class="header-actions">
                    <div class="search-component">
                        <div class="search-box">
                            <span class="search-icon">ğŸ”</span>
                            <input type="text" class="search-input" placeholder="æœä¸“åˆ©ã€ç”³è¯·äºº..." id="global-search" onkeyup="performGlobalSearch(this.value)">
                        </div>
                        <div id="search-dropdown"></div>
                    </div>
                    <button class="btn btn-primary" id="auth-btn" onclick="location.href='login.html'">ç™»å½•/æ³¨å†Œ</button>
                </div>
            </div>
        </div>
    </header>

    <!-- 2. Hero Section -->
    <section class="page-hero">
        <div class="standard-container">
            <h1>ä¸“åˆ©æŠ€æœ¯åº“</h1>
            <p>æ”¶å½•å…¨çƒä½ç©ºç»æµé¢†åŸŸä¸“åˆ©æŠ€æœ¯ï¼Œæ´å¯ŸæŠ€æœ¯å‘å±•è¶‹åŠ¿ä¸ç«äº‰æ ¼å±€</p>
        </div>
    </section>

    <!-- 3. ç»Ÿè®¡æ•°æ® -->
    <div class="standard-container">
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-number" id="total-patents">--</div>
                <div class="stat-label">ç´¯è®¡ä¸“åˆ©</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-applicants">--</div>
                <div class="stat-label">ç”³è¯·æœºæ„</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avg-citations">--</div>
                <div class="stat-label">å¹³å‡å¼•ç”¨</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="recent-patents">--</div>
                <div class="stat-label">ä»Šå¹´æ–°å¢</div>
            </div>
        </div>
    </div>

    <!-- 4. ç­›é€‰æ  -->
    <div class="filter-bar">
        <div class="standard-container filter-inner">
            <select id="filter-chain" class="filter-select" onchange="applyFiltersAndPagination()">
                <option value="all">ğŸ”— å…¨äº§ä¸šé“¾</option>
                <option value="upstream">âš¡ ä¸Šæ¸¸</option>
                <option value="midstream">âœˆï¸ ä¸­æ¸¸</option>
                <option value="downstream">ğŸ·ï¸ ä¸‹æ¸¸</option>
            </select>

            <select id="filter-type" class="filter-select" onchange="applyFiltersAndPagination()">
                <option value="all">ğŸ“„ æ‰€æœ‰ç±»å‹</option>
                <option value="å‘æ˜ä¸“åˆ©">å‘æ˜ä¸“åˆ©</option>
                <option value="å®ç”¨æ–°å‹">å®ç”¨æ–°å‹</option>
                <option value="å¤–è§‚è®¾è®¡">å¤–è§‚è®¾è®¡</option>
                <option value="å›½é™…ä¸“åˆ©">å›½é™…ä¸“åˆ©</option>
            </select>

            <select id="filter-category" class="filter-select" onchange="applyFiltersAndPagination()">
                <option value="all">ğŸ·ï¸ æ‰€æœ‰æŠ€æœ¯åˆ†ç±»</option>
                <option value="eVTOL">eVTOLæŠ€æœ¯</option>
                <option value="ç”µæ± ">ç”µæ± æŠ€æœ¯</option>
                <option value="é£æ§">é£æ§ç³»ç»Ÿ</option>
                <option value="é€šä¿¡">é€šä¿¡æŠ€æœ¯</option>
                <option value="å¯¼èˆª">å¯¼èˆªæŠ€æœ¯</option>
                <option value="ææ–™">æ–°å‹ææ–™</option>
                <option value="å®‰å…¨">å®‰å…¨ç³»ç»Ÿ</option>
                <option value="èƒ½æº">èƒ½æºç®¡ç†</option>
                <option value="ç‰©æµ">ç‰©æµé…é€</option>
                <option value="AI">äººå·¥æ™ºèƒ½</option>
            </select>

            <select id="filter-year" class="filter-select" onchange="applyFiltersAndPagination()">
                <option value="all">ğŸ“… æ‰€æœ‰å¹´ä»½</option>
                <option value="2025">2025å¹´</option>
                <option value="2024">2024å¹´</option>
                <option value="2023">2023å¹´</option>
                <option value="2022">2022å¹´</option>
                <option value="2021">2021å¹´åŠä»¥å‰</option>
            </select>

            <input type="text" id="filter-search" class="local-search" placeholder="æœç´¢ä¸“åˆ©æ ‡é¢˜ã€ç”³è¯·äºº..." 
                   onkeyup="debounceSearch()">
        </div>
    </div>

    <!-- 5. ä¸“åˆ©åˆ—è¡¨å®¹å™¨ -->
    <div class="standard-container">
        <div class="patent-list" id="patent-container">
            <p style="text-align: center; color: #94a3b8; padding: 40px;">
                æ­£åœ¨åŠ è½½ä¸“åˆ©æ•°æ®...
            </p>
        </div>
        
        <!-- åˆ†é¡µæ§ä»¶ -->
        <div class="pagination" id="pagination" style="display: none;">
            <button class="pagination-btn" id="first-page" onclick="goToPage(1)">é¦–é¡µ</button>
            <button class="pagination-btn" id="prev-page" onclick="goToPrevPage()">ä¸Šä¸€é¡µ</button>
            
            <div id="page-numbers" style="display: flex; gap: 5px;"></div>
            
            <button class="pagination-btn" id="next-page" onclick="goToNextPage()">ä¸‹ä¸€é¡µ</button>
            <button class="pagination-btn" id="last-page" onclick="goToLastPage()">æœ«é¡µ</button>
            
            <div class="pagination-info" id="page-info"></div>
        </div>
    </div>

    <!-- 6. Footer -->
    <footer>
        <div class="standard-container">
            <div class="footer-grid">
                <div class="footer-col brand-col">
                    <h4 style="font-size:1.2rem;">AeroScope Insight</h4>
                    <p style="font-size:0.9rem; color:#94a3b8; line-height: 1.6; margin-bottom: 20px;">
                        è¿æ¥æ”¿ç­–ã€èµ„æœ¬ä¸æŠ€æœ¯ï¼Œæ‰“é€ ä½ç©ºç»æµé¢†åŸŸçš„æ•°å­—åŒ–åŸºç¡€è®¾æ–½ä¸å†³ç­–å¼•æ“ã€‚
                    </p>
                    <div class="social-icons">
                        <a href="#" class="social-btn"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></a>
                        <a href="#" class="social-btn"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a>
                        <a href="mailto:contact@aeroscope.cn" class="social-btn"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4>æ ¸å¿ƒæ¿å—</h4>
                    <ul>
                        <li><a href="news.html">èµ„è®¯å¿«æŠ¥</a></li>
                        <li><a href="policies.html">æ”¿ç­–æ³•è§„</a></li>
                        <li><a href="patents.html">ä¸“åˆ©æŠ€æœ¯åº“</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>æ•°æ®å›¾è°±</h4>
                    <ul>
                        <li><a href="chart-funding.html">å…¨çƒèèµ„è¶‹åŠ¿</a></li>
                        <li><a href="chart-cities.html">è¯•ç‚¹åŸå¸‚åˆ†å¸ƒ</a></li>
                        <li><a href="chart-patents.html">æŠ€æœ¯åˆ†å¸ƒå›¾è°±</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>å…³äº</h4>
                    <ul>
                        <li><a href="about.html">å›¢é˜Ÿæ„¿æ™¯</a></li>
                        <li><a href="submit-report.html">å¯»æ±‚æŠ¥é“</a></li>
                        <li><a href="contact.html">å•†åŠ¡åˆä½œ</a></li>
                    </ul>
                </div>
            </div>
            <div class="copyright" style="border-top:1px solid #334155; padding-top:20px; margin-top:20px; text-align:center; color:#64748b; font-size:0.85rem;">
                &copy; 2025 AeroScope Insight. All rights reserved. äº¬ICPå¤‡XXXXXXXXå·
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://ulfktuvatxyakrdrwxfq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVsZmt0dXZhdHh5YWtyZHJ3eGZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NDYyMjksImV4cCI6MjA4MDIyMjIyOX0.SBvHgp9HK_Lr5vXCgwu4Ae-Q6hH4dhMx3JSRbLiU0fU';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);
    
        // å…¨å±€å˜é‡
        let allPatents = [];
        let filteredPatents = [];
        let companiesMap = new Map();
        let currentPage = 1;
        const patentsPerPage = 10; // æ¯é¡µæ˜¾ç¤º10æ¡
        
        // é˜²æŠ–å˜é‡
        let searchDebounceTimeout;
        let filterDebounceTimeout;
    
        document.addEventListener('DOMContentLoaded', async function() {
            checkUserLogin();
            await fetchCompanies();
            await fetchPatents();
            
            // åˆå§‹åŒ–ç­›é€‰å™¨äº‹ä»¶ç›‘å¬
            document.getElementById('filter-chain').addEventListener('change', () => applyFiltersAndPagination());
            document.getElementById('filter-type').addEventListener('change', () => applyFiltersAndPagination());
            document.getElementById('filter-category').addEventListener('change', () => applyFiltersAndPagination());
            document.getElementById('filter-year').addEventListener('change', () => applyFiltersAndPagination());
        });
    
        // é˜²æŠ–æœç´¢å‡½æ•°
        function debounceSearch() {
            clearTimeout(searchDebounceTimeout);
            searchDebounceTimeout = setTimeout(() => {
                applyFiltersAndPagination();
            }, 300);
        }
        
        function applyFiltersAndPagination() {
            clearTimeout(filterDebounceTimeout);
            filterDebounceTimeout = setTimeout(() => {
                applyLocalFilters();
                updatePagination();
                renderPatents();
            }, 100);
        }
    
        async function fetchCompanies() {
            try {
                const { data, error } = await _supabase
                    .from('companies')
                    .select('id, name, logo_url, primary_category')
                    .eq('draft', false);
                    
                if (error) throw error;
                
                if (data) {
                    data.forEach(company => {
                        companiesMap.set(company.name, {
                            id: company.id,
                            logo_url: company.logo_url,
                            category: company.primary_category
                        });
                    });
                    console.log(`å·²åŠ è½½ ${companiesMap.size} å®¶å…¬å¸æ•°æ®`);
                }
            } catch (error) {
                console.error('è·å–å…¬å¸æ•°æ®å¤±è´¥:', error);
            }
        }
    
        async function fetchPatents() {
            const container = document.getElementById('patent-container');
            
            try {
                const { data, error } = await _supabase
                    .from('patents')
                    .select('*')
                    .order('application_date', { ascending: false });
    
                if (error) {
                    console.error('æ•°æ®åº“æŸ¥è¯¢é”™è¯¯:', error);
                    
                    if (error.message.includes('does not exist')) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">âš ï¸</div>
                                <div class="empty-state-title">ä¸“åˆ©è¡¨ä¸å­˜åœ¨</div>
                                <div class="empty-state-desc">
                                    è¯·åœ¨ Supabase ä¸­åˆ›å»º patents è¡¨ã€‚å»ºè®®æ‰§è¡ŒSQLæ–‡ä»¶ä¸­çš„ä¸“åˆ©è¡¨åˆ›å»ºè„šæœ¬ã€‚
                                </div>
                            </div>
                        `;
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">âŒ</div>
                                <div class="empty-state-title">æ•°æ®åŠ è½½å¤±è´¥</div>
                                <div class="empty-state-desc">${error.message}</div>
                            </div>
                        `;
                    }
                    return;
                }
                
                if (!data || data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“‹</div>
                            <div class="empty-state-title">æš‚æ— ä¸“åˆ©æ•°æ®</div>
                            <div class="empty-state-desc">ä¸“åˆ©è¡¨å·²å­˜åœ¨ï¼Œä½†è¿˜æ²¡æœ‰æ•°æ®ã€‚è¯·é€šè¿‡ Supabase æ§åˆ¶å°æ’å…¥æ•°æ®ã€‚</div>
                        </div>
                    `;
                    return;
                }
    
                console.log(`æˆåŠŸåŠ è½½ ${data.length} æ¡ä¸“åˆ©æ•°æ®`);
                allPatents = data;
                filteredPatents = [...allPatents];
                
                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                updateStats(allPatents);
                // åˆå§‹æ¸²æŸ“
                applyFiltersAndPagination();
                
            } catch (error) {
                console.error('è·å–ä¸“åˆ©æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸš¨</div>
                        <div class="empty-state-title">ç³»ç»Ÿé”™è¯¯</div>
                        <div class="empty-state-desc">${error.message}</div>
                    </div>
                `;
            }
        }
    
        function updateStats(patents) {
            try {
                // æ€»ä¸“åˆ©æ•°
                const totalEl = document.getElementById('total-patents');
                if (totalEl) totalEl.textContent = patents.length;
                
                // ç”³è¯·æœºæ„æ•°
                const applicants = new Set();
                patents.forEach(p => {
                    if (p.applicant && p.applicant.trim()) {
                        applicants.add(p.applicant.trim());
                    }
                });
                const applicantsEl = document.getElementById('total-applicants');
                if (applicantsEl) applicantsEl.textContent = applicants.size;
                
                // å¹³å‡å¼•ç”¨æ•°
                const validCitations = patents
                    .filter(p => p.citation_count && !isNaN(p.citation_count))
                    .map(p => parseInt(p.citation_count));
                
                let avgCitations = 0;
                if (validCitations.length > 0) {
                    const sum = validCitations.reduce((a, b) => a + b, 0);
                    avgCitations = Math.round(sum / validCitations.length);
                }
                const avgEl = document.getElementById('avg-citations');
                if (avgEl) avgEl.textContent = avgCitations;
                
                // ä»Šå¹´æ–°å¢
                const currentYear = new Date().getFullYear();
                const recent = patents.filter(p => {
                    if (!p.application_date) return false;
                    try {
                        const date = new Date(p.application_date);
                        return date.getFullYear() === currentYear;
                    } catch (e) {
                        return false;
                    }
                }).length;
                const recentEl = document.getElementById('recent-patents');
                if (recentEl) recentEl.textContent = recent;
                
            } catch (error) {
                console.error('æ›´æ–°ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }
    
        function applyLocalFilters() {
            try {
                const chainVal = document.getElementById('filter-chain').value;
                const typeVal = document.getElementById('filter-type').value;
                const catVal = document.getElementById('filter-category').value;
                const yearVal = document.getElementById('filter-year').value;
                const searchVal = document.getElementById('filter-search').value.toLowerCase().trim();
    
                filteredPatents = allPatents.filter(patent => {
                    // äº§ä¸šé“¾ç­›é€‰
                    if (chainVal !== 'all' && patent.industry_chain_position !== chainVal) return false;
                    
                    // ä¸“åˆ©ç±»å‹ç­›é€‰
                    if (typeVal !== 'all' && patent.patent_type !== typeVal) return false;
                    
                    // æŠ€æœ¯åˆ†ç±»ç­›é€‰ - ä¿®å¤ï¼šæ£€æŸ¥æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ 
                    if (catVal !== 'all' && catVal) {
                        const categories = patent.technical_categories || [];
                        if (!Array.isArray(categories)) return false;
                        
                        // æ£€æŸ¥æ˜¯å¦åŒ…å«æŒ‡å®šçš„åˆ†ç±»ï¼ˆå®Œå…¨åŒ¹é…æˆ–éƒ¨åˆ†åŒ¹é…ï¼‰
                        const hasCategory = categories.some(cat => {
                            if (!cat) return false;
                            const catLower = cat.toLowerCase();
                            const valLower = catVal.toLowerCase();
                            return catLower.includes(valLower) || valLower.includes(catLower);
                        });
                        if (!hasCategory) return false;
                    }
                    
                    // å¹´ä»½ç­›é€‰
                    if (yearVal !== 'all' && patent.application_date) {
                        try {
                            const date = new Date(patent.application_date);
                            const patentYear = date.getFullYear().toString();
                            
                            if (yearVal === '2021') {
                                // 2021å¹´åŠä»¥å‰
                                if (parseInt(patentYear) > 2021) return false;
                            } else if (patentYear !== yearVal) {
                                return false;
                            }
                        } catch (e) {
                            return false;
                        }
                    }
                    
                    // å…³é”®è¯æœç´¢
                    if (searchVal) {
                        const searchFields = [
                            patent.title || '',
                            patent.applicant || '',
                            patent.abstract || '',
                            patent.patent_number || ''
                        ];
                        
                        const hasMatch = searchFields.some(field => 
                            field.toLowerCase().includes(searchVal)
                        );
                        
                        // ä¹Ÿæœç´¢åˆ†ç±»æ ‡ç­¾
                        if (!hasMatch && patent.technical_categories) {
                            const categoryMatch = (patent.technical_categories || []).some(cat => 
                                cat && cat.toLowerCase().includes(searchVal)
                            );
                            if (!categoryMatch) return false;
                        } else if (!hasMatch) {
                            return false;
                        }
                    }
                    
                    return true;
                });
                
                // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                currentPage = 1;
                
            } catch (error) {
                console.error('ç­›é€‰ä¸“åˆ©æ—¶å‘ç”Ÿé”™è¯¯:', error);
            }
        }
    
        function renderPatents() {
            const container = document.getElementById('patent-container');
            if (!container) return;
            
            container.innerHTML = '';
    
            if (!filteredPatents || filteredPatents.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ”</div>
                        <div class="empty-state-title">æœªæ‰¾åˆ°åŒ¹é…çš„ä¸“åˆ©</div>
                        <div class="empty-state-desc">å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–æœç´¢å…³é”®è¯</div>
                    </div>
                `;
                return;
            }
            
            // è®¡ç®—åˆ†é¡µ
            const totalPages = Math.ceil(filteredPatents.length / patentsPerPage);
            const startIndex = (currentPage - 1) * patentsPerPage;
            const endIndex = startIndex + patentsPerPage;
            const currentPatents = filteredPatents.slice(startIndex, endIndex);
    
            currentPatents.forEach(patent => {
                // å®‰å…¨åœ°å¤„ç†æ•°æ®
                const title = patent.title || 'æœªå‘½åä¸“åˆ©';
                const patentNumber = patent.patent_number || 'æœªå…¬å¼€';
                const type = patent.patent_type || 'å‘æ˜ä¸“åˆ©';
                const applicant = patent.applicant || 'æœªçŸ¥ç”³è¯·äºº';
                const abstract = patent.abstract || 'æš‚æ— æ‘˜è¦ä¿¡æ¯';
                const categories = Array.isArray(patent.technical_categories) ? patent.technical_categories : [];
                const country = patent.applicant_country || 'ä¸­å›½';
                const citationCount = parseInt(patent.citation_count) || 0;
                const legalStatus = patent.legal_status || 'å®¡ä¸­';
                const chainPosition = patent.industry_chain_position || '';
                
                // æ ¼å¼åŒ–æ—¥æœŸ
                let appDate = 'æœªçŸ¥æ—¥æœŸ';
                if (patent.application_date) {
                    try {
                        const date = new Date(patent.application_date);
                        if (!isNaN(date.getTime())) {
                            appDate = date.toLocaleDateString('zh-CN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit'
                            });
                        }
                    } catch (e) {
                        console.warn('æ—¥æœŸæ ¼å¼é”™è¯¯:', patent.application_date);
                    }
                }
                
                // è·å–æ³•å¾‹çŠ¶æ€æ ·å¼
                let statusClass = 'status-pending';
                let statusText = legalStatus;
                
                if (legalStatus === 'æœ‰æ•ˆ') {
                    statusClass = 'status-valid';
                } else if (legalStatus === 'æ— æ•ˆ' || legalStatus === 'ç»ˆæ­¢' || legalStatus === 'æ’¤å›' || legalStatus === 'æ”¾å¼ƒ') {
                    statusClass = 'status-invalid';
                    statusText = 'æ— æ•ˆ';
                }
                
                // ç”³è¯·äººå¤„ç† - æ£€æŸ¥æ˜¯å¦åŒ¹é…å…¬å¸
                let applicantHtml = '';
                const companyInfo = companiesMap.get(applicant);
                
                if (companyInfo && companyInfo.id) {
                    // æœ‰å¯¹åº”å…¬å¸ï¼Œæ·»åŠ è·³è½¬é“¾æ¥
                    applicantHtml = `
                        <a href="company-detail.html?id=${companyInfo.id}" class="applicant-name">
                            ${applicant}
                        </a>
                    `;
                } else {
                    // æ²¡æœ‰å¯¹åº”å…¬å¸ï¼Œåªæ˜¾ç¤ºåç§°
                    applicantHtml = `
                        <span class="applicant-name" style="cursor:default; color:#475569;">${applicant}</span>
                    `;
                }
                
                // ç”Ÿæˆæ ‡ç­¾
                let tagsHtml = '';
                if (categories.length > 0) {
                    categories.slice(0, 3).forEach((cat, index) => {
                        if (cat && cat.trim()) {
                            tagsHtml += `<span class="patent-tag category">${cat.trim()}</span>`;
                        }
                    });
                }
                
                // æ·»åŠ äº§ä¸šé“¾æ ‡ç­¾
                if (chainPosition) {
                    let chainClass = '';
                    if (chainPosition === 'upstream') {
                        chainClass = 'chain-upstream';
                    } else if (chainPosition === 'midstream') {
                        chainClass = 'chain-midstream';
                    } else if (chainPosition === 'downstream') {
                        chainClass = 'chain-downstream';
                    }
                    tagsHtml += `<span class="patent-tag ${chainClass}">${chainPosition === 'upstream' ? 'âš¡ ä¸Šæ¸¸' : chainPosition === 'midstream' ? 'âœˆï¸ ä¸­æ¸¸' : 'ğŸ·ï¸ ä¸‹æ¸¸'}</span>`;
                }
                
                // æ·»åŠ ä¸“åˆ©ç±»å‹æ ‡ç­¾
                if (type) {
                    tagsHtml += `<span class="patent-tag">${type}</span>`;
                }
                
                const html = `
                    <a href="patent-detail.html?id=${patent.id}" class="patent-item">
                        <div class="patent-header">
                            <div class="patent-title-container">
                                <div class="patent-title">
                                    <span class="legal-status-badge ${statusClass}">${statusText}</span>
                                    ${title}
                                </div>
                                <div class="patent-meta">
                                    <span>ğŸ“… ${appDate}</span>
                                    <span>ğŸ“ ${country}</span>
                                    ${citationCount > 0 ? `<span>ğŸ”— ${citationCount} å¼•ç”¨</span>` : ''}
                                </div>
                            </div>
                            <div class="patent-id">${patentNumber}</div>
                        </div>
                        
                        <div class="patent-applicant">
                            ${applicantHtml}
                        </div>
                        
                        <div class="patent-abstract">
                            ${abstract}
                        </div>
                        
                        <div class="patent-footer">
                            <div class="patent-tags">
                                ${tagsHtml}
                            </div>
                            ${citationCount > 0 ? `
                                <div class="patent-citation">
                                    <span>å¼•ç”¨: ${citationCount}</span>
                                </div>
                            ` : ''}
                        </div>
                    </a>
                `;
                
                container.innerHTML += html;
            });
        }
        
        // åˆ†é¡µç›¸å…³å‡½æ•°
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(filteredPatents.length / patentsPerPage);
            
            if (filteredPatents.length <= patentsPerPage) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            
            // æ›´æ–°é¡µé¢ä¿¡æ¯
            const pageInfo = document.getElementById('page-info');
            const startIndex = (currentPage - 1) * patentsPerPage + 1;
            const endIndex = Math.min(currentPage * patentsPerPage, filteredPatents.length);
            pageInfo.textContent = `ç¬¬ ${startIndex}-${endIndex} æ¡ï¼Œå…± ${filteredPatents.length} æ¡`;
            
            // æ›´æ–°é¡µç æŒ‰é’®
            const pageNumbers = document.getElementById('page-numbers');
            pageNumbers.innerHTML = '';
            
            // æ˜¾ç¤ºé¡µç èŒƒå›´
            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
            
            if (endPage - startPage + 1 < maxPagesToShow) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = 'pagination-btn';
                if (i === currentPage) {
                    pageBtn.classList.add('active');
                }
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToPage(i);
                pageNumbers.appendChild(pageBtn);
            }
            
            // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
            document.getElementById('first-page').disabled = currentPage === 1;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
            document.getElementById('last-page').disabled = currentPage === totalPages;
        }
        
        function goToPage(page) {
            currentPage = page;
            renderPatents();
            updatePagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function goToPrevPage() {
            if (currentPage > 1) {
                goToPage(currentPage - 1);
            }
        }
        
        function goToNextPage() {
            const totalPages = Math.ceil(filteredPatents.length / patentsPerPage);
            if (currentPage < totalPages) {
                goToPage(currentPage + 1);
            }
        }
        
        function goToLastPage() {
            const totalPages = Math.ceil(filteredPatents.length / patentsPerPage);
            goToPage(totalPages);
        }
    
        // å…¨å±€æœç´¢åŠŸèƒ½
        let searchTimeout;
        async function performGlobalSearch(keyword) {
            const dropdown = document.getElementById('search-dropdown');
            if (!dropdown) return;
            
            if (!keyword || keyword.length < 1) { 
                dropdown.style.display = 'none'; 
                return; 
            }
            
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                dropdown.style.display = 'block';
                dropdown.innerHTML = '<div style="padding:12px; text-align:center; color:#94a3b8;">æœç´¢ä¸­...</div>';
                
                try {
                    const { data, error } = await _supabase
                        .from('global_search_view')
                        .select('*')
                        .ilike('title', `%${keyword}%`)
                        .limit(8);
                        
                    if (error) {
                        dropdown.innerHTML = '<div style="padding:12px; color:#ef4444;">æœç´¢å‡ºé”™</div>';
                        return;
                    }
                    
                    if (!data || data.length === 0) {
                        dropdown.innerHTML = '<div style="padding:12px; text-align:center; color:#64748b;">æ— ç›¸å…³ç»“æœ</div>';
                        return;
                    }
                    
                    let html = '';
                    data.forEach(item => {
                        let link = '#';
                        let color = '#3b82f6';
                        let typeName = 'èµ„è®¯';
                        
                        if(item.type === 'company') { 
                            link = 'companies.html'; 
                            color='#f59e0b'; 
                            typeName='å…¬å¸'; 
                        } else if(item.type === 'policy') { 
                            link = `policy-detail.html?id=${item.id}`; 
                            color='#ef4444'; 
                            typeName='æ”¿ç­–'; 
                        } else if(item.type === 'tech') { 
                            link = `tech-detail.html?id=${item.id}`; 
                            color='#8b5cf6'; 
                            typeName='æŠ€æœ¯'; 
                        } else if(item.type === 'patent') { 
                            link = 'patent-detail.html?id=' + (item.id || ''); 
                            color='#10b981'; 
                            typeName='ä¸“åˆ©'; 
                        } else { 
                            link = `news-detail.html?id=${item.id}`; 
                        }
                        
                        html += `
                            <a href="${link}" class="search-result-item">
                                <div style="font-weight:600; font-size:0.9rem; margin-bottom:4px;">${item.title || 'æ— æ ‡é¢˜'}</div>
                                <div class="result-meta">
                                    <span class="result-tag" style="color:${color}; background:${color}15;">${typeName}</span>
                                    <span>${item.publish_date || ''}</span>
                                </div>
                            </a>
                        `;
                    });
                    
                    dropdown.innerHTML = html;
                    
                } catch (error) {
                    dropdown.innerHTML = '<div style="padding:12px; color:#ef4444;">æœç´¢å¼‚å¸¸</div>';
                }
            }, 400);
        }
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­æœç´¢ä¸‹æ‹‰æ¡†
        document.addEventListener('click', (e) => {
            const searchComponent = document.querySelector('.search-component');
            const dropdown = document.getElementById('search-dropdown');
            
            if (searchComponent && dropdown && !searchComponent.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
    
        async function checkUserLogin() {
            try {
                const { data: { session }, error } = await _supabase.auth.getSession();
                if (error) throw error;
                
                const btn = document.getElementById('auth-btn');
                if (btn) {
                    if (session) {
                        const email = session.user.email || '';
                        btn.innerText = email.split('@')[0] || 'ç”¨æˆ·';
                        btn.onclick = () => location.href = 'profile.html';
                    }
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
            }
        }
    
        function toggleMenu() { 
            const navMenu = document.getElementById('navMenu');
            if (navMenu) {
                navMenu.classList.toggle('active');
            }
        }
    </script>
</body>
</html>